<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JokingMusic0.2.1beta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4cc9f0;
            --secondary-color: #3a0ca3;
            --dark-bg: #0f172a;
            --darker-bg: #0a0f1c;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --lyrics-highlight: rgba(76, 201, 240, 0.2);
        }
        
        /* 重置所有元素的默认margin和padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', 'Microsoft YaHei', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 确保html和body元素覆盖整个视口 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            padding-bottom: 140px; /* 为悬浮播放器留出空间 */
        }
        
        /* 确保body的背景覆盖整个视口，防止滚动时出现空白 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            z-index: -1;
            pointer-events: none;
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        /* 头部区域 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .header-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo-text h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 4px;
        }
        
        .logo-text p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .beta-badge {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 2px 12px rgba(102, 126, 234, 0.6);
            }
            100% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
        }
        
        /* 搜索区域 */
        .search-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            position: relative; /* 确保z-index有效 */
            z-index: 10; /* 低于平台下拉菜单 */
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title i {
            color: var(--primary-light);
        }
        
        .search-form {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            /* 移动端容器优化 */
            .container {
                padding: 15px;
                gap: 16px;
            }
            
            /* 移动端播放器优化 */
            .player-section {
                padding: 12px;
            }
            
            .floating-player {
                width: calc(100% - 30px);
                padding: 15px;
                bottom: 10px;
            }
            
            /* 移动端控制按钮优化 */
            .player-controls {
                gap: 8px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            /* 移动端歌曲列表优化 */
            .song-item {
                padding: 10px 12px;
            }
            
            .song-title {
                font-size: 14px;
            }
            
            .song-artist {
                font-size: 12px;
            }
            
            /* 移动端歌词面板优化 */
        .lyrics-panel {
            min-width: 200px;
            min-height: 150px;
            max-width: 90vw;
            max-height: 60vh;
        }
        
        /* 移动端透明度面板优化 */
        .opacity-panel {
            width: 280px;
            max-width: 90vw;
            padding: 15px;
        }
        
        .opacity-panel-title {
            font-size: 14px;
        }
        
        .opacity-label span {
            font-size: 13px;
        }
        
        /* 移动端音量控制优化 */
        .volume-control {
            max-width: 150px;
            gap: 8px;
        }
        
        .volume-slider {
            height: 3px;
        }
        }
        
        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        /* 平台选择器 - 重要：提高z-index确保在最上层 */
        .platform-selector {
            position: relative;
            z-index: 2000; /* 非常高以确保在最上层 */
        }
        
        .platform-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 2001; /* 高于下拉菜单触发器 */
        }
        
        .platform-toggle:hover {
            border-color: var(--primary-light);
        }
        
        .platform-toggle.active {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .platform-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .platform-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 平台下拉菜单 - 提高z-index确保在搜索结果界面上方 */
        .platform-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98); /* 增加透明度 */
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
            overflow: hidden;
            z-index: 9999; /* 设置为非常高的z-index，确保在所有内容之上 */
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9); /* 增加阴影 */
            backdrop-filter: blur(20px);
        }
        
        .platform-dropdown.active {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .platform-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 10000; /* 确保选项也在最上层 */
        }
        
        .platform-option:hover {
            background: rgba(67, 97, 238, 0.2);
        }
        
        .platform-option.active {
            background: rgba(67, 97, 238, 0.3);
            color: var(--primary-light);
        }
        
        .search-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .search-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
        }
        
        .search-btn:active {
            transform: translateY(0);
        }
        
        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .page-info {
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .page-number {
            font-weight: bold;
            color: var(--primary-light);
        }
        
        .pagination-buttons {
            display: flex;
            gap: 12px;
        }
        
        .page-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .page-btn:hover:not(:disabled) {
            background: rgba(67, 97, 238, 0.2);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* 搜索结果区域 - 确保z-index低于平台下拉菜单 */
        .results-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            min-height: 600px;
            position: relative;
            z-index: 5; /* 确保低于平台下拉菜单的z-index */
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-count {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .results-count span {
            color: var(--primary-light);
            font-weight: bold;
        }
        
        /* 新增：视图样式切换按钮 */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }
        
        .view-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .view-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .view-btn.active {
            background: rgba(67, 97, 238, 0.3);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            position: relative;
            z-index: 1; /* 确保内容在平台下拉菜单下方 */
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: rgba(148, 163, 184, 0.3);
        }
        
        /* 默认列表样式 */
        .song-list {
            list-style-type: none;
            position: relative;
            z-index: 1; /* 确保歌曲列表在平台下拉菜单下方 */
            margin-top: 20px; /* 增加与section-header的垂直间隔 */
        }
        
        .song-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
        }
        
        /* 网格样式 */
        .grid-view .song-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grid-view .song-item {
            flex-direction: column;
            align-items: flex-start;
            padding: 20px;
            height: 100%;
        }
        
        .grid-view .song-cover {
            width: 100%;
            aspect-ratio: 1/1; /* 正方形显示 */
            height: auto;
            margin-bottom: 15px;
        }
        
        .grid-view .song-info {
            width: 100%;
        }
        
        .grid-view .song-title {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .grid-view .song-artist {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .grid-view .song-album {
            font-size: 13px;
            margin-bottom: 15px;
        }
        
        .grid-view .song-actions {
            width: 100%;
            justify-content: center;
        }
        
        /* 紧凑列表样式 */
        .compact-view .song-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .compact-view .song-cover {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .compact-view .song-info {
            flex: 1;
            min-width: 0;
        }
        
        .compact-view .song-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .compact-view .song-artist,
        .compact-view .song-album,
        .compact-view .song-duration,
        .compact-view .song-platform,
        .compact-view .song-controls {
            display: none !important; /* 仅显示封面和标题 */
        }
        

        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .song-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .song-item.active {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15);
        }
        
        .song-cover {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .cover-placeholder {
            color: rgba(255, 255, 255, 0.2);
            font-size: 24px;
        }
        
        .song-info {
            flex: 1;
            min-width: 0;
        }
        
        .song-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-album {
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .song-actions {
            display: flex;
            gap: 10px;
        }
        
        .song-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .song-action-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        /* 悬浮播放器 */
        .floating-player {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 800px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .player-collapsed {
            padding: 15px;
        }
        
        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .player-info {
            flex: 1;
            min-width: 0;
        }
        
        .player-song-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-song-artist {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 新增：播放器歌词行 */
        .player-lyrics-line {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 20px;
            transition: all 0.3s;
            opacity: 0.8;
        }
        
        .player-lyrics-line.active {
            color: var(--primary-light);
            opacity: 1;
        }
        
        /* 底部进度条样式 */
        .bottom-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .bottom-progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 5px rgba(67, 97, 238, 0.3);
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .control-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .play-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: none;
            color: white;
        }
        
        .play-btn:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .toggle-player-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .toggle-player-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }
        
        .toggle-player-btn i {
            transition: transform 0.3s;
        }
        
        .toggle-player-btn.active i {
            transform: rotate(180deg);
        }
        
        .player-expanded {
            display: none;
        }
        
        .player-expanded.active {
            display: block;
        }
        
        .progress-section {
            margin-bottom: clamp(15px, 3vw, 20px);
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: clamp(8px, 2vw, 10px);
            font-size: clamp(12px, 2vw, 14px);
            color: var(--text-secondary);
        }
        
        .progress-container {
            position: relative;
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .progress-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            width: 0%;
        }
        
        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .progress-container:hover .progress-handle {
            opacity: 1;
        }
        
        .extra-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            gap: 15px;
        }
        
        .secondary-controls {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
        }
        
        .secondary-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .secondary-btn:hover {
            color: var(--primary-light);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .secondary-btn.active {
            color: var(--primary-light);
            background: rgba(67, 97, 238, 0.2);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 10px);
        }
        
        .volume-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        

        
        /* 透明度控制面板 */
        .opacity-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 999;
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .opacity-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .opacity-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-opacity-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-opacity-panel:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .opacity-control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .opacity-control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opacity-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .opacity-value {
            font-size: 12px;
            color: var(--primary-light);
            min-width: 30px;
            text-align: right;
        }
        
        .opacity-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            margin: 0;
        }
        
        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.5);
        }
        
        .opacity-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .opacity-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* 下载进度面板样式 */
        .download-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            max-width: 90vw;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .download-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .download-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-download-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-download-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        /* 公告面板样式 */
        .announcement-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-width: 90vw;
            max-height: 80vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .announcement-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .announcement-panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-announcement-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-announcement-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .announcement-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .announcement-item {
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .announcement-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .announcement-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .announcement-text ul {
            margin: 12px 0;
            padding-left: 20px;
        }
        
        .announcement-text li {
            margin-bottom: 6px;
        }
        
        .announcement-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .announcement-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .announcement-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .announcement-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .download-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .download-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .download-file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-all;
        }
        
        .download-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .download-progress-container {
            position: relative;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .download-progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(76, 201, 240, 0.4);
        }
        
        .download-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .download-percentage {
            font-weight: 500;
            color: var(--primary-light);
        }
        
        .download-controls {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
        }
        
        .download-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .download-btn.cancel {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .download-btn.cancel:hover {
            background: var(--error-color);
            color: white;
        }
        
        .download-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: none;
            color: white;
        }
        
        .download-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .player-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .player-placeholder i {
            font-size: 18px;
            color: var(--primary-light);
        }
        
        /* 歌词面板 - 修改：支持拖动 */
        .lyrics-panel {
            position: fixed;
            width: 300px;
            max-height: 400px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 999;
            display: none;
            flex-direction: column;
            cursor: default; /* 默认光标 */
            resize: both; /* 允许调整大小 */
            overflow: hidden; /* 隐藏溢出 */
            min-width: 250px;
            min-height: 200px;
        }
        
        .lyrics-panel.active {
            display: flex;
        }
        
        /* 拖动句柄样式 */
        .lyrics-drag-handle {
            cursor: move;
            user-select: none; /* 防止文本被选中 */
        }
        
        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            user-select: none;
        }
        
        .lyrics-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lyrics-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lyrics-control-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .lyrics-control-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }
        
        .lyrics-content {
            flex: 1;
            overflow-y: auto;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            text-align: center;
            padding: 10px;
            transition: all 0.3s;
        }
        
        /* 歌词行样式 */
        .lyrics-line {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: default;
            opacity: 0.7;
            transform: scale(0.95);
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lyrics-line.active {
            background: var(--lyrics-highlight);
            color: var(--primary-light);
            font-weight: 600;
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.2);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .lyrics-line.past {
            opacity: 0.9;
            color: var(--text-primary);
        }
        
        .lyrics-line.future {
            opacity: 0.6;
        }
        
        .lyrics-line:empty {
            display: none;
        }
        
        /* 歌词来源选择器 - 自定义下拉菜单 */
        .lyrics-source-selector {
            position: relative;
            margin: 0 clamp(4px, 1vw, 8px);
            width: auto;
            display: inline-block;
        }
        
        /* 下拉菜单触发器 */
        .lyrics-source-trigger {
            width: auto;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: clamp(5px, 1.5vw, 6px) clamp(10px, 2.5vw, 12px);
            border-radius: 8px;
            font-size: clamp(11px, 2vw, 12px);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            gap: 6px;
        }
        
        .lyrics-source-trigger:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-color);
        }
        
        .lyrics-source-trigger.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }
        
        /* 下拉菜单内容 */
        .lyrics-source-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: clamp(120px, 24vw, 150px);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: clamp(4px, 1vw, 6px);
            z-index: 3002;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* 播放速度选择器样式 */
        .playback-rate-selector {
            position: relative;
            margin: 0 clamp(4px, 1vw, 8px);
            display: inline-block;
        }
        
        /* 播放速度下拉菜单 */
        .playback-rate-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: clamp(90px, 18vw, 100px);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: clamp(4px, 1vw, 6px);
            z-index: 3002;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .playback-rate-dropdown.active {
            display: block;
        }
        
        /* 播放速度选项 */
        .playback-rate-option {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 3vw, 16px);
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(11px, 2vw, 12px);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .playback-rate-option:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
        }
        
        .playback-rate-option.active {
            background: rgba(67, 97, 238, 0.3);
            color: var(--primary-light);
            font-weight: 600;
        }
        
        .lyrics-source-dropdown.active {
            display: block;
        }
        
        /* 下拉菜单项 */
        .lyrics-source-item {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 3vw, 16px);
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(11px, 2vw, 12px);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .lyrics-source-item:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
        }
        
        .lyrics-source-item.active {
            background: rgba(67, 97, 238, 0.3);
            color: var(--primary-light);
        }
        
        .lyrics-source-item.loading {
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 加载动画 */
        .lyrics-loading-spinner {
            font-size: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 歌词透明度滑块样式 */
        #lyricsOpacitySlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(76, 201, 240, 0.3);
            transition: all 0.3s;
        }
        
        #lyricsOpacitySlider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(76, 201, 240, 0.3);
            border: none;
            transition: all 0.3s;
        }
        
        #lyricsOpacitySlider::-webkit-slider-thumb:hover,
        #lyricsOpacitySlider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(76, 201, 240, 0.5);
        }
        
        /* 佳欣歌词API配置区域 */
        .config-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
        }
        
        .config-panel.active {
            display: block;
        }
        
        .config-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .config-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }
        
        .config-btn {
            width: 100%;
            padding: 8px;
            background: rgba(67, 97, 238, 0.3);
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            color: var(--primary-light);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .config-btn:hover {
            background: rgba(67, 97, 238, 0.5);
        }
        
        .show-lyrics-btn {
            position: fixed;
            bottom: 180px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 998;
            display: none;
        }
        
        .show-lyrics-btn.active {
            display: flex;
        }
        
        .show-lyrics-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        /* 加载和状态指示器 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary-light);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .preload-info {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid rgba(76, 201, 240, 0.3);
            color: #a5f3fc;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }
        
        .preload-info.active {
            display: block;
        }
        
        .preload-progress {
            margin-top: 12px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .preload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 页脚 */
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* 响应式调整 - 已整合到新的全面响应式设计中 */
        
        /* 播放动画 */
        .playing-animation {
            display: inline-block;
            width: 16px;
            height: 16px;
            position: relative;
        }
        
        .playing-animation span {
            display: inline-block;
            width: 3px;
            height: 100%;
            background: var(--primary-light);
            margin-right: 1px;
            animation: audio-wave 1.2s infinite ease-in-out;
        }
        
        .playing-animation span:nth-child(1) {
            animation-delay: -0.8s;
        }
        
        .playing-animation span:nth-child(2) {
            animation-delay: -0.6s;
        }
        
        .playing-animation span:nth-child(3) {
            animation-delay: -0.4s;
        }
        
        .playing-animation span:nth-child(4) {
            animation-delay: -0.2s;
        }
        
        @keyframes audio-wave {
            0%, 40%, 100% {
                transform: scaleY(0.4);
            }
            20% {
                transform: scaleY(1);
            }
        }

        /* 播放动画 */
        .play-animation {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.6;
            }
        }
        
        /* 歌曲信息卡片 */
        .info-card {
            text-align: center;
            padding: 30px 40px;
        }
        

        
        /* 歌词卡片 */
        .lyrics-card {
            padding: 30px;
        }
        
        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .lyrics-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        

        
        /* 音量控制 - 嵌入播放器的滑动条 */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 200px;
        }
        
        .volume-slider-embedded {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 0 8px;
        }
        
        .volume-slider {
            width: 100%;
            height: 4px;
            margin: 0;
            cursor: pointer;
        }
        

        

        
        /* 音量数值显示 */
        .volume-slider-container::after {
            content: attr(data-volume);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: var(--primary-light);
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .volume-slider-container:hover::after {
            opacity: 1;
        }
        
        /* 进度条样式增强 */
        .progress-container {
            position: relative;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
        }
        
        .progress-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            width: 0%;
        }
        
        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .progress-container:hover .progress-handle {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        /* 时间显示 */
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        

        

        
        /* 悬浮播放器封面点击效果 */
        .player-cover {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-cover:hover {
            transform: scale(1.05);
        }
        
        /* 隐藏的音频元素 */
        .hidden-audio {
            display: none;
        }
        
        /* 歌曲加载状态 */
        .song-loading {
            opacity: 0.7;
        }
        
        .song-loaded .song-action-btn {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .song-loaded .song-action-btn:hover {
            background: rgba(67, 97, 238, 0.4);
        }
        
        /* 状态消息 */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .status-message.active {
            transform: translateX(0);
        }
        
        .status-message.success {
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .status-message.error {
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .status-message.info {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        /* ============================================
           响应式设计 - 全面屏幕和设备适配
           ============================================ */

        /* 超大屏幕适配 (1440px以上) */
        @media (min-width: 1440px) {
            .container {
                max-width: 1600px;
                padding: 30px;
            }
            
            .search-section,
            .results-section {
                padding: 40px;
            }
            
            .grid-view .song-list {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 30px;
            }
            
            .floating-player {
                max-width: 1000px;
                padding: 25px;
            }
            
            .player-header {
                gap: 25px;
            }
            
            .player-cover {
                width: 80px;
                height: 80px;
            }
            
            .player-song-title {
                font-size: 18px;
            }
            
            .player-song-artist {
                font-size: 16px;
            }
        }

        /* 大屏幕适配 (1200px-1439px) */
        @media (min-width: 1200px) and (max-width: 1439px) {
            .container {
                max-width: 1200px;
            }
            
            .grid-view .song-list {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 25px;
            }
        }

        /* 中等屏幕适配 (992px-1199px) */
        @media (min-width: 992px) and (max-width: 1199px) {
            .container {
                max-width: 1000px;
                padding: 25px;
            }
            
            .search-section,
            .results-section {
                padding: 25px;
            }
            
            .search-form {
                grid-template-columns: 1fr 2fr auto;
                gap: 15px;
            }
            
            .grid-view .song-list {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }
        }

        /* 平板设备适配 (768px-991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            body {
                padding-bottom: 150px;
            }
            
            .container {
                max-width: 800px;
                padding: 20px;
            }
            
            .header {
                flex-direction: row;
                align-items: center;
                gap: 20px;
            }
            
            .logo-text h1 {
                font-size: 24px;
            }
            
            .logo-text p {
                font-size: 13px;
            }
            
            .search-section,
            .results-section {
                padding: 25px;
                min-height: 550px;
            }
            
            .search-form {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .search-btn {
                grid-column: 1 / -1;
                justify-self: center;
                width: 200px;
            }
            
            .grid-view .song-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }
            
            .floating-player {
                width: calc(100% - 30px);
                max-width: 700px;
                padding: 20px;
            }
            
            .player-header {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .player-cover {
                order: 1;
            }
            
            .player-info {
                order: 2;
                flex: 1;
            }
            
            .player-controls {
                order: 3;
                width: auto;
                justify-content: center;
                margin-top: 0;
            }
            
            /* 平板端播放器展开区域优化 */
            .player-expanded {
                padding: 15px 0;
            }
            
            .extra-controls {
                flex-wrap: wrap;
                gap: 20px;
                justify-content: space-around;
            }
            
            .secondary-controls {
                gap: 12px;
            }
            
            .volume-control {
                max-width: 180px;
                gap: 12px;
            }
            
            .volume-slider {
                height: 5px;
            }
            
            .lyrics-panel {
                width: 350px;
                max-height: 350px;
            }
            
            .show-lyrics-btn {
                bottom: 190px;
                right: 25px;
            }
        }

        /* 小屏幕平板和大型手机 (576px-767px) */
        @media (min-width: 576px) and (max-width: 767px) {
            body {
                padding-bottom: 160px;
                font-size: 14px;
            }
            
            .container {
                padding: 15px;
                gap: 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 0;
            }
            
            .logo {
                gap: 10px;
            }
            
            .logo-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .logo-text h1 {
                font-size: 22px;
            }
            
            .logo-text p {
                font-size: 12px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }
            
            .search-section,
            .results-section {
                padding: 20px;
                border-radius: 15px;
                min-height: 500px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 15px;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
                padding-top: 15px;
            }
            
            .pagination-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .page-btn {
                flex: 1;
                max-width: 140px;
                justify-content: center;
            }
            
            .grid-view .song-list {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 12px;
            }
            
            .grid-view .song-item {
                padding: 15px;
            }
            
            .grid-view .song-cover {
                height: 150px;
                margin-bottom: 12px;
            }
            
            .grid-view .song-title {
                font-size: 15px;
            }
            
            .grid-view .song-artist {
                font-size: 13px;
            }
            
            .grid-view .song-album {
                font-size: 12px;
            }
            
            .song-item {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .song-cover {
                width: 60px;
                height: 60px;
            }
            
            .song-title {
                font-size: 16px;
            }
            
            .song-artist {
                font-size: 14px;
            }
            
            .song-album {
                font-size: 13px;
            }
            
            .song-action-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .floating-player {
                width: calc(100% - 20px);
                padding: 15px;
                bottom: 10px;
                border-radius: 12px;
            }
            
            .player-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .player-cover {
                width: 50px;
                height: 50px;
            }
            
            .player-info {
                text-align: center;
            }
            
            .player-song-title {
                font-size: 15px;
            }
            
            .player-song-artist {
                font-size: 13px;
            }
            
            .player-controls {
                width: 100%;
                justify-content: center;
            }
            
            .control-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .play-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            /* 小屏幕平板播放器展开区域优化 */
            .player-expanded {
                padding: 12px 0;
            }
            
            .extra-controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .secondary-controls {
                justify-content: center;
                gap: 10px;
            }
            
            .volume-control {
                max-width: 100%;
                gap: 10px;
                justify-content: center;
            }
            
            .volume-slider {
                height: 4px;
                max-width: 150px;
            }
            
            .lyrics-panel {
                width: calc(100% - 40px);
                max-height: 250px;
                right: 20px;
                bottom: 180px;
            }
            
            .show-lyrics-btn {
                bottom: 180px;
                right: 20px;
                width: 35px;
                height: 35px;
            }
            
            .lyrics-line {
                padding: 5px 8px;
                font-size: 12px;
                line-height: 1.6;
            }
            
            .player-lyrics-line {
                font-size: 11px;
                height: 16px;
            }
        }

        /* 小型手机 (480px-575px) */
        @media (max-width: 575px) {
            body {
                padding-bottom: 140px;
                font-size: 13px;
            }
            
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            .header {
                padding: 10px 0;
                gap: 12px;
            }
            
            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .logo-text h1 {
                font-size: 20px;
            }
            
            .logo-text p {
                font-size: 11px;
            }
            
            .header-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .search-section,
            .results-section {
                padding: 15px;
                border-radius: 12px;
                min-height: 450px;
            }
            
            .section-title {
                font-size: 16px;
                gap: 8px;
            }
            
            .search-form {
                gap: 12px;
            }
            
            .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .platform-toggle,
            .search-input {
                padding: 12px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .grid-view .song-list {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .grid-view .song-item {
                padding: 12px;
            }
            
            .grid-view .song-cover {
                height: 120px;
                margin-bottom: 10px;
            }
            
            .song-item {
                padding: 12px;
                margin-bottom: 10px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .song-cover {
                width: 80px;
                height: 80px;
            }
            
            .song-info {
                width: 100%;
            }
            
            .song-title {
                font-size: 15px;
                margin-bottom: 4px;
            }
            
            .song-artist {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .song-album {
                font-size: 12px;
            }
            
            .song-actions {
                width: 100%;
                justify-content: center;
            }
            
            .song-action-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .floating-player {
                width: calc(100% - 10px);
                padding: 12px;
                bottom: 5px;
                border-radius: 10px;
            }
            
            .player-header {
                gap: 10px;
            }
            
            .player-cover {
                width: 45px;
                height: 45px;
            }
            
            .player-song-title {
                font-size: 14px;
            }
            
            .player-song-artist {
                font-size: 12px;
            }
            
            .control-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .play-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            /* 小型手机播放器展开区域优化 */
            .player-expanded {
                padding: 10px 0;
            }
            
            .extra-controls {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .secondary-controls {
                justify-content: center;
                gap: 8px;
            }
            
            .volume-control {
                max-width: 100%;
                gap: 8px;
                justify-content: center;
            }
            
            .volume-slider {
                height: 3px;
                max-width: 120px;
            }
            
            .lyrics-panel {
                width: calc(100% - 30px);
                max-height: 200px;
                right: 15px;
                bottom: 160px;
                padding: 15px;
            }
            
            .show-lyrics-btn {
                bottom: 160px;
                right: 15px;
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .lyrics-line {
                padding: 4px 6px;
                font-size: 11px;
                line-height: 1.5;
            }
            
            .player-lyrics-line {
                font-size: 10px;
                height: 14px;
            }
        }

        /* 超小型手机 (320px-479px) */
        @media (max-width: 479px) {
            body {
                padding-bottom: 130px;
                font-size: 12px;
            }
            
            .container {
                padding: 8px;
                gap: 12px;
            }
            
            .header {
                padding: 8px 0;
                gap: 10px;
            }
            
            .logo-text h1 {
                font-size: 18px;
            }
            
            .logo-text p {
                font-size: 10px;
            }
            
            .search-section,
            .results-section {
                padding: 12px;
                min-height: 400px;
            }
            
            .section-title {
                font-size: 15px;
            }
            
            .platform-toggle,
            .search-input {
                padding: 10px;
                font-size: 13px;
            }
            
            .search-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .page-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .song-item {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .song-cover {
                width: 70px;
                height: 70px;
            }
            
            .song-title {
                font-size: 14px;
            }
            
            .song-artist {
                font-size: 12px;
            }
            
            .song-album {
                font-size: 11px;
            }
            
            .floating-player {
                padding: 10px;
            }
            
            .player-cover {
                width: 40px;
                height: 40px;
            }
            
            .player-song-title {
                font-size: 13px;
            }
            
            .player-song-artist {
                font-size: 11px;
            }
            
            .control-btn {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .play-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .lyrics-panel {
                width: calc(100% - 20px);
                max-height: 180px;
                right: 10px;
                bottom: 150px;
                padding: 12px;
            }
            
            .show-lyrics-btn {
                bottom: 150px;
                right: 10px;
                width: 30px;
                height: 30px;
                font-size: 13px;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .song-item:hover {
                transform: none;
                box-shadow: none;
            }
            
            .song-action-btn:hover,
            .header-btn:hover,
            .page-btn:hover,
            .control-btn:hover,
            .view-btn:hover {
                background: rgba(255, 255, 255, 0.05);
                transform: none;
            }
            
            .progress-handle {
                opacity: 1;
                width: 20px;
                height: 20px;
            }
            
            .song-item {
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }
            
            .song-action-btn,
            .header-btn,
            .page-btn,
            .control-btn {
                -webkit-tap-highlight-color: rgba(67, 97, 238, 0.2);
            }
            
            /* 增加触摸目标的最小尺寸 */
            .song-action-btn,
            .header-btn,
            .control-btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            .page-btn {
                min-height: 44px;
            }
            
            /* 优化滚动体验 */
            .results-container {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
            
            .lyrics-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* 竖屏设备特定优化 */
        @media (orientation: portrait) {
            /* 调整容器内边距 */
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            /* 调整搜索区域 */
            .search-section {
                padding: 15px;
            }
            
            /* 调整结果区域 */
            .results-section {
                padding: 15px;
                min-height: 50vh;
            }
            
            /* 调整悬浮播放器 */
            .floating-player {
                width: calc(100% - 20px);
                padding: 15px;
                bottom: 10px;
                max-height: 40vh;
                overflow-y: auto;
            }
            
            /* 调整播放器头部 */
            .player-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            /* 调整播放器信息 */
            .player-info {
                text-align: center;
                width: 100%;
            }
            
            /* 调整播放器控制器 */
            .player-controls {
                width: 100%;
                justify-content: center;
            }
            
            /* 调整歌词面板位置 */
            .lyrics-panel {
                width: calc(100% - 30px);
                max-height: 30vh;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                bottom: auto;
                right: auto;
            }
            
            /* 调整显示歌词按钮位置 */
            .show-lyrics-btn {
                bottom: 170px;
                right: 20px;
            }
            
            /* 调整网格视图 */
            .grid-view .song-list {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* 调整歌曲项 */
            .song-item {
                padding: 15px;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            /* 调整歌曲封面 */
            .song-cover {
                width: 100px;
                height: 100px;
                margin-bottom: 10px;
            }
            
            /* 调整歌曲信息 */
            .song-info {
                width: 100%;
            }
            
            /* 调整歌曲操作按钮 */
            .song-actions {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            /* 调整搜索表单 */
            .search-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* 调整搜索按钮 */
            .search-btn {
                width: 100%;
                justify-content: center;
            }
            
            /* 调整分页控件 */
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            /* 调整分页按钮 */
            .pagination-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            /* 调整头部 */
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 10px 0;
            }
            
            /* 调整头部控制按钮 */
            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }
            
            /* 调整结果头部 */
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* 调整视图切换按钮 */
            .view-toggle {
                margin-left: 0;
            }
            
            /* 调整下载面板 */
            .download-panel {
                width: calc(100% - 30px);
                max-width: 90vw;
                padding: 15px;
            }
            
            /* 调整公告面板 */
            .announcement-panel {
                width: calc(100% - 30px);
                max-width: 90vw;
                padding: 15px;
            }
        }

        /* 高DPI屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .logo-icon,
            .song-cover,
            .player-cover {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            .progress-bar,
            .progress-buffer {
                border-radius: 2px;
            }
        }

        /* 横屏模式优化 */
        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding-bottom: 120px;
            }
            
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            .search-section,
            .results-section {
                padding: 15px;
                min-height: 300px;
            }
            
            .floating-player {
                padding: 10px;
                bottom: 5px;
            }
            
            .player-header {
                flex-direction: row;
                align-items: center;
            }
            
            .player-controls {
                width: auto;
                margin-top: 0;
            }
            
            .lyrics-panel {
                max-height: 150px;
                bottom: 130px;
            }
            
            .show-lyrics-btn {
                bottom: 130px;
            }
        }

        /* 打印样式优化 */
        @media print {
            .floating-player,
            .lyrics-panel,
            .show-lyrics-btn,
            .header-controls {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
                padding-bottom: 0 !important;
            }
            
            .search-section,
            .results-section {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }

        /* 设备特定优化样式 */
        .touch-device .control-btn,
        .touch-device .song-item {
            min-height: 44px !important;
            min-width: 44px !important;
        }
        
        .mobile-device .floating-player {
            position: fixed;
            z-index: 1000;
        }
        
        .tablet-device .grid-view .song-list {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        
        .high-dpi .song-cover,
        .high-dpi .player-cover {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* 移动设备布局优化 */
        .mobile-layout .header {
            flex-direction: column;
            gap: 15px;
        }
        
        .mobile-layout .search-form {
            grid-template-columns: 1fr;
        }
        
        /* 平板设备布局优化 */
        .tablet-layout .grid-view .song-list {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        
        /* 桌面设备布局优化 */
        .desktop-layout .grid-view .song-list {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }
        
        /* 防止移动设备上的文本缩放 */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important; /* 防止iOS缩放 */
            }
        }
        
        /* 移动设备上的滚动优化 */
        @media (hover: none) and (pointer: coarse) {
            html {
                -webkit-overflow-scrolling: touch;
            }
            
            .song-list {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
        }
        
        /* 防止移动设备上的300ms点击延迟 */
        @media (pointer: coarse) {
            a, button {
                touch-action: manipulation;
            }
        }
        
        /* 移动设备上的状态栏适配 */
        @media (max-width: 768px) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(env(safe-area-inset-bottom) + 140px);
            }
            
            .floating-player {
                bottom: calc(10px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部区域 -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-music"></i>
                </div>
                <div class="logo-text">
                    <h1>JokingMusic 0.2.1<span class="beta-badge">Beta</span></h1>
                    <p>更好的音乐搜索与播放体验</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="header-btn" id="announcementBtn" title="公告">
                    <i class="fas fa-bullhorn"></i>
                </button>
                <button class="header-btn" id="settingsBtn" title="设置">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="header-btn" id="accountBtn" title="账号">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
        
        <!-- 搜索区域 -->
        <div class="search-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-search"></i> 搜索音乐
                </h2>
                <div class="page-info">
                    第 <span id="currentPage" class="page-number">1</span> 页
                </div>
            </div>
            
            <div class="search-form">
                <div class="form-group platform-selector">
                    <div class="form-label"><i class="fas fa-music"></i> 音乐平台</div>
                    <div class="platform-toggle" id="platformToggle">
                        <div class="platform-name">
                            <div class="platform-icon">
                                <i class="fab fa-napster"></i>
                            </div>
                            <span>网易云音乐</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="platform-dropdown" id="platformDropdown">
                        <div class="platform-option active" data-value="wy">
                            <i class="fab fa-napster"></i>
                            <span>网易云音乐</span>
                        </div>
                        <div class="platform-option" data-value="qq">
                            <i class="fab fa-qq"></i>
                            <span>QQ音乐</span>
                        </div>
                        <div class="platform-option" data-value="kw">
                            <i class="fas fa-headphones"></i>
                            <span>酷我音乐</span>
                        </div>
                        <div class="platform-option" data-value="mg">
                            <i class="fas fa-mobile-alt"></i>
                            <span>咪咕音乐</span>
                        </div>
                        <div class="platform-option" data-value="qi">
                            <i class="fas fa-play-circle"></i>
                            <span>千千音乐</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-label"><i class="fas fa-headphones-alt"></i> 歌曲名称或歌手</div>
                    <input type="text" class="search-input" id="songName" placeholder="输入歌曲名或歌手名...">
                </div>
                
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i> 搜索音乐
                </button>
            </div>
            
            <div class="pagination-controls">
                <div class="pagination-buttons">
                    <button class="page-btn" id="prevPageBtn" disabled>
                        <i class="fas fa-chevron-left"></i> 上一页
                    </button>
                    <button class="page-btn" id="nextPageBtn" disabled>
                        下一页 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="loading-text">正在搜索音乐，请稍候...</p>
            </div>
            
            <div class="preload-info" id="preloadInfo">
                <p><i class="fas fa-sync-alt"></i> 正在加载歌曲信息...</p>
                <div class="preload-progress">
                    <div class="preload-progress-bar" id="preloadProgressBar"></div>
                </div>
                <p id="preloadStatus" style="margin-top: 8px; font-size: 0.9rem;">0/0 已加载</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
        </div>
        
        <!-- 搜索结果区域 -->
        <div class="results-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> 搜索结果
                </h2>
                <div class="results-count" style="display: flex; align-items: center;">
                    <span>已加载 <span id="loadedSongCount">0</span> 首歌曲</span>
                    <!-- 新增：视图样式切换按钮 -->
                    <div class="view-toggle" id="viewToggle">
                        <button class="view-btn active" data-view="list" title="列表视图">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="view-btn" data-view="grid" title="网格视图">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" data-view="compact" title="紧凑视图">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="results-container">
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-music"></i>
                    <h3>搜索结果显示在这里</h3>
                    <p>输入关键词并点击搜索按钮开始搜索</p>
                </div>
                
                <ul class="song-list" id="songList">
                    <!-- 歌曲列表将动态插入 -->
                </ul>
            </div>
        </div>
        
    </div>
    
    <!-- 悬浮播放器 -->
    <div class="floating-player" id="floatingPlayer">
        <div class="player-header">
            <div class="player-cover">
                <div class="cover-placeholder">
                    <i class="fas fa-music"></i>
                </div>
                <img id="playerAlbumArt" src="" alt="专辑封面">
            </div>
            
            <div class="player-info">
                <div class="player-song-title" id="playerTitle">未选择歌曲</div>
                <div class="player-song-artist" id="playerArtist">--</div>
                <!-- 新增：播放器歌词行 -->
                <div class="player-lyrics-line" id="playerLyricsLine"></div>
                
                <!-- 底部进度条 -->
                <div class="bottom-progress-container" id="bottomProgressContainer">
                    <div class="bottom-progress-bar" id="bottomProgressBar"></div>
                </div>
            </div>
            
            <div class="player-controls">
                <button class="control-btn" id="prevBtn" title="上一曲">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-btn" id="playPauseBtn" title="播放/暂停">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn" title="下一曲">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="toggle-player-btn" id="togglePlayerBtn" title="展开/收起">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        
        <div class="player-expanded" id="playerExpanded">
            <div class="progress-section">
                <div class="time-display">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-buffer" id="progressBuffer"></div>
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                </div>
            </div>
            
            <div class="extra-controls">
                <div class="secondary-controls">
                    <button class="secondary-btn" id="playModeBtn" title="播放模式">
                        <i class="fas fa-retweet"></i>
                    </button>
                    <!-- 播放速度选择器 - 菜单式 -->
                    <div class="playback-rate-selector" id="playbackRateSelector">
                        <button class="secondary-btn playback-rate-trigger" id="playbackRateBtn" title="播放速度">
                            <span id="playbackRateText">1x</span>
                            <i class="fas fa-chevron-up" style="font-size: 10px; margin-left: 5px;"></i>
                        </button>
                        <div class="playback-rate-dropdown" id="playbackRateDropdown">
                            <!-- 播放速度选项将动态添加 -->
                        </div>
                    </div>
                    <!-- 歌词来源选择器 -->
                    <div class="lyrics-source-selector" id="lyricsSourceSelector">
                        <div class="lyrics-source-trigger" id="lyricsSourceTrigger">
                            <span id="lyricsSourceText" style="font-size: 12px;">选择歌词源</span>
                            <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                        </div>
                        <div class="lyrics-source-dropdown" id="lyricsSourceDropdown">
                            <!-- 歌词源选项将动态添加 -->
                        </div>
                    </div>
                    
                    <button class="secondary-btn" id="downloadBtn" title="下载歌曲">
                        <i class="fas fa-download"></i>
                    </button>
                    
                    <button class="opacity-btn" id="opacityBtn" title="透明度">
                        <i class="fas fa-adjust"></i>
                    </button>
                </div>
                
                <div class="volume-control">
                    <button class="volume-btn" id="volumeBtn" title="音量">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="volume-slider-embedded">
                        <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
                    </div>
                </div>
                
                <!-- 透明度控制面板 -->
                <div class="opacity-panel" id="opacityPanel">
                    <div class="opacity-panel-header">
                        <div class="opacity-panel-title">透明度设置</div>
                        <button class="close-opacity-panel" id="closeOpacityPanel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="opacity-control-group">
                        <div class="opacity-control-item">
                            <div class="opacity-label">
                                <span>播放器透明度</span>
                                <span class="opacity-value" id="playerOpacityValue">100%</span>
                            </div>
                            <input type="range" min="20" max="100" value="100" class="opacity-slider" id="playerOpacitySlider">
                        </div>
                        <div class="opacity-control-item">
                            <div class="opacity-label">
                                <span>文本透明度</span>
                                <span class="opacity-value" id="textOpacityValue">100%</span>
                            </div>
                            <input type="range" min="20" max="100" value="100" class="opacity-slider" id="textOpacitySlider">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 下载进度面板 -->
    <div class="download-panel" id="downloadPanel">
        <div class="download-panel-header">
            <div class="download-panel-title">下载进度</div>
            <button class="close-download-panel" id="closeDownloadPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="download-content">
            <div class="download-info">
                <div class="download-file-name" id="downloadFileName">准备下载...</div>
                <div class="download-status" id="downloadStatus">等待中</div>
            </div>
            <div class="download-progress-container">
                <div class="download-progress-bar" id="downloadProgressBar"></div>
            </div>
            <div class="download-stats">
                <span class="download-percentage" id="downloadPercentage">0%</span>
                <span class="download-speed" id="downloadSpeed">0 KB/s</span>
                <span class="download-size" id="downloadSize">0 MB / 0 MB</span>
            </div>
            <div class="download-controls">
                <button class="download-btn cancel" id="cancelDownloadBtn">取消下载</button>
            </div>
        </div>
    </div>

    <!-- 公告面板 -->
    <div class="announcement-panel" id="announcementPanel">
        <div class="announcement-panel-header">
            <div class="announcement-panel-title">最新公告</div>
            <button class="close-announcement-panel" id="closeAnnouncementPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="announcement-content">
            <div class="announcement-item">
                <div class="announcement-date">2026-01-31</div>
                <div class="announcement-title">JokingMusic 0.2.1 Beta 版本更新</div>
                <div class="announcement-text">
                    本次更新内容：
                    <ul>
                        <li>优化下载功能</li>
                        <li>提高了搜索速度和稳定性</li>
                        <li>增加了公告功能</li>
                    </ul>
                </div>
            </div>
            <div class="announcement-item">
                <div class="announcement-date">2026-01-09</div>
                <div class="announcement-title">JokingMusic 0.2 Beta 版本发布</div>
                <div class="announcement-text">
                    欢迎使用 JokingMusic 0.2 Beta 版本！
                    <br><br>
                    <strong>本次更新亮点：</strong>
                    <ul>
                        <li>全新播放器 UI：更现代、更沉浸手</li>
                        <li>API 调用深度优化：搜索更快、结果更准</li>
                    </ul>
                    <br>
                    感谢一路有你，继续听歌，继续快乐！🎧
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- 歌词面板 - 修改：支持拖动 -->
    <div class="lyrics-panel" id="lyricsPanel" style="display: none;">
        <div class="lyrics-header" id="lyricsDragHandle">
            <div class="lyrics-title">
                <i class="fas fa-file-alt"></i> 歌词
                <span id="lyricsSourceBadge" style="font-size: 12px; opacity: 0.7; margin-left: 5px;"></span>
            </div>
            <div class="lyrics-controls">
                <!-- 佳欣歌词API配置区域 -->
                <div class="config-panel" id="jiaxinConfigPanel">
                    <div class="config-title">
                        <i class="fas fa-key"></i> 佳欣歌词API Key
                    </div>
                    <input type="text" class="config-input" id="jiaxinApiKey" placeholder="输入API Key，如：9024401e275f939d">
                    <button class="config-btn" id="saveJiaxinKeyBtn">保存</button>
                </div>
                <!-- 歌词透明度调节 - 改为按钮触发 -->
                <div style="position: relative; margin: 0 10px;">
                    <button class="lyrics-control-btn" id="toggleOpacityBtn" title="调整透明度">
                        <i class="fas fa-opacity"></i>
                    </button>
                    <!-- 透明度滑块容器，初始隐藏 -->
                    <div id="opacitySliderContainer" style="position: absolute; top: 100%; right: 0; margin-top: 5px; display: none; background: rgba(15, 23, 42, 0.95); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); z-index: 1001;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-opacity" style="font-size: 12px; color: var(--text-secondary);"></i>
                            <input type="range" id="lyricsOpacitySlider" min="30" max="100" value="95" style="width: 100px; height: 4px; -webkit-appearance: none; appearance: none; background: rgba(255, 255, 255, 0.1); border-radius: 2px; outline: none;" title="调整透明度">
                            <span id="opacityValue" style="font-size: 12px; color: var(--text-secondary); min-width: 30px; text-align: right;">95%</span>
                        </div>
                    </div>
                </div>
                <button class="lyrics-control-btn" id="closeLyricsBtn" title="关闭歌词面板">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="lyrics-content" id="playerLyrics">
            歌词将在此显示...
        </div>
    </div>
    
    <!-- 显示歌词按钮 -->
    <button class="show-lyrics-btn" id="showLyricsBtn" title="显示歌词" style="display: none;">
        <i class="fas fa-file-alt"></i>
    </button>
    
    <!-- 状态消息 -->
    <div class="status-message" id="statusMessage">
        <i class="fas fa-info-circle"></i>
        <span id="statusText">消息内容</span>
    </div>

    <!-- 隐藏的音频元素 -->
    <div class="hidden-audio">
        <audio id="audioPlayer"></audio>
    </div>

    <script>
        // 设备检测和响应式优化
        const deviceInfo = {
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            isTablet: /iPad|Android(?!.*Mobile)|Tablet/i.test(navigator.userAgent),
            isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            screenWidth: window.innerWidth,
            screenHeight: window.innerHeight,
            pixelRatio: window.devicePixelRatio || 1,
            isPortrait: window.innerHeight > window.innerWidth
        };
        
        // 应用设备特定的优化
        function applyDeviceOptimizations() {
            // 为触摸设备优化交互
            if (deviceInfo.isTouchDevice) {
                document.body.classList.add('touch-device');
                
                // 增加触摸目标大小
                const touchElements = document.querySelectorAll('button, .song-item, .control-btn');
                touchElements.forEach(el => {
                    el.style.minHeight = '44px';
                    el.style.minWidth = '44px';
                });
            }
            
            // 为移动设备优化
            if (deviceInfo.isMobile) {
                document.body.classList.add('mobile-device');
                
                // 禁用某些移动设备上的hover效果
                const style = document.createElement('style');
                style.textContent = `
                    @media (hover: none) {
                        .song-item:hover, .control-btn:hover {
                            transform: none !important;
                            box-shadow: none !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 为平板设备优化
            if (deviceInfo.isTablet) {
                document.body.classList.add('tablet-device');
            }
            
            // 为高DPI屏幕优化
            if (deviceInfo.pixelRatio >= 2) {
                document.body.classList.add('high-dpi');
            }
        }
        
        // 屏幕尺寸变化监听
        function handleResize() {
            deviceInfo.screenWidth = window.innerWidth;
            deviceInfo.screenHeight = window.innerHeight;
            deviceInfo.isPortrait = window.innerHeight > window.innerWidth;
            
            // 根据屏幕尺寸调整布局
            if (deviceInfo.screenWidth <= 768) {
                document.body.classList.add('mobile-layout');
                document.body.classList.remove('tablet-layout', 'desktop-layout');
            } else if (deviceInfo.screenWidth <= 1024) {
                document.body.classList.add('tablet-layout');
                document.body.classList.remove('mobile-layout', 'desktop-layout');
            } else {
                document.body.classList.add('desktop-layout');
                document.body.classList.remove('mobile-layout', 'tablet-layout');
            }
            
            // 根据屏幕方向调整布局
            if (deviceInfo.isPortrait) {
                document.body.classList.add('portrait-device');
                document.body.classList.remove('landscape-device');
                
                // 调整歌词面板位置
                if (lyricsPanel) {
                    lyricsPanel.style.top = '10px';
                    lyricsPanel.style.left = '50%';
                    lyricsPanel.style.transform = 'translateX(-50%)';
                    lyricsPanel.style.bottom = 'auto';
                    lyricsPanel.style.right = 'auto';
                    lyricsPanel.style.width = 'calc(100% - 30px)';
                    lyricsPanel.style.maxHeight = '30vh';
                }
                
                // 调整显示歌词按钮位置
                if (showLyricsBtn) {
                    showLyricsBtn.style.bottom = '170px';
                    showLyricsBtn.style.right = '20px';
                }
            } else {
                document.body.classList.add('landscape-device');
                document.body.classList.remove('portrait-device');
                
                // 恢复歌词面板默认位置
                if (lyricsPanel) {
                    lyricsPanel.style.top = '50%';
                    lyricsPanel.style.left = '50%';
                    lyricsPanel.style.transform = 'translate(-50%, -50%)';
                    lyricsPanel.style.width = '300px';
                    lyricsPanel.style.maxHeight = '400px';
                }
                
                // 恢复显示歌词按钮默认位置
                if (showLyricsBtn) {
                    showLyricsBtn.style.bottom = '180px';
                    showLyricsBtn.style.right = '20px';
                }
            }
        }
        
        // 初始化设备优化
        document.addEventListener('DOMContentLoaded', function() {
            applyDeviceOptimizations();
            handleResize();
            window.addEventListener('resize', handleResize);
        });
        
        // DOM元素
        const searchBtn = document.getElementById('searchBtn');
        const songNameInput = document.getElementById('songName');
        const platformToggle = document.getElementById('platformToggle');
        const platformDropdown = document.getElementById('platformDropdown');
        const platformOptions = document.querySelectorAll('.platform-option');
        const currentPageElement = document.getElementById('currentPage');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const loadingElement = document.getElementById('loading');
        const preloadInfo = document.getElementById('preloadInfo');
        const preloadProgressBar = document.getElementById('preloadProgressBar');
        const preloadStatus = document.getElementById('preloadStatus');
        const errorMessageElement = document.getElementById('errorMessage');
        const emptyStateElement = document.getElementById('emptyState');
        const loadedSongCountElement = document.getElementById('loadedSongCount');
        const songListElement = document.getElementById('songList');
        
        // 新增：视图切换按钮
        const viewToggle = document.getElementById('viewToggle');
        const viewButtons = document.querySelectorAll('.view-btn');
        
        // 播放器相关元素
        const floatingPlayer = document.getElementById('floatingPlayer');
        const playerTitle = document.getElementById('playerTitle');
        const playerArtist = document.getElementById('playerArtist');
        const playerAlbumArt = document.getElementById('playerAlbumArt');
        const playerLyricsLine = document.getElementById('playerLyricsLine');
        const audioPlayer = document.getElementById('audioPlayer');
        const playerLyrics = document.getElementById('playerLyrics');
        
        // 歌词面板相关元素
        const lyricsPanel = document.getElementById('lyricsPanel');
        const lyricsDragHandle = document.getElementById('lyricsDragHandle');
        const lyricsSourceSelector = document.getElementById('lyricsSourceSelector');
        const lyricsSourceTrigger = document.getElementById('lyricsSourceTrigger');
        const lyricsSourceText = document.getElementById('lyricsSourceText');
        const lyricsSourceDropdown = document.getElementById('lyricsSourceDropdown');
        const lyricsSourceBadge = document.getElementById('lyricsSourceBadge');
        
        // 佳欣歌词API配置元素
        const jiaxinConfigPanel = document.getElementById('jiaxinConfigPanel');
        const jiaxinApiKeyInput = document.getElementById('jiaxinApiKey');
        const saveJiaxinKeyBtn = document.getElementById('saveJiaxinKeyBtn');
        
        // 歌词透明度调节元素
        const lyricsOpacitySlider = document.getElementById('lyricsOpacitySlider');
        const toggleOpacityBtn = document.getElementById('toggleOpacityBtn');
        const opacitySliderContainer = document.getElementById('opacitySliderContainer');
        const opacityValue = document.getElementById('opacityValue');
        
        // 自定义播放控制器元素
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const totalTimeElement = document.getElementById('totalTime');
        const progressBar = document.getElementById('progressBar');
        const progressBuffer = document.getElementById('progressBuffer');
        const progressHandle = document.getElementById('progressHandle');
        const progressContainer = document.getElementById('progressContainer');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const opacityBtn = document.getElementById('opacityBtn');
        const playModeBtn = document.getElementById('playModeBtn');
        const playbackRateBtn = document.getElementById('playbackRateBtn');
        const togglePlayerBtn = document.getElementById('togglePlayerBtn');
        const playerExpanded = document.getElementById('playerExpanded');
        const lyricsBtn = document.getElementById('lyricsBtn');
        const closeLyricsBtn = document.getElementById('closeLyricsBtn');
        const showLyricsBtn = document.getElementById('showLyricsBtn');
        
        // 全屏音乐显示元素

        
        // 状态消息元素
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        // 应用状态
        let currentSongId = null;
        let currentPlatform = 'wy';
        let songDetailsCache = {};
        let currentSearchResults = [];
        let currentPage = 1;
        let hasNextPage = false;
        let loadedSongsCount = 0;
        let totalSongsCount = 0;
        let isPlayerExpanded = false;
        let isLyricsVisible = false;
        let currentView = 'list'; // 当前视图样式
        
        // 歌词面板拖动状态
        let isLyricsDragging = false;
        let lyricsDragStartX = 0;
        let lyricsDragStartY = 0;
        let lyricsPanelStartX = 0;
        let lyricsPanelStartY = 0;
        
        // 歌词相关状态
        let lyricsData = []; // 解析后的歌词数据
        let currentLyricIndex = -1; // 当前高亮的歌词索引
        let lyricsScrollInterval = null; // 歌词滚动定时器
        let currentLyricsSource = 'original'; // 当前歌词来源
        let availableLyricsSources = []; // 可用的歌词源列表
        
        // 佳欣歌词API状态
        let jiaxinApiKey = localStorage.getItem('jiaxin_api_key') || '9024401e275f939d'; // 默认使用示例中的Key
        let currentSongInfo = null; // 当前歌曲信息，用于佳欣歌词搜索
        
        // 播放器状态
        let isPlaying = false;
        let isSeeking = false;
        let currentVolume = 1.0; // 默认音量最大
        let playbackRates = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
        let currentPlaybackRateIndex = 2;
        let currentPlaybackRate = playbackRates[currentPlaybackRateIndex]; // 当前播放速度
        let playModes = ['order', 'loop', 'random'];
        let currentPlayModeIndex = 0;
        
        // 平台名称映射
        const platformNames = {
            'wy': '网易云音乐',
            'qq': 'QQ音乐',
            'kw': '酷我音乐',
            'mg': '咪咕音乐',
            'qi': '千千音乐'
        };
        
        // 平台图标映射
        const platformIcons = {
            'wy': 'fab fa-napster',
            'qq': 'fab fa-qq',
            'kw': 'fas fa-headphones',
            'mg': 'fas fa-mobile-alt',
            'qi': 'fas fa-play-circle'
        };
        
        // 歌词源映射
        const lyricsSourceNames = {
            'original': '原始歌词',
            'wy': '网易云',
            'qq': 'QQ音乐',
            'kw': '酷我音乐',
            'qi': '千千音乐',
            'jx-netease': '佳欣歌词(网易)',
            'jx-tencent': '佳欣歌词(腾讯)'
        };
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化透明度设置
            initOpacitySettings();
            
            // 平台选择器事件
            platformToggle.addEventListener('click', function() {
                platformDropdown.classList.toggle('active');
                platformToggle.classList.toggle('active');
            });
            
            // 平台选项点击事件
            platformOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const text = this.querySelector('span').textContent;
                    const iconClass = this.querySelector('i').className;
                    
                    // 更新选中的平台
                    updateSelectedPlatform(value, text, iconClass);
                    
                    // 关闭下拉菜单
                    platformDropdown.classList.remove('active');
                    platformToggle.classList.remove('active');
                });
            });
            
            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function(event) {
                if (!platformToggle.contains(event.target) && !platformDropdown.contains(event.target)) {
                    platformDropdown.classList.remove('active');
                    platformToggle.classList.remove('active');
                }
            });
            
            // 视图切换按钮事件
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const view = this.dataset.view;
                    switchView(view);
                });
            });
            
            // 搜索按钮事件
            searchBtn.addEventListener('click', performSearch);
            
            // 输入框回车事件
            songNameInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });
            
            // 分页按钮事件
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            
            // 佳欣歌词API配置事件
            saveJiaxinKeyBtn.addEventListener('click', saveJiaxinApiKey);
            
            // 播放器控制事件
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrevSong);
            nextBtn.addEventListener('click', playNextSong);
            playModeBtn.addEventListener('click', togglePlayMode);
            volumeBtn.addEventListener('click', toggleMute);
            opacityBtn.addEventListener('click', toggleOpacityPanel);
            togglePlayerBtn.addEventListener('click', togglePlayerExpanded);
            closeLyricsBtn.addEventListener('click', closeLyricsPanel);
            
            // 下载按钮事件
            downloadBtn.addEventListener('click', downloadSong);
            
            // 透明度面板事件
            closeOpacityPanel.addEventListener('click', closeOpacityPanelFunc);
            playerOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                playerOpacityValue.textContent = value + '%';
                updatePlayerOpacity(value);
            });
            
            textOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                textOpacityValue.textContent = value + '%';
                updateTextOpacity(value);
            });
            
            // 点击面板外部关闭面板
            opacityPanel.addEventListener('click', function(e) {
                if (e.target === opacityPanel) {
                    closeOpacityPanelFunc();
                }
            });
            
            // 歌词源下拉菜单触发器点击事件
            lyricsSourceTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                lyricsSourceDropdown.classList.toggle('active');
                lyricsSourceTrigger.classList.toggle('active');
            });
            
            // 初始化播放速度菜单
            initPlaybackRateMenu();
            initDownloadPanel();
            initAnnouncementPanel();
            
            // 播放速度触发器点击事件
            playbackRateBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('playbackRateDropdown');
                dropdown.classList.toggle('active');
            });
            
            // 透明度调整按钮点击事件
            toggleOpacityBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                opacitySliderContainer.style.display = opacitySliderContainer.style.display === 'block' ? 'none' : 'block';
            });
            
            // 点击外部区域关闭下拉菜单和透明度滑块
            document.addEventListener('click', function(e) {
                // 关闭歌词源下拉菜单
                if (!lyricsSourceSelector.contains(e.target)) {
                    lyricsSourceDropdown.classList.remove('active');
                    lyricsSourceTrigger.classList.remove('active');
                }
                
                // 关闭播放速度下拉菜单
                if (!document.getElementById('playbackRateSelector').contains(e.target)) {
                    document.getElementById('playbackRateDropdown').classList.remove('active');
                }
                
                // 关闭透明度滑块
                if (!opacitySliderContainer.contains(e.target) && !toggleOpacityBtn.contains(e.target)) {
                    opacitySliderContainer.style.display = 'none';
                }
            });
            
            // 初始化全屏音乐功能

            
            // 音量滑块事件
            volumeSlider.addEventListener('input', function() {
                const volume = this.value / 100;
                audioPlayer.volume = volume;
                audioPlayer.muted = volume === 0;
                updateVolumeButton();
                
                // 更新音量数值显示
                const volumeContainer = document.querySelector('.volume-slider-container');
                if (volumeContainer) {
                    volumeContainer.setAttribute('data-volume', `${this.value}%`);
                }
            });
            
            // 歌词透明度滑块事件
            lyricsOpacitySlider.addEventListener('input', function() {
                const opacity = this.value / 100;
                updateLyricsPanelOpacity(opacity);
                // 更新透明度数值显示
                opacityValue.textContent = `${this.value}%`;
            });
            
            // 初始化歌词面板透明度
            updateLyricsPanelOpacity(lyricsOpacitySlider.value / 100);
            // 初始化透明度数值显示
            opacityValue.textContent = `${lyricsOpacitySlider.value}%`;
            
            // 进度条事件
            progressContainer.addEventListener('click', function(e) {
                if (!audioPlayer.duration || isNaN(audioPlayer.duration)) return;
                
                const rect = this.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newTime = percent * audioPlayer.duration;
                
                audioPlayer.currentTime = newTime;
                updatePlayerDisplay();
            });
            
            // 进度条拖动事件
            progressHandle.addEventListener('mousedown', startSeeking);
            progressContainer.addEventListener('mousedown', startSeeking);
            
            // 歌词面板拖动功能
            setupLyricsPanelDrag();
            
            // 音频元素事件监听
            audioPlayer.addEventListener('play', function() {
                isPlaying = true;
                updatePlayPauseButton();
                startLyricsHighlight();
                showStatusMessage('开始播放', 'success');
            });
            
            audioPlayer.addEventListener('pause', function() {
                isPlaying = false;
                updatePlayPauseButton();
                stopLyricsHighlight();
            });
            
            audioPlayer.addEventListener('timeupdate', function() {
                updatePlayerDisplay();
                updateLyricsHighlight();
                updatePlayerLyricsLine();
            });
            
            audioPlayer.addEventListener('loadedmetadata', function() {
                updatePlayerDisplay();
            });
            
            audioPlayer.addEventListener('ended', function() {
                if (playModes[currentPlayModeIndex] === 'loop') {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                } else {
                    playNextSong();
                }
            });
            
            audioPlayer.addEventListener('volumechange', updateVolumeButton);
            
            // 初始化播放器
            audioPlayer.volume = currentVolume;
            updateVolumeButton();
            updatePlayModeDisplay();
            
            // 初始化佳欣歌词API配置
            jiaxinApiKeyInput.value = jiaxinApiKey;
            if (jiaxinApiKey) {
                jiaxinConfigPanel.classList.remove('active');
            } else {
                jiaxinConfigPanel.classList.add('active');
            }
            
            // 初始状态下隐藏扩展播放器
            playerExpanded.classList.remove('active');
            floatingPlayer.classList.add('player-collapsed');
            
            // 显示初始提示
            showStatusMessage('欢迎使用音乐搜索与播放工具！输入歌曲名或歌手名开始搜索。', 'info');
        });
        
        // 保存佳欣歌词API Key
        function saveJiaxinApiKey() {
            const key = jiaxinApiKeyInput.value.trim();
            if (!key) {
                showStatusMessage('请输入API Key', 'error');
                return;
            }
            
            jiaxinApiKey = key;
            localStorage.setItem('jiaxin_api_key', key);
            jiaxinConfigPanel.classList.remove('active');
            showStatusMessage('佳欣歌词API Key已保存', 'success');
            
            // 如果当前有歌曲在播放，尝试从佳欣歌词API获取歌词
            if (currentSongId && currentSongInfo) {
                fetchJiaXinLyricsSources();
            }
        }
        
        // 显示/隐藏佳欣歌词配置面板
        function toggleJiaXinConfigPanel() {
            jiaxinConfigPanel.classList.toggle('active');
        }
        
        // 设置歌词面板拖动功能
        function setupLyricsPanelDrag() {
            // 鼠标按下事件 - 开始拖动
            lyricsDragHandle.addEventListener('mousedown', startLyricsDrag);
            
            // 鼠标移动事件 - 拖动中
            document.addEventListener('mousemove', handleLyricsDrag);
            
            // 鼠标释放事件 - 结束拖动
            document.addEventListener('mouseup', stopLyricsDrag);
            
            // 确保歌词面板在可视区域内
            ensureLyricsPanelInViewport();
        }
        
        // 开始歌词面板拖动
        function startLyricsDrag(e) {
            // 确保点击的是拖动句柄而不是其他元素（如按钮）
            if (e.target.closest('.lyrics-control-btn') || 
                e.target.closest('.lyrics-source-btn') ||
                e.target.closest('.config-panel') ||
                e.target.closest('.config-input') ||
                e.target.closest('.config-btn')) {
                return;
            }
            
            isLyricsDragging = true;
            
            // 获取初始位置
            lyricsDragStartX = e.clientX;
            lyricsDragStartY = e.clientY;
            
            // 获取歌词面板当前位置
            const rect = lyricsPanel.getBoundingClientRect();
            lyricsPanelStartX = rect.left;
            lyricsPanelStartY = rect.top;
            
            // 添加拖动样式
            lyricsPanel.style.cursor = 'move';
            lyricsPanel.style.userSelect = 'none';
            lyricsDragHandle.style.cursor = 'move';
            
            e.preventDefault();
        }
        
        // 处理歌词面板拖动
        function handleLyricsDrag(e) {
            if (!isLyricsDragging) return;
            
            // 计算移动距离
            const deltaX = e.clientX - lyricsDragStartX;
            const deltaY = e.clientY - lyricsDragStartY;
            
            // 计算新位置
            let newLeft = lyricsPanelStartX + deltaX;
            let newTop = lyricsPanelStartY + deltaY;
            
            // 限制在窗口内
            const maxLeft = window.innerWidth - lyricsPanel.offsetWidth;
            const maxTop = window.innerHeight - lyricsPanel.offsetHeight;
            
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));
            
            // 应用新位置
            lyricsPanel.style.left = newLeft + 'px';
            lyricsPanel.style.top = newTop + 'px';
            lyricsPanel.style.right = 'auto';
            lyricsPanel.style.bottom = 'auto';
        }
        
        // 停止歌词面板拖动
        function stopLyricsDrag() {
            if (!isLyricsDragging) return;
            
            isLyricsDragging = false;
            
            // 移除拖动样式
            lyricsPanel.style.cursor = 'default';
            lyricsPanel.style.userSelect = 'auto';
            lyricsDragHandle.style.cursor = 'move';
        }
        
        // 确保歌词面板在可视区域内
        function ensureLyricsPanelInViewport() {
            // 初始化位置（右下角）
            const panelWidth = lyricsPanel.offsetWidth;
            const panelHeight = lyricsPanel.offsetHeight;
            
            const right = 20;
            const bottom = 180;
            
            lyricsPanel.style.left = 'auto';
            lyricsPanel.style.top = 'auto';
            lyricsPanel.style.right = right + 'px';
            lyricsPanel.style.bottom = bottom + 'px';
        }
        
        // 切换视图样式
        function switchView(view) {
            // 移除之前的视图类
            songListElement.parentElement.classList.remove('list-view', 'grid-view', 'compact-view');
            
            // 添加新的视图类
            songListElement.parentElement.classList.add(`${view}-view`);
            
            // 更新按钮状态
            viewButtons.forEach(button => {
                if (button.dataset.view === view) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // 保存当前视图
            currentView = view;
            
            // 显示状态消息
            const viewNames = {
                'list': '列表视图',
                'grid': '网格视图',
                'compact': '紧凑视图'
            };
            showStatusMessage(`已切换至${viewNames[view]}`, 'info');
        }
        
        // 更新选中的平台
        function updateSelectedPlatform(value, text, iconClass) {
            currentPlatform = value;
            
            // 更新UI显示
            platformToggle.querySelector('.platform-name span').textContent = text;
            platformToggle.querySelector('.platform-icon i').className = iconClass;
            
            // 更新选项激活状态
            platformOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.value === value) {
                    option.classList.add('active');
                }
            });
        }
        
        // 执行搜索
        async function performSearch() {
            const songName = songNameInput.value.trim();
            const page = currentPage;
            const limit = 20;
            
            if (!songName) {
                showStatusMessage('请输入歌曲名称或歌手名', 'error');
                return;
            }
            
            // 显示加载状态
            showLoading(true);
            showPreloadInfo(false);
            clearError();
            clearResults();
            
            // 重置计数器
            loadedSongsCount = 0;
            totalSongsCount = 0;
            updateLoadedCount();
            
            try {
                // 调用API获取音乐ID
                const searchParams = {
                    name: songName,
                    type: currentPlatform,
                    page: page,
                    limit: limit
                };
                
                const searchData = await getMusicId(searchParams);
                
                // 处理搜索结果
                handleSearchResults(searchData);
                
                // 开始异步加载歌曲详细信息
                if (searchData && searchData.code === 1 && searchData.data && searchData.data.length > 0) {
                    totalSongsCount = searchData.data.length;
                    showPreloadInfo(true);
                    
                    // 异步加载所有歌曲信息
                    loadAllSongDetailsAsync(searchData.data);
                }
                
                // 更新分页按钮状态
                updatePaginationButtons(searchData);
                
                showStatusMessage(`找到 ${searchData.data?.length || 0} 首歌曲`, 'success');
                
            } catch (error) {
                showStatusMessage(`搜索失败: ${error.message}`, 'error');
            } finally {
                // 隐藏加载状态
                showLoading(false);
            }
        }
        
        // 获取音乐ID API
        async function getMusicId(params) {
            const requiredParams = ['name', 'type', 'page', 'limit'];
            const missingParams = requiredParams.filter(param => !params[param]);
            
            if (missingParams.length > 0) {
                throw new Error(`缺少必填参数: ${missingParams.join(', ')}`);
            }
            
            const requestUrl = 'https://yunzhiapi.cn/API/hqyyid.php';
            const queryParams = new URLSearchParams();
            
            queryParams.append('name', encodeURIComponent(params.name.trim()));
            queryParams.append('type', params.type);
            queryParams.append('page', params.page);
            queryParams.append('limit', params.limit);
            
            const response = await fetch(`${requestUrl}?${queryParams.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // 处理搜索结果
        function handleSearchResults(data) {
            emptyStateElement.style.display = 'none';
            songListElement.innerHTML = '';
            
            if (!data || data.code !== 1 || !data.data || data.data.length === 0) {
                emptyStateElement.style.display = 'flex';
                emptyStateElement.innerHTML = `
                    <div>
                        <i class="fas fa-search"></i>
                        <h3>未找到相关歌曲</h3>
                        <p>请尝试其他关键词或更换平台</p>
                    </div>
                `;
                return;
            }
            
            currentSearchResults = data.data;
            
            // 创建初始歌曲项
            data.data.forEach((song, index) => {
                createSongItemStructure(song, index);
            });
            
            // 应用当前视图样式
            switchView(currentView);
        }
        
        // 异步加载所有歌曲详细信息
        async function loadAllSongDetailsAsync(songs) {
            songs.forEach((song, index) => {
                setTimeout(() => {
                    loadSingleSongDetail(song, index);
                }, index * 50);
            });
        }
        
        // 加载单首歌曲详情
        async function loadSingleSongDetail(song, index) {
            try {
                const searchParams = {
                    id: song.id,
                    type: currentPlatform
                };
                
                const result = await musicSearchAPI(searchParams);
                
                // 将结果存入缓存
                songDetailsCache[song.id] = result;
                
                // 更新计数
                loadedSongsCount++;
                updateLoadedCount();
                updatePreloadProgress(loadedSongsCount, totalSongsCount);
                
                // 更新歌曲项
                updateSongItem(song, result, index);
                
            } catch (error) {
                console.error(`加载歌曲 ${song.name} 失败:`, error);
                songDetailsCache[song.id] = { error: true, message: error.message };
                
                loadedSongsCount++;
                updateLoadedCount();
                updatePreloadProgress(loadedSongsCount, totalSongsCount);
                
                updateErrorSongItem(song, error.message);
            }
            
            // 如果所有歌曲都加载完成，隐藏预加载信息
            if (loadedSongsCount >= totalSongsCount) {
                setTimeout(() => {
                    showPreloadInfo(false);
                    showStatusMessage(`${totalSongsCount} 首歌曲已加载完成`, 'success');
                }, 500);
            }
        }
        
        // 创建歌曲项的基本结构
        function createSongItemStructure(song, index) {
            const songItem = document.createElement('li');
            songItem.className = 'song-item song-loading';
            songItem.dataset.id = song.id;
            songItem.dataset.index = index;
            
            const songName = song.name || '未知歌曲';
            const artist = song.artist || '未知艺术家';
            const album = song.album || '未知专辑';
            const duration = song.duration ? formatDuration(song.duration) : '';
            
            // 根据当前视图创建不同的HTML结构
            let songItemHTML = '';
            
            if (currentView === 'grid') {
                songItemHTML = `
                    <div class="song-cover">
                        <div class="cover-placeholder">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <img src="" alt="${songName}">
                    </div>
                    <div class="song-info">
                        <h4 class="song-title">${songName}</h4>
                        <p class="song-artist">${artist}</p>
                        <p class="song-album">
                            <i class="fas fa-compact-disc"></i>
                            ${album}
                        </p>
                        ${duration ? `<div class="song-duration">${duration}</div>` : ''}
                    </div>
                    <div class="song-actions">
                        <button class="song-action-btn" data-id="${song.id}" disabled>
                            <i class="fas fa-spinner fa-spin"></i>
                        </button>
                    </div>
                `;
            } else if (currentView === 'detailed') {
                songItemHTML = `
                    <div class="song-cover">
                        <div class="cover-placeholder">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <img src="" alt="${songName}">
                    </div>
                    <div class="song-info">
                        <h4 class="song-title">${songName}</h4>
                        <p class="song-artist">${artist}</p>
                        <p class="song-album">
                            <i class="fas fa-compact-disc"></i>
                            ${album}
                        </p>
                        ${duration ? `<div class="song-duration">时长: ${duration}</div>` : ''}
                    </div>
                    <div class="song-actions">
                        <button class="song-action-btn" data-id="${song.id}" disabled>
                            <i class="fas fa-spinner fa-spin"></i>
                        </button>
                    </div>
                `;
            } else {
                // 默认列表或紧凑视图
                songItemHTML = `
                    <div class="song-cover">
                        <div class="cover-placeholder">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <img src="" alt="${songName}">
                    </div>
                    <div class="song-info">
                        <h4 class="song-title">${songName}</h4>
                        <p class="song-artist">${artist}</p>
                        <p class="song-album">
                            <i class="fas fa-compact-disc"></i>
                            ${album}
                        </p>
                    </div>
                    <div class="song-actions">
                        <button class="song-action-btn" data-id="${song.id}" disabled>
                            <i class="fas fa-spinner fa-spin"></i>
                        </button>
                    </div>
                `;
            }
            
            songItem.innerHTML = songItemHTML;
            songListElement.appendChild(songItem);
            
            // 为播放按钮添加事件
            songItem.querySelector('.song-action-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                const songId = this.dataset.id;
                playSong(songId, true);
            });
            
            // 为整个歌曲项添加点击事件
            songItem.addEventListener('click', function() {
                const songId = this.dataset.id;
                playSong(songId, true);
            });
            
            // 尝试加载封面
            loadAlbumCover(song, songItem.querySelector('.song-cover img'), songItem.querySelector('.cover-placeholder'));
        }
        
        // 更新歌曲项
        function updateSongItem(song, result, index) {
            const songItem = document.querySelector(`.song-item[data-id="${song.id}"]`);
            if (!songItem) return;
            
            // 更新歌曲项状态
            songItem.classList.remove('song-loading');
            songItem.classList.add('song-loaded');
            
            // 更新播放按钮
            const playBtn = songItem.querySelector('.song-action-btn');
            playBtn.disabled = false;
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            // 移除加载状态
            const placeholder = songItem.querySelector('.cover-placeholder');
            if (placeholder.querySelector('.fa-spinner')) {
                placeholder.innerHTML = '<i class="fas fa-music"></i>';
            }
            
            // 更新封面
            if (result && result.code === 1 && result.data && result.data.pic) {
                const img = songItem.querySelector('img');
                img.src = result.data.pic;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }
        
        // 更新错误歌曲项
        function updateErrorSongItem(song, errorMessage) {
            const songItem = document.querySelector(`.song-item[data-id="${song.id}"]`);
            if (!songItem) return;
            
            songItem.classList.add('error');
            const placeholder = songItem.querySelector('.cover-placeholder');
            placeholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            placeholder.style.color = 'var(--error-color)';
            
            const songInfo = songItem.querySelector('.song-info');
            const errorElement = document.createElement('p');
            errorElement.style.color = 'var(--error-color)';
            errorElement.style.fontSize = '12px';
            errorElement.textContent = '加载失败';
            songInfo.appendChild(errorElement);
            
            songItem.querySelector('.song-action-btn').innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            songItem.querySelector('.song-action-btn').disabled = true;
        }
        
        // 加载专辑封面
        function loadAlbumCover(song, imgElement, placeholder) {
            let coverUrl = null;
            
            if (song.pic) {
                coverUrl = song.pic;
            } else if (song.picUrl) {
                coverUrl = song.picUrl;
            } else if (song.cover) {
                coverUrl = song.cover;
            } else if (song.coverUrl) {
                coverUrl = song.coverUrl;
            } else if (song.pic_id && currentPlatform === 'wy') {
                coverUrl = `https://p3.music.126.net/${song.pic_id}/${song.pic_id}.jpg?param=100y100`;
            }
            
            if (coverUrl) {
                const img = new Image();
                img.onload = function() {
                    imgElement.src = coverUrl;
                    imgElement.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                img.onerror = function() {
                    // 保持占位符
                };
                img.src = coverUrl;
            }
        }
        
        // 播放歌曲
        function playSong(songId, autoPlay = false) {
            const songData = songDetailsCache[songId];
            
            if (!songData) {
                showStatusMessage('歌曲信息正在加载中，请稍后...', 'warning');
                return;
            }
            
            if (songData.error) {
                showStatusMessage(`无法播放歌曲: ${songData.message}`, 'error');
                return;
            }
            
            // 查找对应的歌曲信息
            const song = currentSearchResults.find(s => s.id == songId);
            
            // 更新当前选中的歌曲
            currentSongId = songId;
            currentSongInfo = song; // 保存歌曲信息，用于佳欣歌词搜索
            
            // 处理播放链接结果
            handlePlayLinkResult(songData, song, autoPlay);
            
            // 高亮当前选中的歌曲
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === songId) {
                    item.classList.add('active');
                    // 滚动到可见区域
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
            
            showStatusMessage(`准备播放: ${song?.name || '未知歌曲'}`, 'success');
        }
        
        // 音乐聚合搜索API
        async function musicSearchAPI(params) {
            return new Promise((resolve, reject) => {
                if (!params.id || !params.type) {
                    reject(new Error("缺少必填参数：id或type"));
                    return;
                }
                
                const requestUrl = "https://yunzhiapi.cn/API/yyjhss.php";
                const queryParams = new URLSearchParams();
                
                queryParams.append("id", params.id);
                queryParams.append("type", params.type);
                
                fetch(`${requestUrl}?${queryParams.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态码: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        resolve(data);
                    })
                    .catch(error => {
                        if (error.message.includes("HTTP error")) {
                            reject(new Error("服务器响应错误"));
                        } else {
                            reject(new Error("网络请求失败: " + error.message));
                        }
                    });
            });
        }
        
        // 聚合LRC歌词API
        async function fetchLrcLyrics(id, msg, type = 'text') {
            // 检查必填参数是否完整
            if (!id || !msg) {
                return {
                    error: true,
                    message: '缺少必填参数: id 和 msg 都不能为空'
                };
            }

            // 检查msg参数是否合法
            const validMsgs = ['qq', 'wy', 'kw', 'qi'];
            if (!validMsgs.includes(msg)) {
                return {
                    error: true,
                    message: 'msg参数错误: 只支持 qq(QQ音乐)、wy(网易云音乐)、kw(酷我音乐)、qi(千千音乐)'
                };
            }

            // 构造请求参数
            const params = new URLSearchParams();
            params.append('id', id);
            params.append('msg', msg);
            params.append('type', type);

            try {
                // 发送API请求
                const response = await fetch('https://yunzhiapi.cn/API/jhlrcgc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                // 检查响应状态
                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }

                // 根据type参数决定返回格式
                if (type === 'json') {
                    const data = await response.json();
                    return data;
                } else {
                    const text = await response.text();
                    return text;
                }
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }
        
        // 佳欣歌词API - 搜索歌曲
        async function searchJiaXinSongs(title, server = 'netease') {
            // 检查API Key
            if (!jiaxinApiKey) {
                return {
                    error: true,
                    message: '请先配置佳欣歌词API Key'
                };
            }
            
            // 构造请求参数
            const params = new URLSearchParams();
            params.append('key', jiaxinApiKey);
            params.append('title', title);
            params.append('server', server);
            
            try {
                // 发送API请求
                const response = await fetch(`https://apix.iqfk.top/api/lyric?${params.toString()}`);
                
                // 检查响应状态
                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }
        
        // 佳欣歌词API - 获取歌词
        async function fetchJiaXinLyrics(server, id, auth) {
            // 检查API Key
            if (!jiaxinApiKey) {
                return {
                    error: true,
                    message: '请先配置佳欣歌词API Key'
                };
            }
            
            // 构造请求参数
            const params = new URLSearchParams();
            params.append('key', jiaxinApiKey);
            params.append('server', server);
            params.append('id', id);
            params.append('auth', auth);
            
            try {
                // 发送API请求
                const response = await fetch(`https://apix.iqfk.top/api/lyric?${params.toString()}`);
                
                // 检查响应状态
                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }
        
        // 解析LRC参数字符串
        function parseLrcParams(lrcString) {
            // 格式: "server=netease&id=2733581267&auth=b0bdd6a1676e3cf5d8741653b7fb8b4ecabfb739"
            const params = new URLSearchParams(lrcString);
            return {
                server: params.get('server'),
                id: params.get('id'),
                auth: params.get('auth')
            };
        }
        
        // 处理播放链接结果
        function handlePlayLinkResult(data, song, autoPlay = false) {
            updatePlayerSection(data, song, autoPlay);
        }
        
        // 更新播放器区域
        async function updatePlayerSection(data, song, autoPlay = false) {
            // 设置歌曲信息
            if (song) {
                playerTitle.textContent = song.name || '未知歌曲';
                playerArtist.textContent = song.artist || '未知艺术家';
            } else {
                playerTitle.textContent = '未知歌曲';
                playerArtist.textContent = '未知艺术家';
            }
            
            // 重置播放器歌词行
            playerLyricsLine.textContent = '';
            playerLyricsLine.classList.remove('active');
            
            // 重置歌词源
            resetLyricsSources();
            
            // 检查是否有播放链接数据
            if (data && data.code === 1 && data.data) {
                const songData = data.data;
                
                // 更新专辑封面
                if (songData.pic) {
                    playerAlbumArt.src = songData.pic;
                    playerAlbumArt.style.display = 'block';
                    playerAlbumArt.parentElement.querySelector('.cover-placeholder').style.display = 'none';
                }
                
                // 更新音频播放器
                if (songData.url) {
                    const decodedUrl = songData.url.replace(/\\\//g, '/');
                    
                    audioPlayer.src = decodedUrl;
                    
                    // 应用当前播放速度
                    audioPlayer.playbackRate = currentPlaybackRate;
                    
                    // 重置播放器状态
                    isPlaying = false;
                    updatePlayPauseButton();
                    updatePlayerDisplay();
                    
                    // 如果autoPlay为true，则自动播放
                    if (autoPlay) {
                        setTimeout(() => {
                            // 检查音频是否已加载完成
                            if (audioPlayer.readyState >= 2) {
                                audioPlayer.play().catch(e => {
                                    console.log('自动播放失败:', e);
                                    // 如果自动播放失败，更新按钮状态
                                    isPlaying = false;
                                    updatePlayPauseButton();
                                    
                                    // 显示用户友好的提示信息
                                    if (e.name === 'AbortError') {
                                        showStatusMessage('自动播放被中断，请手动点击播放按钮', 'warning');
                                    } else if (e.name === 'NotAllowedError') {
                                        showStatusMessage('浏览器阻止了自动播放，请手动点击播放按钮', 'warning');
                                    }
                                });
                            } else {
                                // 如果音频未准备好，等待加载完成
                                const waitForLoad = () => {
                                    if (audioPlayer.readyState >= 2) {
                                        audioPlayer.play().catch(e => {
                                            console.log('自动播放失败:', e);
                                            isPlaying = false;
                                            updatePlayPauseButton();
                                            if (e.name === 'AbortError') {
                                                showStatusMessage('自动播放被中断，请手动点击播放按钮', 'warning');
                                            }
                                        });
                                    } else {
                                        setTimeout(waitForLoad, 100);
                                    }
                                };
                                waitForLoad();
                            }
                        }, 500); // 增加延迟时间，确保页面完全加载
                    }
                }
                
                // 更新歌词
                if (songData.lrc) {
                    parseAndDisplayLyrics(songData.lrc, 'original');
                    addLyricsSource('original', '原始歌词');
                    
                    // 尝试从其他歌词源获取歌词
                    fetchAdditionalLyricsSources(song.id);
                    
                    // 尝试从佳欣歌词API获取歌词
                    if (song) {
                        fetchJiaXinLyricsSources(song);
                    }
                } else {
                    displaySimpleLyrics('暂无歌词');
                    
                    // 尝试从其他歌词源获取歌词
                    fetchAdditionalLyricsSources(song.id);
                    
                    // 尝试从佳欣歌词API获取歌词
                    if (song) {
                        fetchJiaXinLyricsSources(song);
                    }
                }
            } else {
                displaySimpleLyrics('无法获取歌曲详情');
                
                // 重置其他元素
                playerAlbumArt.style.display = 'none';
                playerAlbumArt.parentElement.querySelector('.cover-placeholder').style.display = 'flex';
                
                // 重置音频播放器
                audioPlayer.src = '';
                isPlaying = false;
                updatePlayPauseButton();
                updatePlayerDisplay();
            }
        }
        
        // 重置歌词源
        function resetLyricsSources() {
            // 只清空下拉菜单内容，保留下拉菜单结构
            if (lyricsSourceDropdown) {
                lyricsSourceDropdown.innerHTML = '';
            }
            availableLyricsSources = [];
            currentLyricsSource = 'original';
            lyricsSourceBadge.textContent = '';
            // 重置下拉菜单文本
            if (lyricsSourceText) {
                lyricsSourceText.textContent = '选择歌词源';
            }
        }
        
        // 添加歌词源 - 使用自定义下拉菜单
        function addLyricsSource(source, name) {
            if (availableLyricsSources.includes(source)) return;
            
            availableLyricsSources.push(source);
            
            // 创建下拉菜单项
            const sourceItem = document.createElement('div');
            sourceItem.className = 'lyrics-source-item';
            if (source === currentLyricsSource) {
                sourceItem.classList.add('active');
                lyricsSourceText.textContent = name;
            }
            sourceItem.dataset.source = source;
            sourceItem.textContent = name;
            sourceItem.title = `切换至${name}歌词`;
            
            // 特殊处理佳欣歌词源
            if (source.startsWith('jx-')) {
                if (!jiaxinApiKey) {
                    sourceItem.title = `${name} (需要配置API Key)`;
                }
            }
            
            // 添加点击事件
            sourceItem.addEventListener('click', function() {
                switchLyricsSource(source);
                lyricsSourceDropdown.classList.remove('active');
                lyricsSourceTrigger.classList.remove('active');
            });
            
            // 添加到下拉菜单
            lyricsSourceDropdown.appendChild(sourceItem);
        }
        
        // 设置歌词源加载状态 - 使用自定义下拉菜单
        function setLyricsSourceLoading(source, isLoading) {
            const sourceItem = lyricsSourceDropdown.querySelector(`.lyrics-source-item[data-source="${source}"]`);
            if (sourceItem) {
                if (isLoading) {
                    sourceItem.classList.add('loading');
                    sourceItem.innerHTML = '<i class="fas fa-spinner fa-spin lyrics-loading-spinner"></i> ' + (lyricsSourceNames[source] || source);
                } else {
                    sourceItem.classList.remove('loading');
                    sourceItem.textContent = lyricsSourceNames[source] || source;
                }
            }
        }
        
        // 切换歌词源
        async function switchLyricsSource(source) {
            if (source === currentLyricsSource) return;
            
            // 检查佳欣歌词API Key
            if (source.startsWith('jx-') && !jiaxinApiKey) {
                showStatusMessage('请先配置佳欣歌词API Key', 'warning');
                jiaxinConfigPanel.classList.add('active');
                return;
            }
            
            // 更新下拉菜单项状态
            document.querySelectorAll('.lyrics-source-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.source === source) {
                    item.classList.add('active');
                    lyricsSourceText.textContent = item.textContent;
                }
            });
            
            currentLyricsSource = source;
            lyricsSourceBadge.textContent = lyricsSourceNames[source] || source;
            
            // 根据来源获取歌词
            if (source === 'original') {
                // 使用原始歌词
                const songData = songDetailsCache[currentSongId];
                if (songData && songData.code === 1 && songData.data && songData.data.lrc) {
                    parseAndDisplayLyrics(songData.data.lrc, source);
                } else {
                    displaySimpleLyrics('暂无歌词');
                }
            } else if (source.startsWith('jx-')) {
                // 使用佳欣歌词API获取歌词
                await fetchLyricsFromJiaXin(source);
            }
            
            showStatusMessage(`已切换至${lyricsSourceNames[source] || source}歌词`, 'info');
        }
        
        // 从指定源获取歌词 - 已废弃，只保留佳欣API
        async function fetchLyricsFromSource(source) {
            // 不再支持其他歌词源，只保留佳欣API
            displaySimpleLyrics('该歌词源已不再支持');
            setLyricsSourceLoading(source, false);
        }
        
        // 从佳欣歌词API获取歌词
        async function fetchLyricsFromJiaXin(source) {
            if (!currentSongInfo || !jiaxinApiKey) {
                showStatusMessage('请先配置佳欣歌词API Key', 'warning');
                return;
            }
            
            // 设置加载状态
            setLyricsSourceLoading(source, true);
            
            try {
                // 提取server类型
                const server = source === 'jx-netease' ? 'netease' : 'tencent';
                
                // 1. 先搜索歌曲
                const searchResult = await searchJiaXinSongs(currentSongInfo.name, server);
                
                if (searchResult && searchResult.code === 200 && searchResult.data && searchResult.data.length > 0) {
                    // 2. 取第一个结果，解析LRC参数
                    const firstResult = searchResult.data[0];
                    const lrcParams = parseLrcParams(firstResult.lrc);
                    
                    if (lrcParams.server && lrcParams.id && lrcParams.auth) {
                        // 3. 获取歌词
                        const lyricsResult = await fetchJiaXinLyrics(
                            lrcParams.server,
                            lrcParams.id,
                            lrcParams.auth
                        );
                        
                        if (lyricsResult && lyricsResult.code === 200 && lyricsResult.data && lyricsResult.data.lyrics) {
                            // 成功获取歌词
                            parseAndDisplayLyrics(lyricsResult.data.lyrics, source);
                        } else {
                            displaySimpleLyrics(`暂无${lyricsSourceNames[source]}歌词`);
                        }
                    } else {
                        displaySimpleLyrics(`无法解析${lyricsSourceNames[source]}歌词参数`);
                    }
                } else {
                    const errorMsg = searchResult ? searchResult.message : '搜索失败';
                    displaySimpleLyrics(`无法获取${lyricsSourceNames[source]}歌词: ${errorMsg}`);
                }
                
                setLyricsSourceLoading(source, false);
            } catch (error) {
                console.error('获取佳欣歌词失败:', error);
                displaySimpleLyrics(`获取${lyricsSourceNames[source]}歌词失败`);
                setLyricsSourceLoading(source, false);
            }
        }
        
        // 获取其他歌词源 - 移除了yunzhiapi.cn相关功能
        function fetchAdditionalLyricsSources(songId) {
            // 不再支持其他歌词源，只保留佳欣API
        }
        
        // 获取佳欣歌词源
        function fetchJiaXinLyricsSources(song) {
            if (!song || !song.name) return;
            
            // 添加佳欣歌词源按钮
            addLyricsSource('jx-netease', '佳欣歌词(网易)');
            addLyricsSource('jx-tencent', '佳欣歌词(腾讯)');
            
            // 如果没有API Key，显示配置提示
            if (!jiaxinApiKey) {
                showStatusMessage('佳欣歌词API需要配置Key，点击歌词源按钮进行配置', 'info');
            }
        }
        
        // 新增：更新播放器歌词行
        function updatePlayerLyricsLine() {
            if (lyricsData.length === 0 || !audioPlayer.currentTime) {
                playerLyricsLine.textContent = '';
                playerLyricsLine.classList.remove('active');
                return;
            }
            
            const currentTime = audioPlayer.currentTime;
            let currentLyricText = '';
            
            // 查找当前时间对应的歌词
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= currentTime && lyricsData[i].time >= 0) {
                    // 如果这是最后一行，或者下一行的时间大于当前时间
                    if (i === lyricsData.length - 1 || lyricsData[i + 1].time > currentTime) {
                        currentLyricText = lyricsData[i].text;
                        break;
                    }
                }
            }
            
            if (currentLyricText) {
                playerLyricsLine.textContent = currentLyricText;
                playerLyricsLine.classList.add('active');
            } else {
                playerLyricsLine.textContent = '';
                playerLyricsLine.classList.remove('active');
            }
        }
        
        // 歌词解析和显示功能
        
        // 解析LRC格式歌词
        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            const lyrics = [];
            
            // 正则表达式匹配时间标签 [mm:ss.xx] 或 [mm:ss]
            const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/g;
            
            lines.forEach(line => {
                const matches = [...line.matchAll(timeRegex)];
                
                if (matches.length > 0) {
                    // 提取歌词文本（移除所有时间标签）
                    const text = line.replace(timeRegex, '').trim();
                    
                    // 为每个时间标签创建歌词条目
                    matches.forEach(match => {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const milliseconds = match[3] ? parseInt(match[3].padEnd(3, '0')) : 0;
                        
                        const timeInSeconds = minutes * 60 + seconds + milliseconds / 1000;
                        
                        if (text) {
                            lyrics.push({
                                time: timeInSeconds,
                                text: text
                            });
                        }
                    });
                } else if (line.trim()) {
                    // 如果没有时间标签，但有文本，则作为无时间戳歌词
                    lyrics.push({
                        time: -1,
                        text: line.trim()
                    });
                }
            });
            
            // 按时间排序
            lyrics.sort((a, b) => a.time - b.time);
            
            return lyrics;
        }
        
        // 解析并显示歌词
        function parseAndDisplayLyrics(lrcText, source = 'original') {
            // 解析歌词
            lyricsData = parseLyrics(lrcText);
            currentLyricIndex = -1;
            
            // 清空现有歌词
            playerLyrics.innerHTML = '';
            
            if (lyricsData.length === 0) {
                // 如果没有解析出歌词，显示原始文本
                displaySimpleLyrics(lrcText);
                return;
            }
            
            // 创建歌词行
            lyricsData.forEach((lyric, index) => {
                const lineElement = document.createElement('div');
                lineElement.className = 'lyrics-line';
                lineElement.dataset.index = index;
                lineElement.dataset.time = lyric.time;
                lineElement.textContent = lyric.text;
                
                playerLyrics.appendChild(lineElement);
            });
            
            // 动态调整歌词卡片大小
            if (isLyricsVisible) {
                setTimeout(adjustLyricsCardSize, 100);
            }
            
            // 如果歌词面板是打开的，开始高亮
            if (isLyricsVisible && isPlaying) {
                startLyricsHighlight();
            }
            
            // 更新播放器歌词行
            updatePlayerLyricsLine();
            
            // 更新歌词来源徽章
            lyricsSourceBadge.textContent = lyricsSourceNames[source] || source;
        }
        
        // 显示简单歌词（无高亮）
        function displaySimpleLyrics(text) {
            lyricsData = [];
            currentLyricIndex = -1;
            playerLyrics.innerHTML = text;
            playerLyricsLine.textContent = '';
            playerLyricsLine.classList.remove('active');
            lyricsSourceBadge.textContent = '';
        }
        
        // 开始歌词高亮
        function startLyricsHighlight() {
            if (lyricsData.length === 0) return;
            
            // 清除之前的定时器
            stopLyricsHighlight();
            
            // 立即更新一次高亮
            updateLyricsHighlight();
            
            // 设置定时器持续更新
            lyricsScrollInterval = setInterval(updateLyricsHighlight, 100);
        }
        
        // 停止歌词高亮
        function stopLyricsHighlight() {
            if (lyricsScrollInterval) {
                clearInterval(lyricsScrollInterval);
                lyricsScrollInterval = null;
            }
        }
        
        // 更新歌词高亮
        function updateLyricsHighlight() {
            if (lyricsData.length === 0 || !audioPlayer.currentTime) return;
            
            const currentTime = audioPlayer.currentTime;
            let newIndex = -1;
            
            // 查找当前时间对应的歌词行
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= currentTime && lyricsData[i].time >= 0) {
                    // 如果这是最后一行，或者下一行的时间大于当前时间
                    if (i === lyricsData.length - 1 || lyricsData[i + 1].time > currentTime) {
                        newIndex = i;
                        break;
                    }
                }
            }
            
            // 如果找到新的歌词行，更新高亮
            if (newIndex !== -1 && newIndex !== currentLyricIndex) {
                // 移除之前的高亮
                if (currentLyricIndex !== -1) {
                    const prevLine = playerLyrics.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                    if (prevLine) {
                        prevLine.classList.remove('active');
                        prevLine.classList.add('past');
                    }
                }
                
                // 添加新的高亮
                const newLine = playerLyrics.querySelector(`.lyrics-line[data-index="${newIndex}"]`);
                if (newLine) {
                    newLine.classList.add('active');
                    newLine.classList.remove('past', 'future');
                    
                    // 滚动到当前歌词行
                    scrollToLyricLine(newLine);
                    
                    // 更新未来歌词行的样式
                    updateFutureLyricsStyle(newIndex);
                }
                
                currentLyricIndex = newIndex;
            }
        }
        
        // 更新未来歌词行的样式
        function updateFutureLyricsStyle(currentIndex) {
            const allLines = playerLyrics.querySelectorAll('.lyrics-line');
            
            allLines.forEach((line, index) => {
                if (index > currentIndex) {
                    line.classList.remove('past', 'active');
                    line.classList.add('future');
                } else if (index < currentIndex) {
                    line.classList.remove('active', 'future');
                    line.classList.add('past');
                }
            });
        }
        
        // 滚动到歌词行 - 确保高亮歌词显示在中央
        function scrollToLyricLine(lineElement) {
            if (!lineElement || !playerLyrics) return;
            
            const container = playerLyrics;
            const lineHeight = lineElement.offsetHeight;
            const containerHeight = container.offsetHeight;
            const lineTop = lineElement.offsetTop;
            
            // 计算滚动位置，使当前行在容器中间
            const targetScrollTop = lineTop - (containerHeight / 2) + (lineHeight / 2);
            
            // 确保滚动位置在合理范围内
            const maxScrollTop = container.scrollHeight - containerHeight;
            const finalScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));
            
            // 使用平滑滚动
            container.scrollTo({
                top: finalScrollTop,
                behavior: 'smooth'
            });
        }
        
        // 动态调整歌词卡片大小
        function adjustLyricsCardSize() {
            if (!isLyricsVisible || !lyricsPanel) return;
            
            // 获取歌词内容区域
            const lyricsContent = playerLyrics;
            if (!lyricsContent) return;
            
            // 获取所有歌词行
            const lyricLines = lyricsContent.querySelectorAll('.lyrics-line');
            if (lyricLines.length === 0) return;
            
            // 计算单行动画后的平均高度（考虑缩放效果）
            let totalHeight = 0;
            lyricLines.forEach(line => {
                totalHeight += line.offsetHeight;
            });
            const avgLineHeight = totalHeight / lyricLines.length;
            
            // 计算需要显示的行数（中央3行高亮显示，上下各显示2-3行）
            const visibleLines = 7; // 中央1行高亮 + 上下各3行
            const optimalHeight = avgLineHeight * visibleLines;
            
            // 确保最小和最大高度
            const minHeight = 200;
            const maxHeight = window.innerHeight * 0.6; // 最大高度为视口高度的60%
            const finalHeight = Math.max(minHeight, Math.min(optimalHeight, maxHeight));
            
            // 更新歌词面板高度
            lyricsPanel.style.height = `${finalHeight}px`;
            
            // 重新滚动到当前歌词行，确保高亮显示在中央
            if (currentLyricIndex !== -1) {
                const currentLine = lyricsContent.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                if (currentLine) {
                    scrollToLyricLine(currentLine);
                }
            }
        }
        
        // 更新歌词面板透明度
        function updateLyricsPanelOpacity(opacity) {
            if (!lyricsPanel) return;
            
            // 保存当前透明度设置
            localStorage.setItem('lyricsOpacity', opacity);
            
            // 更新歌词面板的透明度
            lyricsPanel.style.background = `rgba(15, 23, 42, ${opacity})`;
            
            // 更新歌词内容区域的背景透明度
            const lyricsContent = playerLyrics;
            if (lyricsContent) {
                lyricsContent.style.background = `rgba(15, 23, 42, ${Math.max(0, opacity - 0.1)})`;
            }
            
            // 更新下拉菜单的透明度
            if (lyricsSourceDropdown) {
                lyricsSourceDropdown.style.background = `rgba(15, 23, 42, ${opacity})`;
            }
            
            // 更新下拉菜单触发器的透明度
            if (lyricsSourceTrigger) {
                lyricsSourceTrigger.style.background = `rgba(255, 255, 255, ${opacity * 0.05})`;
            }
        }
        
        // 播放器控制功能
        function updatePlayerDisplay() {
            if (!audioPlayer.duration || isNaN(audioPlayer.duration)) {
                currentTimeElement.textContent = "00:00";
                totalTimeElement.textContent = "00:00";
                progressBar.style.width = "0%";
                progressBuffer.style.width = "0%";
                progressHandle.style.left = "0%";
                
                // 更新底部进度条
                const bottomProgressBar = document.getElementById('bottomProgressBar');
                if (bottomProgressBar) {
                    bottomProgressBar.style.width = "0%";
                }
                return;
            }
            
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            const progressPercent = (currentTime / duration) * 100;
            
            currentTimeElement.textContent = formatTime(currentTime);
            totalTimeElement.textContent = formatTime(duration);
            progressBar.style.width = `${progressPercent}%`;
            progressHandle.style.left = `${progressPercent}%`;
            
            // 更新底部进度条
            const bottomProgressBar = document.getElementById('bottomProgressBar');
            if (bottomProgressBar) {
                bottomProgressBar.style.width = `${progressPercent}%`;
            }
            
            // 更新缓冲进度
            if (audioPlayer.buffered.length > 0) {
                const bufferedEnd = audioPlayer.buffered.end(audioPlayer.buffered.length - 1);
                const bufferedPercent = (bufferedEnd / duration) * 100;
                progressBuffer.style.width = `${bufferedPercent}%`;
            }
            
            // 更新全屏进度条

        }
        
        function togglePlayPause() {
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(e => {
                    showStatusMessage("播放失败: " + e.message, 'error');
                });
            }
        }
        
        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
                playPauseBtn.title = "暂停";
            } else {
                icon.className = 'fas fa-play';
                playPauseBtn.title = "播放";
            }
            
            // 更新全屏播放/暂停按钮

        }
        
        function togglePlayMode() {
            currentPlayModeIndex = (currentPlayModeIndex + 1) % playModes.length;
            updatePlayModeDisplay();
        }
        
        function updatePlayModeDisplay() {
            const mode = playModes[currentPlayModeIndex];
            const icon = playModeBtn.querySelector('i');
            let modeText = '';
            
            switch(mode) {
                case 'order':
                    icon.className = 'fas fa-retweet';
                    modeText = '顺序播放';
                    audioPlayer.loop = false;
                    break;
                case 'loop':
                    icon.className = 'fas fa-redo';
                    modeText = '单曲循环';
                    audioPlayer.loop = true;
                    break;
                case 'random':
                    icon.className = 'fas fa-random';
                    modeText = '随机播放';
                    audioPlayer.loop = false;
                    break;
            }
            
            playModeBtn.title = modeText;
            playModeBtn.classList.toggle('active', mode !== 'order');
            showStatusMessage(`播放模式: ${modeText}`, 'info');
            
            // 更新全屏播放模式显示

        }
        
        // 初始化播放速度菜单
        function initPlaybackRateMenu() {
            const dropdown = document.getElementById('playbackRateDropdown');
            const rateText = document.getElementById('playbackRateText');
            
            // 清空现有选项
            dropdown.innerHTML = '';
            
            // 添加播放速度选项
            playbackRates.forEach((rate, index) => {
                const option = document.createElement('div');
                option.className = `playback-rate-option ${index === currentPlaybackRateIndex ? 'active' : ''}`;
                option.textContent = `${rate}x`;
                option.title = `播放速度: ${rate}x`;
                
                option.addEventListener('click', function() {
                    // 更新当前播放速度
                    currentPlaybackRateIndex = index;
                    currentPlaybackRate = rate;
                    
                    // 应用到音频播放器
                    audioPlayer.playbackRate = rate;
                    
                    // 更新触发器显示
                    rateText.textContent = `${rate}x`;
                    playbackRateBtn.title = `播放速度: ${rate}x`;
                    
                    // 更新选项的激活状态
                    dropdown.querySelectorAll('.playback-rate-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    option.classList.add('active');
                    
                    // 关闭下拉菜单
                    dropdown.classList.remove('active');
                    
                    showStatusMessage(`播放速度: ${rate}x`, 'info');
                });
                
                dropdown.appendChild(option);
            });
        }
        
        // 切换播放速度 - 保留原函数名，以防其他地方调用
        function togglePlaybackRate() {
            // 切换到下一个播放速度
            currentPlaybackRateIndex = (currentPlaybackRateIndex + 1) % playbackRates.length;
            currentPlaybackRate = playbackRates[currentPlaybackRateIndex];
            
            // 应用到音频播放器
            audioPlayer.playbackRate = currentPlaybackRate;
            
            // 更新触发器显示
            const rateText = document.getElementById('playbackRateText');
            rateText.textContent = `${currentPlaybackRate}x`;
            playbackRateBtn.title = `播放速度: ${currentPlaybackRate}x`;
            
            // 更新菜单选项的激活状态
            const dropdown = document.getElementById('playbackRateDropdown');
            dropdown.querySelectorAll('.playback-rate-option').forEach((opt, index) => {
                opt.classList.toggle('active', index === currentPlaybackRateIndex);
            });
            
            showStatusMessage(`播放速度: ${currentPlaybackRate}x`, 'info');
        }
        

        
        function toggleMute() {
            audioPlayer.muted = !audioPlayer.muted;
            updateVolumeButton();
        }
        
        function updateVolumeButton() {
            const icon = volumeBtn.querySelector('i');
            const volume = audioPlayer.muted ? 0 : audioPlayer.volume;
            
            if (volume === 0) {
                icon.className = 'fas fa-volume-mute';
                volumeBtn.title = "取消静音";
            } else if (volume < 0.5) {
                icon.className = 'fas fa-volume-down';
                volumeBtn.title = "音量";
            } else {
                icon.className = 'fas fa-volume-up';
                volumeBtn.title = "静音";
            }
            
            if (!audioPlayer.muted) {
                volumeSlider.value = volume * 100;
                // 更新全屏音量滑块
            }
        }
        
        // 透明度控制函数 - 卡片式面板
        let playerOpacity = 1.0; // 播放器透明度 (0-1)
        let textOpacity = 1.0;   // 文本透明度 (0-1)
        
        // 获取透明度面板元素
        const opacityPanel = document.getElementById('opacityPanel');
        const closeOpacityPanel = document.getElementById('closeOpacityPanel');
        const playerOpacitySlider = document.getElementById('playerOpacitySlider');
        const textOpacitySlider = document.getElementById('textOpacitySlider');
        const playerOpacityValue = document.getElementById('playerOpacityValue');
        const textOpacityValue = document.getElementById('textOpacityValue');
        
        function toggleOpacityPanel() {
            if (opacityPanel.style.display === 'flex') {
                closeOpacityPanelFunc();
            } else {
                opacityPanel.style.display = 'flex';
            }
        }
        
        function closeOpacityPanelFunc() {
            opacityPanel.style.display = 'none';
        }
        
        function updatePlayerOpacity(opacity) {
            playerOpacity = opacity / 100;
            
            // 更新播放器背景透明度（不影响文本）
            const playerSection = document.querySelector('.player-section');
            if (playerSection) {
                playerSection.style.backgroundColor = `rgba(15, 23, 42, ${playerOpacity * 0.95})`;
                playerSection.style.backdropFilter = `blur(${20 * playerOpacity}px)`;
            }
            
            // 更新浮动播放器背景透明度（不影响文本）
            const floatingPlayer = document.querySelector('.floating-player');
            if (floatingPlayer) {
                floatingPlayer.style.backgroundColor = `rgba(15, 23, 42, ${playerOpacity * 0.95})`;
                floatingPlayer.style.backdropFilter = `blur(${20 * playerOpacity}px)`;
            }
            
            // 更新歌词面板背景透明度（不影响文本）
            const lyricsPanel = document.getElementById('lyricsPanel');
            if (lyricsPanel && lyricsPanel.style.display !== 'none') {
                lyricsPanel.style.backgroundColor = `rgba(15, 23, 42, ${playerOpacity * 0.95})`;
                lyricsPanel.style.backdropFilter = `blur(${20 * playerOpacity}px)`;
            }
            
            // 更新透明度按钮图标
            updateOpacityButton();
            
            // 保存透明度设置到本地存储
            localStorage.setItem('playerOpacity', playerOpacity);
        }
        
        function updateTextOpacity(opacity) {
            textOpacity = opacity / 100;
            
            // 仅更新播放器内的文本元素透明度
            const playerTextElements = document.querySelectorAll('.floating-player .player-song-title, .floating-player .player-song-artist, .floating-player .player-lyrics-line, .floating-player .current-time, .floating-player .total-time, .floating-player .control-btn, .floating-player .volume-btn, .floating-player .secondary-btn, .floating-player .playback-rate-trigger, .floating-player .playback-rate-option, .floating-player .opacity-btn');
            playerTextElements.forEach(element => {
                element.style.opacity = textOpacity;
            });
            
            // 保存文本透明度设置到本地存储
            localStorage.setItem('textOpacity', textOpacity);
        }
        
        function updateOpacityButton() {
            const icon = opacityBtn.querySelector('i');
            
            if (playerOpacity <= 0.3) {
                icon.className = 'fas fa-adjust';
                opacityBtn.title = "透明度: 低";
            } else if (playerOpacity <= 0.6) {
                icon.className = 'fas fa-adjust';
                opacityBtn.title = "透明度: 中";
            } else {
                icon.className = 'fas fa-adjust';
                opacityBtn.title = "透明度: 高";
            }
        }
        
        // 初始化透明度设置
        function initOpacitySettings() {
            // 加载播放器透明度
            const savedPlayerOpacity = localStorage.getItem('playerOpacity');
            if (savedPlayerOpacity) {
                playerOpacity = parseFloat(savedPlayerOpacity);
                playerOpacitySlider.value = playerOpacity * 100;
                playerOpacityValue.textContent = Math.round(playerOpacity * 100) + '%';
                updatePlayerOpacity(playerOpacity * 100);
            }
            
            // 加载文本透明度
            const savedTextOpacity = localStorage.getItem('textOpacity');
            if (savedTextOpacity) {
                textOpacity = parseFloat(savedTextOpacity);
                textOpacitySlider.value = textOpacity * 100;
                textOpacityValue.textContent = Math.round(textOpacity * 100) + '%';
                updateTextOpacity(textOpacity * 100);
            }
        }
        
        // 获取当前播放的歌曲信息
        function getCurrentPlayingSong() {
            if (!currentSongId || !currentSearchResults || currentSearchResults.length === 0) {
                return null;
            }
            
            const song = currentSearchResults.find(s => s.id == currentSongId);
            return song || null;
        }
        
        function playPrevSong() {
            if (!currentSearchResults || currentSearchResults.length === 0) return;
            
            const currentIndex = currentSearchResults.findIndex(song => song.id == currentSongId);
            let prevIndex;
            
            if (playModes[currentPlayModeIndex] === 'random') {
                prevIndex = Math.floor(Math.random() * currentSearchResults.length);
            } else {
                prevIndex = currentIndex - 1;
                if (prevIndex < 0) prevIndex = currentSearchResults.length - 1;
            }
            
            if (prevIndex >= 0 && prevIndex < currentSearchResults.length) {
                const prevSong = currentSearchResults[prevIndex];
                playSong(prevSong.id, true);
            }
        }
        
        function playNextSong() {
            if (!currentSearchResults || currentSearchResults.length === 0) return;
            
            const currentIndex = currentSearchResults.findIndex(song => song.id == currentSongId);
            let nextIndex;
            
            if (playModes[currentPlayModeIndex] === 'random') {
                nextIndex = Math.floor(Math.random() * currentSearchResults.length);
            } else {
                nextIndex = currentIndex + 1;
                if (nextIndex >= currentSearchResults.length) nextIndex = 0;
            }
            
            if (nextIndex >= 0 && nextIndex < currentSearchResults.length) {
                const nextSong = currentSearchResults[nextIndex];
                playSong(nextSong.id, true);
            }
        }
        
        function startSeeking(e) {
            e.preventDefault();
            isSeeking = true;
            
            const seek = (e) => {
                if (!isSeeking) return;
                
                const rect = progressContainer.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                progressBar.style.width = `${percent * 100}%`;
                progressHandle.style.left = `${percent * 100}%`;
                currentTimeElement.textContent = formatTime(percent * audioPlayer.duration);
                
                // 更新底部进度条
                const bottomProgressBar = document.getElementById('bottomProgressBar');
                if (bottomProgressBar) {
                    bottomProgressBar.style.width = `${percent * 100}%`;
                }
            };
            
            const stopSeeking = (e) => {
                if (!isSeeking) return;
                
                isSeeking = false;
                
                const rect = progressContainer.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                audioPlayer.currentTime = percent * audioPlayer.duration;
                
                document.removeEventListener('mousemove', seek);
                document.removeEventListener('mouseup', stopSeeking);
            };
            
            seek(e);
            document.addEventListener('mousemove', seek);
            document.addEventListener('mouseup', stopSeeking);
        }
        
        // 下载歌曲
        function downloadSong() {
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            // 获取当前歌曲的直链
            const songUrl = audioPlayer.src;
            
            if (!songUrl) {
                showStatusMessage('无法获取歌曲直链', 'error');
                return;
            }
            
            // 获取当前播放的歌曲信息
            const currentSong = getCurrentPlayingSong();
            if (!currentSong) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }
            
            try {
                // 清理文件名中的非法字符
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(currentSong.name || '未知歌曲');
                const artist = cleanFileName(currentSong.artist || '未知艺术家');
                
                // 设置下载文件名
                const fileName = `${songName} - ${artist}.mp3`;
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = songUrl;
                link.download = fileName;
                link.style.display = 'none';
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatusMessage(`开始下载: ${songName} - ${artist}`, 'success');
                
                // 添加下载统计（可选）
                console.log(`下载歌曲: ${fileName}`, songUrl);
                
            } catch (error) {
                console.error('下载失败:', error);
                showStatusMessage('下载失败，请重试', 'error');
                
                // 备用方案：在新标签页打开音频文件
                window.open(songUrl, '_blank');
            }
        }
        
        // 增强版下载功能
        let downloadController = null;
        
        // 显示下载进度面板
        function showDownloadPanel() {
            const panel = document.getElementById('downloadPanel');
            if (panel) {
                panel.style.display = 'flex';
            }
        }
        
        // 隐藏下载进度面板
        function hideDownloadPanel() {
            const panel = document.getElementById('downloadPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }
        
        // 使用Fetch API实现带进度监控的下载
        function startDownloadWithProgress(url, fileName) {
            // 创建AbortController用于取消下载
            downloadController = new AbortController();
            const signal = downloadController.signal;
            
            // 下载统计变量
            let startTime = Date.now();
            let downloadedBytes = 0;
            let totalBytes = 0;
            let lastUpdateTime = 0;
            let lastDownloadedBytes = 0;
            let updatedFileName = fileName;
            
            // 存储已下载的数据块
            const chunks = [];
            
            // 更新下载进度的函数
            function updateProgress(bytesRead, totalBytesLength) {
                downloadedBytes = bytesRead;
                totalBytes = totalBytesLength;
                
                const now = Date.now();
                const elapsedTime = now - startTime;
                const downloadSpeed = ((downloadedBytes - lastDownloadedBytes) / (now - lastUpdateTime)) * 1000;
                
                // 每秒更新一次速度
                if (now - lastUpdateTime > 1000) {
                    lastUpdateTime = now;
                    lastDownloadedBytes = downloadedBytes;
                }
                
                // 计算百分比
                const percentage = totalBytes > 0 ? Math.round((downloadedBytes / totalBytes) * 100) : 0;
                
                // 格式化大小
                const formatSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                };
                
                // 格式化速度
                const formatSpeed = (bytesPerSecond) => {
                    if (bytesPerSecond < 1024) return bytesPerSecond.toFixed(2) + ' B/s';
                    if (bytesPerSecond < 1024 * 1024) return (bytesPerSecond / 1024).toFixed(2) + ' KB/s';
                    return (bytesPerSecond / (1024 * 1024)).toFixed(2) + ' MB/s';
                };
                
                // 更新UI
                document.getElementById('downloadPercentage').textContent = percentage + '%';
                document.getElementById('downloadSpeed').textContent = formatSpeed(downloadSpeed);
                document.getElementById('downloadSize').textContent = `${formatSize(downloadedBytes)} / ${formatSize(totalBytes)}`;
                document.getElementById('downloadProgressBar').style.width = percentage + '%';
                document.getElementById('downloadStatus').textContent = '下载中...';
            }
            
            // 直接开始下载，不发送HEAD请求以提高速度
            const headers = {
                'Range': 'bytes=0-'
            };
            
            fetch(url, {
                signal,
                headers
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // 获取文件大小
                totalBytes = parseInt(response.headers.get('content-length') || '0');
                
                // 检测文件类型
                let detectedFileType = 'audio/mpeg';
                let detectedExtension = 'mp3';
                
                // 从响应头获取Content-Type
                const contentType = response.headers.get('content-type');
                if (contentType) {
                    detectedFileType = contentType;
                    
                    // 根据MIME类型确定扩展名
                    const mimeToExtension = {
                        'audio/mpeg': 'mp3',
                        'audio/mp4': 'm4a',
                        'audio/ogg': 'ogg',
                        'audio/wav': 'wav',
                        'audio/flac': 'flac',
                        'audio/aac': 'aac'
                    };
                    
                    if (mimeToExtension[contentType]) {
                        detectedExtension = mimeToExtension[contentType];
                    }
                }
                
                // 更新文件名，使用检测到的扩展名
                const baseFileName = fileName.substring(0, fileName.lastIndexOf('.'));
                updatedFileName = `${baseFileName}.${detectedExtension}`;
                
                // 创建读取器
                const reader = response.body.getReader();
                
                // 读取数据
                function read() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // 下载完成
                            const blob = new Blob(chunks, { type: detectedFileType });
                            saveBlobAsFile(blob, updatedFileName);
                            return;
                        }
                        
                        // 添加数据块
                        chunks.push(value);
                        downloadedBytes += value.length;
                        
                        // 更新进度
                        updateProgress(downloadedBytes, totalBytes);
                        
                        // 继续读取
                        return read();
                    });
                }
                
                return read();
            }).then(() => {
                // 下载成功
                document.getElementById('downloadStatus').textContent = '下载完成';
                showStatusMessage(`下载完成: ${updatedFileName}`, 'success');
                
                // 3秒后自动关闭面板
                setTimeout(hideDownloadPanel, 3000);
            }).catch(error => {
                if (error.name === 'AbortError') {
                    // 取消下载的情况已经在cancelDownload函数中处理，这里可以忽略
                    // 避免重复显示消息和关闭面板
                } else {
                    console.error('下载失败:', error);
                    document.getElementById('downloadStatus').textContent = '下载失败';
                    showStatusMessage('下载失败: ' + error.message, 'error');
                    setTimeout(hideDownloadPanel, 2000);
                }
            });
        }
        
        // 保存Blob为文件
        function saveBlobAsFile(blob, fileName) {
            try {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                console.error('保存文件失败:', error);
                showStatusMessage('保存文件失败，请重试', 'error');
            }
        }
        
        // 取消下载
        function cancelDownload() {
            if (downloadController) {
                downloadController.abort();
                downloadController = null;
                
                // 立即更新UI状态，不等待Promise catch
                document.getElementById('downloadStatus').textContent = '下载已取消';
                showStatusMessage('下载已取消', 'info');
                hideDownloadPanel(); // 立即关闭下载面板，不延迟
            }
        }
        
        // 初始化下载面板事件监听器
        function initDownloadPanel() {
            const closeBtn = document.getElementById('closeDownloadPanel');
            const cancelBtn = document.getElementById('cancelDownloadBtn');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDownloadPanel);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelDownload);
            }
        }

        // 初始化公告面板事件监听器
        function initAnnouncementPanel() {
            const announcementBtn = document.getElementById('announcementBtn');
            const closeBtn = document.getElementById('closeAnnouncementPanel');
            
            if (announcementBtn) {
                announcementBtn.addEventListener('click', showAnnouncementPanel);
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideAnnouncementPanel);
            }
        }

        // 显示公告面板
        function showAnnouncementPanel() {
            const panel = document.getElementById('announcementPanel');
            if (panel) {
                panel.style.display = 'flex';
            }
        }

        // 隐藏公告面板
        function hideAnnouncementPanel() {
            const panel = document.getElementById('announcementPanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }
        
        // 检查浏览器是否支持现代下载功能
        function isModernBrowser() {
            return (
                'fetch' in window &&
                'AbortController' in window &&
                'ReadableStream' in window &&
                'Blob' in window &&
                'createObjectURL' in window.URL
            );
        }
        
        // 重写downloadSong函数以使用新功能
        function downloadSong() {
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            // 获取当前歌曲的直链
            const songUrl = audioPlayer.src;
            
            if (!songUrl) {
                showStatusMessage('无法获取歌曲直链', 'error');
                return;
            }
            
            // 获取当前播放的歌曲信息
            const currentSong = getCurrentPlayingSong();
            if (!currentSong) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }
            
            try {
                // 清理文件名中的非法字符
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(currentSong.name || '未知歌曲');
                const artist = cleanFileName(currentSong.artist || '未知艺术家');
                
                // 设置下载文件名
                const fileName = `${songName} - ${artist}.mp3`;
                
                // 确保downloadController为null，避免之前的下载影响
                if (downloadController) {
                    downloadController.abort();
                    downloadController = null;
                }
                
                // 检查浏览器兼容性
                if (isModernBrowser()) {
                    // 显示下载进度面板
                    showDownloadPanel();
                    
                    // 更新下载信息
                    document.getElementById('downloadFileName').textContent = fileName;
                    document.getElementById('downloadStatus').textContent = '准备下载...';
                    document.getElementById('downloadPercentage').textContent = '0%';
                    document.getElementById('downloadSpeed').textContent = '0 KB/s';
                    document.getElementById('downloadSize').textContent = '0 MB / 0 MB';
                    document.getElementById('downloadProgressBar').style.width = '0%';
                    
                    // 开始下载
                    startDownloadWithProgress(songUrl, fileName);
                } else {
                    // 降级方案：使用传统的a标签下载
                    showStatusMessage('浏览器不支持高级下载功能，使用传统下载方式', 'info');
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = songUrl;
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    // 触发下载
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatusMessage(`开始下载: ${fileName}`, 'success');
                }
                
            } catch (error) {
                console.error('下载失败:', error);
                showStatusMessage('下载失败，请重试', 'error');
                hideDownloadPanel();
                
                // 确保downloadController被重置
                if (downloadController) {
                    downloadController = null;
                }
            }
        }
        
        // 播放器展开/收起
        function togglePlayerExpanded() {
            isPlayerExpanded = !isPlayerExpanded;
            
            // 获取底部进度条元素
            const bottomProgressContainer = document.getElementById('bottomProgressContainer');
            
            if (isPlayerExpanded) {
                playerExpanded.classList.add('active');
                floatingPlayer.classList.remove('player-collapsed');
                togglePlayerBtn.classList.add('active');
                togglePlayerBtn.title = "收起播放器";
                
                // 展开时隐藏底部进度条
                if (bottomProgressContainer) {
                    bottomProgressContainer.style.display = 'none';
                }
            } else {
                playerExpanded.classList.remove('active');
                floatingPlayer.classList.add('player-collapsed');
                togglePlayerBtn.classList.remove('active');
                togglePlayerBtn.title = "展开播放器";
                
                // 收起时显示底部进度条
                if (bottomProgressContainer) {
                    bottomProgressContainer.style.display = 'block';
                }
            }
        }
        
        // 歌词面板控制
        function toggleLyricsPanel() {
            isLyricsVisible = !isLyricsVisible;
            
            if (isLyricsVisible) {
                lyricsPanel.classList.add('active');
                showLyricsBtn.classList.add('active');
                lyricsBtn.classList.add('active');
                lyricsBtn.title = "隐藏歌词";
                
                // 动态调整歌词卡片大小
                setTimeout(adjustLyricsCardSize, 100);
                
                // 如果正在播放，开始歌词高亮
                if (isPlaying) {
                    startLyricsHighlight();
                }
            } else {
                lyricsPanel.classList.remove('active');
                showLyricsBtn.classList.remove('active');
                lyricsBtn.classList.remove('active');
                lyricsBtn.title = "显示歌词";
                
                // 停止歌词高亮
                stopLyricsHighlight();
            }
        }
        
        function openLyricsPanel() {
            isLyricsVisible = true;
            lyricsPanel.classList.add('active');
            showLyricsBtn.classList.add('active');
            lyricsBtn.classList.add('active');
            lyricsBtn.title = "隐藏歌词";
            
            // 动态调整歌词卡片大小
            setTimeout(adjustLyricsCardSize, 100);
            
            // 如果正在播放，开始歌词高亮
            if (isPlaying) {
                startLyricsHighlight();
            }
        }
        
        function closeLyricsPanel() {
            isLyricsVisible = false;
            lyricsPanel.classList.remove('active');
            
            // 停止歌词高亮
            stopLyricsHighlight();
        }
        
        // 工具函数
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity) return "00:00";
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatDuration(ms) {
            if (!ms) return "00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function showLoading(show, message = '正在搜索音乐，请稍候...') {
            if (show) {
                loadingElement.classList.add('active');
                loadingElement.querySelector('.loading-text').textContent = message;
                searchBtn.disabled = true;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
            } else {
                loadingElement.classList.remove('active');
                searchBtn.disabled = false;
            }
        }
        
        function showPreloadInfo(show) {
            if (show) {
                preloadInfo.classList.add('active');
            } else {
                preloadInfo.classList.remove('active');
            }
        }
        
        function showStatusMessage(message, type = 'info') {
            statusText.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.classList.add('active');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusMessage.classList.remove('active');
            }, 3000);
        }
        
        function clearError() {
            errorMessageElement.classList.remove('active');
        }
        
        function clearResults() {
            songListElement.innerHTML = '';
            songDetailsCache = {};
            currentSearchResults = [];
            emptyStateElement.style.display = 'flex';
            emptyStateElement.innerHTML = `
                <div>
                    <i class="fas fa-music"></i>
                    <h3>搜索结果显示在这里</h3>
                    <p>输入关键词并点击搜索按钮开始搜索</p>
                </div>
            `;
        }
        
        function updatePaginationButtons(data) {
            currentPageElement.textContent = currentPage;
            prevPageBtn.disabled = currentPage <= 1;
            
            const limit = 20;
            if (data && data.data && data.data.length === limit) {
                hasNextPage = true;
                nextPageBtn.disabled = false;
            } else {
                hasNextPage = false;
                nextPageBtn.disabled = true;
            }
        }
        
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                performSearch();
            }
        }
        
        function goToNextPage() {
            currentPage++;
            performSearch();
        }
        
        function updateLoadedCount() {
            loadedSongCountElement.textContent = loadedSongsCount;
            preloadStatus.textContent = `${loadedSongsCount}/${totalSongsCount} 已加载`;
        }
        
        function updatePreloadProgress(loaded, total) {
            const percentage = total > 0 ? Math.round((loaded / total) * 100) : 0;
            preloadProgressBar.style.width = `${percentage}%`;
        }
    </script>
</body>
</html>
