<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新春烟花 · 红金年华</title>
    <style>
        /* 全局保留黑底，让烟花更夺目 */
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        .music {
            display: none;
        }

        /* 新春主题播放卡片 —— 红金配色，带有祥云般的渐变 */
        .play-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #d32f2f 0%, #b71c1c 40%, #ff8f00 100%);
            border-radius: 30px;
            padding: 40px 70px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(230, 30, 30, 0.6), 0 0 30px rgba(255, 215, 0, 0.5);
            border: 2px solid #ffd966;
            z-index: 10000;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: springPulse 2.2s infinite;
        }

        .play-card:hover {
            transform: translate(-50%, -50%) scale(1.08);
            box-shadow: 0 20px 60px rgba(230, 30, 30, 0.8), 0 0 50px #ffb300;
            border-color: #ffeb9c;
        }

        .play-card-icon {
            width: 90px;
            height: 90px;
            margin: 0 auto 25px;
            background: radial-gradient(circle at 30% 30%, #ffeb9c, #ff8c00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 25px #ffd700;
            border: 3px solid #fff2b5;
        }

        .play-card-icon::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 36px solid #b71c1c;
            border-top: 22px solid transparent;
            border-bottom: 22px solid transparent;
            margin-left: 12px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        .play-card-title {
            font-size: 32px;
            font-weight: 900;
            color: #ffecb3;
            text-shadow: 0 2px 10px #ff6f00, 0 0 20px #ffd700;
            letter-spacing: 4px;
            margin-bottom: 12px;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .play-card-text {
            font-size: 18px;
            color: #ffe082;
            text-shadow: 0 2px 5px #b71c1c;
            font-weight: 500;
            letter-spacing: 2px;
        }

        @keyframes springPulse {
            0% { box-shadow: 0 15px 40px rgba(230, 30, 30, 0.6), 0 0 30px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 20px 55px rgba(255, 60, 60, 0.9), 0 0 55px #ffcc00; }
            100% { box-shadow: 0 15px 40px rgba(230, 30, 30, 0.6), 0 0 30px rgba(255, 215, 0, 0.5); }
        }

        /* 新春文本 —— 用真正的HTML文字显示，璀璨夺目，可点击穿透 */
        .new-year-text {
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: clamp(3rem, 15vw, 6rem);
            font-weight: 900;
            font-family: 'Microsoft YaHei', '楷体', '华文楷体', sans-serif;
            text-align: center;
            white-space: nowrap;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 1.5s ease;
            pointer-events: none;
            z-index: 20000;
            letter-spacing: 8px;
        }

        /* canvas 初始透明，点击后淡入 */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1.2s ease;
        }
        #fireworkCanvas {
            z-index: 1;
            pointer-events: auto;
        }
        #canvas {
            z-index: 8888;
        }
        /* 原第三个canvas .canvas 已移除，不再使用 */
    </style>
</head>
<body>

    <!-- 背景音乐 -->
    <audio id="bgMusic" loop preload="auto">
        <source src="yanhua.mp3" type="audio/mpeg">
        您的浏览器不支持 audio 元素。
    </audio>

    <!-- 新春红金播放卡片 -->
    <div id="playCard" class="play-card">
        <div class="play-card-icon"></div>
        <div class="play-card-title">恭贺新禧</div>
        <div class="play-card-text">点击开启 · 红运烟花</div>
    </div>

    <!-- 真正的HTML新春文本 (点击后显示) -->
    <div id="newYearText" class="new-year-text">恭贺新禧</div>

    <!-- 保留两个canvas：3D烟花 和 2D点击烟花 (原第三个canvas已删除) -->
    <canvas id="fireworkCanvas" style="position:absolute; width:100%; height:100%; z-index:1;"></canvas>
    <canvas id="canvas" style="position:absolute; width:100%; height:100%; z-index:8888;"></canvas>

    <script>
        // ==================== 全局变量声明 ====================
        var canvas = document.getElementById('canvas');          // 3D烟花画布
        var fireworkCanvas = document.getElementById('fireworkCanvas'); // 2D烟花画布
        var ctx, cx, cy, pi, playerZ, playerX, playerY, playerVX, playerVY, playerVZ, pitch, yaw, pitchV, yawV, scale, seedTimer, seedInterval, seedLife, gravity, seeds, sparkPics, sparks, frames, s;
        // 3D烟花图片前缀 (保留原外部资源)
        s = "https://cantelope.org/NYE/";

        // ==================== 原3D粒子烟花 (完全保留) ====================
        function initVars() {
            pi = Math.PI;
            ctx = canvas.getContext("2d");
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            cx = canvas.width / 2;
            cy = canvas.height / 2;
            playerZ = -25;
            playerX = playerY = playerVX = playerVY = playerVZ = pitch = yaw = pitchV = yawV = 0;
            scale = 600;
            seedTimer = 0; seedInterval = 5; seedLife = 100; gravity = .02;
            seeds = [];
            sparkPics = [];
            for (i = 1; i <= 10; ++i) {
                sparkPic = new Image();
                sparkPic.src = s + "spark" + i + ".png";
                sparkPics.push(sparkPic);
            }
            sparks = [];
            frames = 0;
        }

        function rasterizePoint(x, y, z) {
            var p, d;
            x -= playerX;
            y -= playerY;
            z -= playerZ;
            p = Math.atan2(x, z);
            d = Math.sqrt(x * x + z * z);
            x = Math.sin(p - yaw) * d;
            z = Math.cos(p - yaw) * d;
            p = Math.atan2(y, z);
            d = Math.sqrt(y * y + z * z);
            y = Math.sin(p - pitch) * d;
            z = Math.cos(p - pitch) * d;
            var rx1 = -1000, ry1 = 1, rx2 = 1000, ry2 = 1, rx3 = 0, ry3 = 0, rx4 = x, ry4 = z, uc = (ry4 - ry3) * (rx2 - rx1) - (rx4 - rx3) * (ry2 - ry1);
            if (!uc) return { x: 0, y: 0, d: -1 };
            var ua = ((rx4 - rx3) * (ry1 - ry3) - (ry4 - ry3) * (rx1 - rx3)) / uc;
            var ub = ((rx2 - rx1) * (ry1 - ry3) - (ry2 - ry1) * (rx1 - rx3)) / uc;
            if (!z) z = .000000001;
            if (ua > 0 && ua < 1 && ub > 0 && ub < 1) {
                return {
                    x: cx + (rx1 + ua * (rx2 - rx1)) * scale,
                    y: cy + y / z * scale,
                    d: Math.sqrt(x * x + y * y + z * z)
                };
            } else {
                return {
                    x: cx + (rx1 + ua * (rx2 - rx1)) * scale,
                    y: cy + y / z * scale,
                    d: -1
                };
            }
        }

        function spawnSeed() {
            seed = new Object();
            seed.x = -50 + Math.random() * 100;
            seed.y = 25;
            seed.z = -50 + Math.random() * 100;
            seed.vx = .1 - Math.random() * .2;
            seed.vy = -1.5;
            seed.vz = .1 - Math.random() * .2;
            seed.born = frames;
            seeds.push(seed);
        }

        function splode(x, y, z) {
            t = 5 + parseInt(Math.random() * 150);
            sparkV = 1 + Math.random() * 2.5;
            type = parseInt(Math.random() * 3);
            switch (type) {
                case 0: pic1 = parseInt(Math.random() * 10); break;
                case 1:
                    pic1 = parseInt(Math.random() * 10);
                    do { pic2 = parseInt(Math.random() * 10); } while (pic2 == pic1);
                    break;
                case 2:
                    pic1 = parseInt(Math.random() * 10);
                    do { pic2 = parseInt(Math.random() * 10); } while (pic2 == pic1);
                    do { pic3 = parseInt(Math.random() * 10); } while (pic3 == pic1 || pic3 == pic2);
                    break;
            }
            for (m = 1; m < t; ++m) {
                spark = new Object();
                spark.x = x; spark.y = y; spark.z = z;
                p1 = pi * 2 * Math.random();
                p2 = pi * Math.random();
                v = sparkV * (1 + Math.random() / 6)
                spark.vx = Math.sin(p1) * Math.sin(p2) * v;
                spark.vz = Math.cos(p1) * Math.sin(p2) * v;
                spark.vy = Math.cos(p2) * v;
                switch (type) {
                    case 0: spark.img = sparkPics[pic1]; break;
                    case 1: spark.img = sparkPics[parseInt(Math.random() * 2) ? pic1 : pic2]; break;
                    case 2:
                        switch (parseInt(Math.random() * 3)) {
                            case 0: spark.img = sparkPics[pic1]; break;
                            case 1: spark.img = sparkPics[pic2]; break;
                            case 2: spark.img = sparkPics[pic3]; break;
                        }
                        break;
                }
                spark.radius = 25 + Math.random() * 50;
                spark.alpha = 1;
                spark.trail = [];
                sparks.push(spark);
            }
            switch (parseInt(Math.random() * 4)) {
                case 0: pow = new Audio(s + "pow1.ogg"); break;
                case 1: pow = new Audio(s + "pow2.ogg"); break;
                case 2: pow = new Audio(s + "pow3.ogg"); break;
                case 3: pow = new Audio(s + "pow4.ogg"); break;
            }
            d = Math.sqrt((x - playerX) * (x - playerX) + (y - playerY) * (y - playerY) + (z - playerZ) * (z - playerZ));
            pow.volume = 1.5 / (1 + d / 10);
            pow.play();
        }

        function doLogic() {
            if (seedTimer < frames) {
                seedTimer = frames + seedInterval * Math.random() * 10;
                spawnSeed();
            }
            for (i = 0; i < seeds.length; ++i) {
                seeds[i].vy += gravity;
                seeds[i].x += seeds[i].vx;
                seeds[i].y += seeds[i].vy;
                seeds[i].z += seeds[i].vz;
                if (frames - seeds[i].born > seedLife) {
                    splode(seeds[i].x, seeds[i].y, seeds[i].z);
                    seeds.splice(i, 1);
                }
            }
            for (i = 0; i < sparks.length; ++i) {
                if (sparks[i].alpha > 0 && sparks[i].radius > 5) {
                    sparks[i].alpha -= .01;
                    sparks[i].radius /= 1.02;
                    sparks[i].vy += gravity;
                    point = new Object();
                    point.x = sparks[i].x;
                    point.y = sparks[i].y;
                    point.z = sparks[i].z;
                    if (sparks[i].trail.length) {
                        x = sparks[i].trail[sparks[i].trail.length - 1].x;
                        y = sparks[i].trail[sparks[i].trail.length - 1].y;
                        z = sparks[i].trail[sparks[i].trail.length - 1].z;
                        d = ((point.x - x) * (point.x - x) + (point.y - y) * (point.y - y) + (point.z - z) * (point.z - z));
                        if (d > 9) { sparks[i].trail.push(point); }
                    } else { sparks[i].trail.push(point); }
                    if (sparks[i].trail.length > 5) sparks[i].trail.splice(0, 1);
                    sparks[i].x += sparks[i].vx;
                    sparks[i].y += sparks[i].vy;
                    sparks[i].z += sparks[i].vz;
                    sparks[i].vx /= 1.075;
                    sparks[i].vy /= 1.075;
                    sparks[i].vz /= 1.075;
                } else {
                    sparks.splice(i, 1);
                }
            }
            p = Math.atan2(playerX, playerZ);
            d = Math.sqrt(playerX * playerX + playerZ * playerZ);
            d += Math.sin(frames / 80) / 1.25;
            t = Math.sin(frames / 200) / 40;
            playerX = Math.sin(p + t) * d;
            playerZ = Math.cos(p + t) * d;
            yaw = pi + p + t;
        }

        function draw() {
            ctx.clearRect(0, 0, cx * 2, cy * 2);
            ctx.fillStyle = "#ff8";
            for (i = -100; i < 100; i += 3) {
                for (j = -100; j < 100; j += 4) {
                    x = i; z = j; y = 25;
                    point = rasterizePoint(x, y, z);
                    if (point.d != -1) {
                        size = 250 / (1 + point.d);
                        d = Math.sqrt(x * x + z * z);
                        a = 0.75 - Math.pow(d / 100, 6) * 0.75;
                        if (a > 0) {
                            ctx.globalAlpha = a;
                            ctx.fillRect(point.x - size / 2, point.y - size / 2, size, size);
                        }
                    }
                }
            }
            ctx.globalAlpha = 1;
            for (i = 0; i < seeds.length; ++i) {
                point = rasterizePoint(seeds[i].x, seeds[i].y, seeds[i].z);
                if (point.d != -1) {
                    size = 200 / (1 + point.d);
                    ctx.fillRect(point.x - size / 2, point.y - size / 2, size, size);
                }
            }
            point1 = new Object();
            for (i = 0; i < sparks.length; ++i) {
                point = rasterizePoint(sparks[i].x, sparks[i].y, sparks[i].z);
                if (point.d != -1) {
                    size = sparks[i].radius * 200 / (1 + point.d);
                    if (sparks[i].alpha < 0) sparks[i].alpha = 0;
                    if (sparks[i].trail.length) {
                        point1.x = point.x;
                        point1.y = point.y;
                        switch (sparks[i].img) {
                            case sparkPics[0]: ctx.strokeStyle = "#f84"; break;
                            case sparkPics[1]: ctx.strokeStyle = "#84f"; break;
                            case sparkPics[2]: ctx.strokeStyle = "#8ff"; break;
                            case sparkPics[3]: ctx.strokeStyle = "#fff"; break;
                            case sparkPics[4]: ctx.strokeStyle = "#4f8"; break;
                            case sparkPics[5]: ctx.strokeStyle = "#f44"; break;
                            case sparkPics[6]: ctx.strokeStyle = "#f84"; break;
                            case sparkPics[7]: ctx.strokeStyle = "#84f"; break;
                            case sparkPics[8]: ctx.strokeStyle = "#fff"; break;
                            case sparkPics[9]: ctx.strokeStyle = "#44f"; break;
                        }
                        for (j = sparks[i].trail.length - 1; j >= 0; --j) {
                            point2 = rasterizePoint(sparks[i].trail[j].x, sparks[i].trail[j].y, sparks[i].trail[j].z);
                            if (point2.d != -1) {
                                ctx.globalAlpha = j / sparks[i].trail.length * sparks[i].alpha / 2;
                                ctx.beginPath();
                                ctx.moveTo(point1.x, point1.y);
                                ctx.lineWidth = 1 + sparks[i].radius * 10 / (sparks[i].trail.length - j) / (1 + point2.d);
                                ctx.lineTo(point2.x, point2.y);
                                ctx.stroke();
                                point1.x = point2.x;
                                point1.y = point2.y;
                            }
                        }
                    }
                    ctx.globalAlpha = sparks[i].alpha;
                    ctx.drawImage(sparks[i].img, point.x - size / 2, point.y - size / 2, size, size);
                }
            }
        }

        function frame() {
            if (frames > 100000) { seedTimer = 0; frames = 0; }
            frames++;
            draw();
            doLogic();
            requestAnimationFrame(frame);
        }

        window.addEventListener("resize", () => {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            cx = canvas.width / 2;
            cy = canvas.height / 2;
        });

        // ==================== 2D点击烟花 (fireworkCanvas) 增强颜色多样性 (完全保留) ====================
        const fwCtx = fireworkCanvas.getContext('2d', { willReadFrequently: false });
        fwCtx.imageSmoothingEnabled = true;
        fwCtx.imageSmoothingQuality = 'high';

        function resizeFireworkCanvas() { fireworkCanvas.width = window.innerWidth; fireworkCanvas.height = window.innerHeight; }
        resizeFireworkCanvas();
        window.addEventListener('resize', () => { clearTimeout(resizeFireworkCanvas.timeout); resizeFireworkCanvas.timeout = setTimeout(resizeFireworkCanvas, 100); });

        const fwRandom = (min, max) => Math.random() * (max - min) + min;
        const fwRandomInt = (min, max) => (Math.random() * (max - min + 1) + min) | 0;

        function fwGetRandomColor() {
            let hue;
            if (Math.random() < 0.7) {
                if (Math.random() < 0.8) { hue = fwRandomInt(0, 60); } 
                else { hue = fwRandomInt(340, 360); }
            } else { hue = fwRandomInt(0, 360); }
            return `hsl(${hue}, 85%, 60%)`;
        }

        class FWVector { constructor(x = 0, y = 0) { this.x = x; this.y = y; } add(v) { this.x += v.x; this.y += v.y; return this; } scale(s) { this.x *= s; this.y *= s; return this; } static add(v1, v2) { return new FWVector(v1.x + v2.x, v1.y + v2.y); } static scale(v, s) { return new FWVector(v.x * s, v.y * s); } }
        class FWParticle {
            constructor(x, y, velocity, color, isFirework = false) {
                this.pos = new FWVector(x, y); this.vel = velocity; this.color = color; this.isFirework = isFirework;
                this.life = isFirework ? 30 : fwRandomInt(40, 80); this.size = isFirework ? fwRandom(2, 4) : fwRandom(1, 3); this.gravity = isFirework ? 0.05 : 0.1;
            }
            update() { this.vel.y += this.gravity; this.vel.scale(0.98); this.pos.add(this.vel); this.life--; return this.life > 0; }
            draw() { const alpha = this.life / (this.isFirework ? 30 : 80); fwCtx.globalAlpha = alpha * 0.8; fwCtx.fillStyle = this.color; fwCtx.beginPath(); fwCtx.arc(this.pos.x, this.pos.y, this.size, 0, Math.PI * 2); fwCtx.fill(); }
        }
        class FWFirework {
            constructor(x = null) {
                this.color = fwGetRandomColor(); this.particles = []; this.isExploded = false;
                const startX = x !== null ? x : fwRandomInt(0, fireworkCanvas.width); const startY = fireworkCanvas.height + 10;
                this.fireworkParticle = new FWParticle(startX, startY, new FWVector(fwRandom(-1, 1), fwRandom(-15, -20)), this.color, true);
                this.explosionHeight = fwRandomInt(fireworkCanvas.height * 0.1, fireworkCanvas.height * 0.5);
            }
            update() {
                if (!this.isExploded) { const alive = this.fireworkParticle.update(); this.fireworkParticle.draw(); if (!alive || this.fireworkParticle.pos.y <= this.explosionHeight) { this.explode(); this.isExploded = true; } return true; }
                else { this.particles = this.particles.filter(p => p.update()); this.particles.forEach(p => p.draw()); return this.particles.length > 0; }
            }
            explode() { const particleCount = fwRandomInt(50, 100); for (let i = 0; i < particleCount; i++) { const angle = fwRandom(0, Math.PI * 2); const speed = fwRandom(1, 6); const velocity = new FWVector(Math.cos(angle) * speed, Math.sin(angle) * speed); this.particles.push(new FWParticle(this.fireworkParticle.pos.x, this.fireworkParticle.pos.y, velocity, this.color)); } }
        }

        let fwFireworks = []; let fwLastTime = 0; const fwMaxFireworks = 8;
        function fwInitFireworks() { for (let i = 0; i < 3; i++) { setTimeout(() => { if (fwFireworks.length < fwMaxFireworks) { fwFireworks.push(new FWFirework()); } }, i * 300); } }
        function fwAnimate(timestamp) {
            requestAnimationFrame(fwAnimate);
            if (timestamp - fwLastTime < 16) return; fwLastTime = timestamp;
            fwCtx.fillStyle = 'rgba(0, 0, 0, 0.1)'; fwCtx.fillRect(0, 0, fireworkCanvas.width, fireworkCanvas.height); fwCtx.globalAlpha = 1;
            if (Math.random() > 0.85 && fwFireworks.length < fwMaxFireworks) { fwFireworks.push(new FWFirework()); }
            fwFireworks = fwFireworks.filter(firework => { const alive = firework.update(); if (!alive && Math.random() > 0.5 && fwFireworks.length < fwMaxFireworks) { return true; } return alive; });
            if (Math.random() > 0.95 && fwFireworks.length < fwMaxFireworks) { const miniFirework = new FWFirework(fwRandomInt(50, fireworkCanvas.width - 50)); miniFirework.fireworkParticle.vel.y = -fwRandom(18, 22); fwFireworks.push(miniFirework); }
        }
        fireworkCanvas.addEventListener('click', (e) => {
            if (fwFireworks.length >= fwMaxFireworks) return; const firework = new FWFirework(e.clientX); firework.explosionHeight = fwRandomInt(fireworkCanvas.height * 0.1, fireworkCanvas.height * 0.4); fwFireworks.push(firework);
        });

        // ==================== 播放卡片点击：启动一切 + HTML文本显示与轮播 ====================
        document.getElementById('playCard').addEventListener('click', function() {
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.play().catch(e => console.log('音频播放需用户交互:', e));

            // 隐藏卡片
            this.style.opacity = '0';
            this.style.pointerEvents = 'none';
            setTimeout(() => { this.style.display = 'none'; }, 400);

            // 淡出两个canvas (原第三个已移除)
            document.getElementById('fireworkCanvas').style.opacity = '1';
            document.getElementById('canvas').style.opacity = '1';

            // 显示真正的HTML新春文本
            const textEl = document.getElementById('newYearText');
            textEl.style.opacity = '1';

            // 启动所有烟花引擎
            initVars();
            frame();
            fwInitFireworks();
            fwAnimate();
            
            const texts = ['Joking祝你', '2026', '新年快乐'];
            let idx = 0;
            const textInterval = setInterval(() => {
                idx++;
                if (idx >= texts.length) {
                    clearInterval(textInterval);
                    textEl.style.opacity = '0';
                } else {
                    textEl.textContent = texts[idx];
                }
            }, 3000);
        });

        // 后备：如果用户点击其他地方也尝试播放音乐（但卡片消失后不影响）
        document.body.addEventListener('click', function() {
            const bgMusic = document.getElementById('bgMusic');
            if (bgMusic.paused) {
                bgMusic.play().catch(e => console.log('备用播放失败:', e));
            }
        }, { once: true });
    </script>
</body>
</html>
