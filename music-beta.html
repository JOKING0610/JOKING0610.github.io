<!--
    零柒零音乐 (JokingMusic) -0.2.2 Beta
    作者：Joking
    版权所有 © 2026 Joking
    保留所有权利。未经授权禁止商业使用或代码盗用。违者必究。
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>零柒零音乐</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #4cc9f0;
            --primary-color-rgb: 67, 97, 238;
            --primary-light-rgb: 76, 201, 240;
            --secondary-color: #3a0ca3;
            --dark-bg: #0f172a;
            --darker-bg: #0a0f1c;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --lyrics-highlight: rgba(76, 201, 240, 0.2);
        }

        .new-year-theme {
            --primary-color: #ff0000;
            --primary-light: #ff6666;
            --primary-color-rgb: 255, 0, 0;
            --primary-light-rgb: 255, 102, 102;
            --secondary-color: #f4a261;
            --dark-bg: #2b2d42;
            --darker-bg: #1e1e2f;
            --card-bg: rgba(255, 0, 0, 0.2);
            --border-color: rgba(255, 215, 0, 0.3);
            --text-primary: #fff0f0;
            --text-secondary: #ffe5b4;
            --success-color: #2a9d8f;
            --error-color: #d62828;
            --warning-color: #fcbf49;
            --lyrics-highlight: rgba(255, 0, 0, 0.3);
        }

        .new-year-theme .background-layer {
            background-image: url('https://free.picui.cn/free/2026/02/15/69918df8d530a.png');
            background-size: cover;
            background-position: center;
            opacity: 0.7;
        }

        @media (orientation: landscape) {
            .new-year-theme .background-layer {
                background-image: url('https://free.picui.cn/free/2026/02/15/69918a721f004.jpg');
                opacity: 0.7;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', 'Microsoft YaHei', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            padding-bottom: 120px;
            font-size: 12px;
        }

        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -2;
            transition: opacity 0.5s ease, filter 0.3s ease;
            opacity: 0.5;
            filter: blur(0px);
            pointer-events: none;
            
            background-image: url('https://free.picui.cn/free/2026/02/08/6987f0c183dc5.png');
        }

        @media (orientation: landscape) {
            .background-layer {
                background-image: url('https://free.picui.cn/free/2026/02/08/6987f0bfd71dc.png');
            }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            z-index: -3;
            pointer-events: none;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            font-weight: 600;
            min-width: 16px;
            height: 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .header-btn:hover {
            background: rgba(var(--primary-color-rgb), 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 2.2rem;
            height: 2.2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 4px;
        }
        
        .logo-text p {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .beta-badge {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 2px 12px rgba(102, 126, 234, 0.6);
            }
            100% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
        }

        .new-year-theme .beta-badge {
            background-image: linear-gradient(135deg, #ff0000 0%, #f4a261 100%);
            box-shadow: 0 2px 8px rgba(255, 0, 0, 0.3);
        }

        .new-year-theme .lyrics-panel,
        .new-year-theme .download-panel,
        .new-year-theme .announcement-panel,
        .new-year-theme .playlist-panel,
        .new-year-theme .download-options-panel,
        .new-year-theme .modal-content,
        .new-year-theme .toolbar-settings-panel,
        .new-year-theme .opacity-panel {
            background: rgba(43, 45, 66, 0.95);
            backdrop-filter: blur(20px);
            border-color: var(--border-color);
        }

        .new-year-theme .recommend-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        .new-year-theme .recommend-btn:hover {
            box-shadow: 0 10px 25px rgba(255, 0, 0, 0.3);
        }

        .search-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-top: 30px;
            margin-bottom: 0;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s;
        }

        .collapsible-header:hover {
            border-bottom-color: var(--primary-light);
        }

        .collapse-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .collapse-btn:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-light);
        }

        .collapse-btn i {
            transition: transform 0.3s ease;
        }

        .collapse-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
            max-height: 500px;
            opacity: 1;
            margin-top: 15px;
        }

        .collapse-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            pointer-events: none;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--primary-light);
        }
        
        .search-form {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
                gap: 16px;
            }
            
            .player-section {
                padding: 12px;
            }
            
            .floating-player {
                width: calc(100% - 30px);
                padding: 15px;
                bottom: 10px;
            }
            
            .player-controls {
                gap: 8px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .song-item {
                padding: 10px 12px;
            }
            
            .song-title {
                font-size: 14px;
            }
            
            .song-artist {
                font-size: 12px;
            }
            
            .lyrics-panel {
                min-width: 200px;
                min-height: 150px;
                max-width: 90vw;
                max-height: 60vh;
            }
            
            .opacity-panel {
                width: 280px;
                max-width: 90vw;
                padding: 15px;
            }
            
            .opacity-panel-title {
                font-size: 14px;
            }
            
            .opacity-label span {
                font-size: 13px;
            }
            
            .volume-control {
                max-width: none;
                min-width: 100px;
                gap: 8px;
            }
            
            .volume-slider {
                height: 6px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .lyrics-panel {
                max-height: 30vh;
                bottom: 130px;
            }
        }

        @media (max-width: 768px) {
            .lyrics-panel {
                width: calc(100% - 30px) !important;
                max-height: 30vh !important;
                left: 50% !important;
                top: 10px !important;
                transform: translateX(-50%) !important;
                right: auto !important;
                bottom: auto !important;
            }
        }

        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }
        
        .platform-selector {
            position: relative;
            z-index: 2000; 
        }
        
        .platform-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 2001;
        }
        
        .platform-toggle:hover {
            border-color: var(--primary-light);
        }
        
        .platform-toggle.active {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.1);
        }
        
        .platform-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .platform-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .platform-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98); 
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
            overflow: hidden;
            z-index: 9999; 
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
        }
        
        .platform-dropdown.active {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }
        
        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .platform-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 10000; 
        }
        
        .platform-option:hover {
            background: rgba(67, 97, 238, 0.2);
        }
        
        .platform-option.active {
            background: rgba(67, 97, 238, 0.3);
            color: var(--primary-light);
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .search-input-container {
            position: relative;
            display: flex;
            align-items: stretch;
            gap: 0;
        }
        
        .search-input-container .search-input {
            flex: 1;
            border-radius: 8px 0 0 8px;
            border-right: none;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-right: none;
            color: var(--text-primary);
            font-size: 14px;
            padding: 10px;
        }
        
        .search-input-container .search-input:focus {
            outline: none;
        }
        
        .search-input-container .search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .search-input-btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 0 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
            flex-shrink: 0;
        }
        
        .search-input-btn:hover {
            color: var(--primary-light);
        }
        
        .search-input-btn i {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .search-input-container .search-input {
                font-size: 14px;
                padding: 12px;
            }
            
            .search-input-btn {
                padding: 0 16px;
                min-height: 48px;
                min-width: 48px;
                border-radius: 0 8px 8px 0;
            }
            
            .search-input-btn i {
                font-size: 14px;
            }
        }
        
        .search-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 16px;
            height: 42px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
        }
        
        .search-btn:active {
            transform: translateY(0);
        }
        
        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .quick-actions {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }
        
        .search-btn,
        .recommend-btn {
            flex: 1;
            height: 48px;
            min-width: 160px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .recommend-btn {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 16px;
            height: 42px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .recommend-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }
        
        .recommend-btn:active {
            transform: translateY(0);
        }
        
        .recommend-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            max-width: 90vw;
            max-height: 80vh;
            width: 550px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-title i {
            color: var(--primary-light);
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error-color);
            border-color: var(--error-color);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .playback-rate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            padding: 10px 0;
        }
        
        .playback-rate-grid-option {
            padding: 12px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .playback-rate-grid-option:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-light);
            color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .playback-rate-grid-option.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
            color: white;
        }
        
        .playback-rate-slider-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .playback-rate-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .playback-rate-slider-value {
            font-weight: 600;
            color: var(--primary-light);
            font-size: 16px;
        }
        
        .playback-rate-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        .playback-rate-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.4);
            transition: all 0.2s;
        }
        
        .playback-rate-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .playback-rate-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.4);
            transition: all 0.2s;
        }
        
        .playback-rate-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }
        
        .playback-rate-quick-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: space-between;
        }
        
        .quick-rate-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-rate-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-light);
        }
        
        .quick-rate-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
            color: white;
        }
        
        .recommend-song-list {
            list-style: none;
        }
        
        .recommend-song-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .recommend-song-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(76, 201, 240, 0.3);
            transform: translateX(5px);
        }
        
        .recommend-song-index {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }
        
        .recommend-song-info {
            flex: 1;
            min-width: 0;
        }
        
        .recommend-song-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .recommend-song-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-section {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .history-section.active {
            display: block;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .history-title i {
            color: var(--primary-light);
        }
        .history-clear-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }
        .history-clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error-color);
            border-color: var(--error-color);
        }
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            max-width: 100%;
        }
        .history-item:hover {
            background: rgba(var(--primary-color-rgb), 0.2);
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        .history-item i {
            font-size: 11px;
            color: var(--primary-light);
        }
        .history-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .page-info {
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .page-number {
            font-weight: bold;
            color: var(--primary-light);
        }
        
        .pagination-buttons {
            display: flex;
            gap: 12px;
        }
        
        .page-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .page-btn:hover:not(:disabled) {
            background: rgba(67, 97, 238, 0.2);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .results-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            min-height: 600px;
            position: relative;
            z-index: 5;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-count {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .results-count span {
            color: var(--primary-light);
            font-weight: bold;
        }
        
        .results-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            position: relative;
            z-index: 1; 
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: rgba(148, 163, 184, 0.3);
        }
        
        .song-list {
            list-style-type: none;
            position: relative;
            z-index: 1; 
            margin-top: 20px; 
        }
        
        .song-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
            min-height: 35px;
            touch-action: manipulation;
        }
        
        @media (max-width: 480px) {
            .floating-player {
                padding: 6px;
            }

            .player-header {
                gap: 4px;
            }

            .player-cover {
                width: 32px;
                height: 32px;
            }

            .player-song-title {
                font-size: 12px;
            }

            .player-song-artist {
                font-size: 10px;
            }

            .control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .play-btn {
                width: 34px;
                height: 34px;
                font-size: 14px;
            }

            .song-item {
                padding: 15px;
                gap: 12px;
            }
            
            .song-cover {
                width: 50px;
                height: 50px;
            }
            
            .song-title {
                font-size: 16px;
            }
            
            .song-artist {
                font-size: 13px;
            }
            
            .song-album {
                font-size: 12px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .container {
                padding: 10px;
                gap: 12px;
            }
            
            .results-section {
                padding: 20px;
            }
            
            .search-section {
                padding: 20px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
        }
        
        @media (min-width: 1201px) {
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .song-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(76, 201, 240, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .song-item.active {
            background: rgba(67, 97, 238, 0.1);
            border-color: var(--primary-color);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.15);
        }
        
        .song-cover {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .cover-placeholder {
            color: rgba(255, 255, 255, 0.2);
            font-size: 24px;
        }
        
        .song-info {
            flex: 1;
            min-width: 0;
        }
        
        .song-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-album {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .song-actions {
            display: flex;
            gap: 10px;
        }
        
        .song-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .song-action-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .add-to-list-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-to-list-btn:hover {
            background: rgba(76, 201, 240, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .add-to-list-btn i {
            font-size: 14px;
        }
        
        .floating-player {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 650px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-x: hidden;
        }

        .navbar.scrolled + .floating-player,
        .navbar.scrolled ~ .floating-player {
            bottom: 20px;
        }
        
        .player-collapsed {
            padding: 15px;
        }
        
        .player-header {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .player-cover {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .player-info {
            flex: 1;
            min-width: 0;
            min-width: 150px;
        }
        
        .player-song-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-song-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-lyrics-line {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 16px;
            transition: all 0.3s;
            opacity: 0.8;
        }
        
        .player-lyrics-line.active {
            color: var(--primary-light);
            opacity: 1;
        }
        
        .bottom-progress-container {
            position: absolute;
            bottom: 0;
            left: 10px;
            right: 10px;
            height: 3px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .bottom-progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 5px rgba(67, 97, 238, 0.3);
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            min-width: 32px;
            min-height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            touch-action: manipulation;
        }
        
        .control-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .play-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: none;
            color: white;
        }
        
        .play-btn:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .toggle-player-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .toggle-player-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }
        
        .toggle-player-btn i {
            transition: transform 0.3s;
        }
        
        .toggle-player-btn.active i {
            transform: rotate(180deg);
        }
        
        .player-expanded {
            display: none;
        }
        
        .player-expanded.active {
            display: block;
        }
        
        .progress-section {
            margin-bottom: clamp(15px, 3vw, 20px);
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .progress-container {
            position: relative;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .progress-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            width: 0%;
        }
        
        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .progress-container:hover .progress-handle {
            opacity: 1;
        }
        
        .extra-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .secondary-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .secondary-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .secondary-btn:hover {
            color: var(--primary-light);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .secondary-btn.active {
            color: var(--primary-light);
            background: rgba(67, 97, 238, 0.2);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 1 auto;
            min-width: 150px;
            max-width: 300px;
        }
        
        .volume-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            border-radius: 8px;
        }
        
        .volume-btn:hover {
            color: var(--primary-light);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 998;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .panel-overlay.active {
            display: block;
        }
        
        .opacity-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 300px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .opacity-panel.active {
            display: flex;
        }
        
        .opacity-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .opacity-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-opacity-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-opacity-panel:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .opacity-control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .opacity-control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .opacity-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .opacity-value {
            font-size: 12px;
            color: var(--primary-light);
            min-width: 30px;
            text-align: right;
        }
        
        .opacity-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            margin: 0;
        }
        
        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 8px rgba(67, 97, 238, 0.5);
        }
        
        .opacity-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .opacity-btn:hover {
            color: var(--primary-light);
            background: rgba(255, 255, 255, 0.05);
        }

        .settings-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .settings-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .settings-value {
            color: var(--primary-light);
            font-weight: 500;
        }

        .settings-slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-light);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .settings-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary-light);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.5);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .settings-options {
            display: flex;
            gap: 15px;
        }

        .settings-option-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-option-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
            color: white;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 20px 0;
        }
        
        .profile-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .avatar-container {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.3);
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .profile-id {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }
        
        .account-info {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }
        
        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-title i {
            color: var(--primary-light);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .info-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .info-value.active {
            color: var(--success-color);
        }
        
        .profile-stats {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .stat-item:hover {
            background: rgba(67, 97, 238, 0.1);
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-light);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .opacity-btn:hover {
            color: var(--text-primary);
        }

        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 15, 30, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 1001;
            transition: all 0.3s ease;
            padding: 0;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
        }

        .navbar.scrolled {
            bottom: auto;
            top: 0;
            border-top: none;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .navbar-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .navbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
            color: var(--text-secondary);
            text-decoration: none;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 10px;
            position: relative;
        }

        .navbar-item i {
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .navbar-item:hover {
            color: var(--primary-light);
            background: rgba(67, 97, 238, 0.1);
            transform: translateY(-2px);
        }

        .navbar-item.active {
            color: var(--primary-light);
            background: rgba(67, 97, 238, 0.2);
        }

        .navbar-item.active i {
            transform: scale(1.1);
        }

        .new-year-theme .play-btn {
            background: linear-gradient(135deg, #ff0000, #f4a261);
        }
        .new-year-theme .search-btn {
            background: linear-gradient(135deg, #ff0000, #f4a261);
        }

        .page-container {
            display: none;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
            position: relative;
            z-index: 1;
        }

        .page-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes panelSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 4px 0;
            }

            .navbar-container {
                padding: 0 10px;
            }

            .navbar-item {
                width: 40px;
                height: 40px;
                font-size: 10px;
            }

            .navbar-item i {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .navbar-item {
                width: 36px;
                height: 36px;
                font-size: 9px;
            }

            .navbar-item i {
                font-size: 12px;
            }

            .volume-control {
                min-width: 120px;
                gap: 4px;
            }

            .volume-slider-embedded {
                min-width: 50px;
            }

            .volume-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }

        @media (min-width: 769px) {
            .navbar {
                padding: 2px 0;
            }

            .navbar-item {
                width: 48px;
                height: 48px;
                font-size: 13px;
            }

            .navbar-item i {
                font-size: 18px;
            }
        }

        .download-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 360px;
            max-width: 90vw;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 16px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .download-panel.active {
            display: flex;
        }
        
        .download-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .download-panel-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-download-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-download-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .download-options-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 400px;
            max-width: 90vw;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 20px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .download-options-panel.active {
            display: flex;
        }
        
        .download-options-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .download-options-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-download-options-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-download-options-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .download-options-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .download-options-info {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .download-options-song-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .download-options-song-artist {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .download-options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .download-options-package {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .download-option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .download-option-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(76, 201, 240, 0.2);
        }
        
        .download-option-item input[type="checkbox"] {
            display: none;
        }
        
        .download-option-item .custom-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-secondary);
            border-radius: 6px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .download-option-item input[type="checkbox"]:checked + .custom-checkbox {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
        }
        
        .download-option-item .custom-checkbox i {
            color: white;
            font-size: 12px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease;
        }
        
        .download-option-item input[type="checkbox"]:checked + .custom-checkbox i {
            opacity: 1;
            transform: scale(1);
        }
        
        .download-option-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .download-option-label i {
            color: var(--primary-light);
            width: 16px;
            text-align: center;
        }
        
        .download-options-controls {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .download-options-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .download-options-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .download-options-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .download-options-btn.confirm {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }
        
        .download-options-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }

        .download-options-select-all {
            margin-bottom: 12px;
        }

        .select-all-btn {
            width: 100%;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .select-all-btn:hover {
            background: rgba(var(--primary-color-rgb), 0.15);
            color: var(--primary-light);
            border-color: rgba(var(--primary-light-rgb), 0.3);
        }

        .select-all-btn:active {
            transform: scale(0.98);
        }

        .announcement-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 450px;
            max-width: 90vw;
            max-height: 80vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 16px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .announcement-panel.active {
            display: flex;
        }
        
        .announcement-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .announcement-panel-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-announcement-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .close-announcement-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .announcement-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .announcement-item {
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 4px solid var(--primary-color);
        }
        
        .announcement-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .announcement-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .announcement-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .announcement-text ul {
            margin: 12px 0;
            padding-left: 20px;
        }
        
        .announcement-text li {
            margin-bottom: 6px;
        }
        
        .announcement-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .announcement-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .announcement-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .announcement-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .download-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .download-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .download-file-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            word-break: break-all;
        }
        
        .download-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .download-progress-container {
            position: relative;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .download-progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(76, 201, 240, 0.4);
        }
        
        .download-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .download-percentage {
            font-weight: 500;
            color: var(--primary-light);
        }
        
        .download-controls {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
        }
        
        .download-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .download-btn.cancel {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .download-btn.cancel:hover {
            background: var(--error-color);
            color: white;
        }
        
        .download-btn.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: none;
            color: white;
        }
        
        .download-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .player-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .player-placeholder i {
            font-size: 18px;
            color: var(--primary-light);
        }
        
        .lyrics-panel {
            position: fixed;
            width: 260px;
            max-height: 350px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            z-index: 999;
            display: none;
            flex-direction: column;
            cursor: default;
            resize: both;
            overflow: hidden;
            min-width: 250px;
            min-height: 200px;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }
        
        .lyrics-panel.active {
            display: flex;
        }
        
        .lyrics-drag-handle {
            cursor: move;
            user-select: none;
        }
        
        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            user-select: none;
        }
        
        .lyrics-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lyrics-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lyrics-control-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .lyrics-control-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-light);
        }
        
        .lyrics-content {
            flex: 1;
            overflow-y: auto;
            color: var(--text-secondary);
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            text-align: center;
            padding: 10px;
            transition: all 0.3s;
        }
        
        .lyrics-line {
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: default;
            opacity: 0.7;
            transform: scale(0.95);
            min-height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lyrics-line.active {
            background: var(--lyrics-highlight);
            color: var(--primary-light);
            font-weight: 600;
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.2);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .lyrics-line.past {
            opacity: 0.9;
            color: var(--text-primary);
        }
        
        .lyrics-line.future {
            opacity: 0.6;
        }
        
        .lyrics-line:empty {
            display: none;
        }
        
        .lyrics-source-selector {
            position: relative;
            margin: 0 clamp(4px, 1vw, 8px);
            width: auto;
            display: inline-block;
        }
        
        .lyrics-source-trigger {
            width: auto;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: clamp(5px, 1.5vw, 6px) clamp(10px, 2.5vw, 12px);
            border-radius: 8px;
            font-size: clamp(11px, 2vw, 12px);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            gap: 6px;
            height: 30px;
            box-sizing: border-box;
        }
        
        .lyrics-source-trigger:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-color);
        }
        
        .lyrics-source-trigger.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }
        
        .lyrics-source-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: clamp(120px, 24vw, 150px);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: clamp(4px, 1vw, 6px);
            z-index: 3002;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .playback-rate-selector {
            position: relative;
            margin: 0 clamp(4px, 1vw, 8px);
            display: inline-block;
        }
        
        .playback-rate-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: 100px;
            width: auto;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: clamp(4px, 1vw, 6px);
            z-index: 3002;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px 0;
        }
        
        .playback-rate-dropdown.active {
            display: block;
        }
        
        .playback-rate-option {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 3vw, 16px);
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(11px, 2vw, 12px);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .playback-rate-option:hover {
            background: rgba(var(--primary-color-rgb), 0.2);
            color: var(--primary-light);
        }
        
        .playback-rate-option.active {
            background: rgba(var(--primary-color-rgb), 0.3);
            color: var(--primary-light);
            font-weight: 600;
        }
        
        .lyrics-source-dropdown.active {
            display: block;
        }
        
        .lyrics-source-item {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 3vw, 16px);
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(11px, 2vw, 12px);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .lyrics-source-item:hover {
            background: rgba(var(--primary-color-rgb), 0.2);
            color: var(--primary-light);
        }
        
        .lyrics-source-item.active {
            background: rgba(var(--primary-color-rgb), 0.3);
            color: var(--primary-light);
        }
        
        .lyrics-source-item.loading {
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lyrics-loading-spinner {
            font-size: 10px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #lyricsOpacitySlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(var(--primary-light-rgb), 0.3);
            transition: all 0.3s;
        }
        
        #lyricsOpacitySlider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-light);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(var(--primary-light-rgb), 0.3);
            border: none;
            transition: all 0.3s;
        }
        
        #lyricsOpacitySlider::-webkit-slider-thumb:hover,
        #lyricsOpacitySlider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(var(--primary-light-rgb), 0.5);
        }
        
        .config-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
        }
        
        .config-panel.active {
            display: block;
        }
        
        .config-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .config-input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .config-input[type="number"]::-webkit-outer-spin-button,
        .config-input[type="number"]::-webkit-inner-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }
        
        .config-btn {
            width: 100%;
            padding: 8px;
            background: rgba(var(--primary-color-rgb), 0.3);
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            color: var(--primary-light);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .config-btn:hover {
            background: rgba(var(--primary-color-rgb), 0.5);
        }
        
        .show-lyrics-btn {
            position: fixed;
            bottom: 180px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 998;
            display: none;
        }
        
        .show-lyrics-btn.active {
            display: flex;
        }
        
        .show-lyrics-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary-light);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .preload-info {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid rgba(76, 201, 240, 0.3);
            color: #a5f3fc;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }
        
        .preload-info.active {
            display: block;
        }
        
        .preload-progress {
            margin-top: 12px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .preload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .player-top-bar {
            position: fixed;
            bottom: auto;
            top: 150px;
            display: flex;
            gap: 3px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            padding: 3px;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            transition: left 0.2s, right 0.2s;
            flex-direction: column;
        }

        .player-top-bar.position-left {
            left: 0;
            right: auto;
        }

        .player-top-bar.position-right {
            left: auto;
            right: 0;
        }

        .player-top-bar .toggle-player-btn,
        .player-top-bar .playlist-btn,
        .player-top-bar .hide-player-btn,
        .player-top-bar .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 10px;
            color: var(--text-primary);
            margin: 0;
        }

        .player-top-bar .toggle-player-btn:hover,
        .player-top-bar .playlist-btn:hover,
        .player-top-bar .hide-player-btn:hover,
        .player-top-bar .settings-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .player-top-bar .toggle-player-btn.active i {
            transform: rotate(180deg);
        }

        .toolbar-settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 300px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }

        .toolbar-settings-panel.active {
            display: flex;
        }

        .settings-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .settings-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-settings-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-settings-panel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .settings-panel-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .settings-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .settings-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 60px;
        }

        .settings-option:hover {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-light);
        }

        .settings-option.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            .player-top-bar {
                gap: 4px;
                padding: 4px;
            }
            .player-top-bar .toggle-player-btn,
            .player-top-bar .playlist-btn,
            .player-top-bar .hide-player-btn,
            .player-top-bar .settings-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .playing-animation {
            display: inline-block;
            width: 16px;
            height: 16px;
            position: relative;
        }
        
        .playing-animation span {
            display: inline-block;
            width: 3px;
            height: 100%;
            background: var(--primary-light);
            margin-right: 1px;
            animation: audio-wave 1.2s infinite ease-in-out;
        }
        
        .playing-animation span:nth-child(1) {
            animation-delay: -0.8s;
        }
        
        .playing-animation span:nth-child(2) {
            animation-delay: -0.6s;
        }
        
        .playing-animation span:nth-child(3) {
            animation-delay: -0.4s;
        }
        
        .playing-animation span:nth-child(4) {
            animation-delay: -0.2s;
        }
        
        @keyframes audio-wave {
            0%, 40%, 100% {
                transform: scaleY(0.4);
            }
            20% {
                transform: scaleY(1);
            }
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 120px;
            max-width: 400px;
        }
        
        .volume-slider-embedded {
            flex: 1 1 100px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            min-width: 60px;
        }
        
        .volume-slider {
            width: 100%;
            height: 6px;
            margin: 0;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            flex: 1;
            min-width: 80px;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            border: 2px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-light);
            border: 2px solid rgba(255, 255, 255, 0.8);
            cursor: pointer;
        }
        
        .volume-slider-container::after {
            content: attr(data-volume);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: var(--primary-light);
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .volume-slider-container:hover::after {
            opacity: 1;
        }
        
        .progress-container {
            position: relative;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
        }
        
        .progress-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            width: 0%;
        }
        
        .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .progress-container:hover .progress-handle {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .player-cover {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-cover:hover {
            transform: scale(1.05);
        }
        
        .hidden-audio {
            display: none;
        }
        
        .song-loading {
            opacity: 0.7;
        }
        
        .song-loaded .song-action-btn {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-light);
            border-color: var(--primary-color);
        }
        
        .song-loaded .song-action-btn:hover {
            background: rgba(67, 97, 238, 0.4);
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .status-message i {
            color: var(--primary-light);
        }
        
        .status-message.active {
            transform: translateX(0);
        }
        
        .status-message.success {
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .status-message.error {
            border-color: var(--error-color);
            color: var(--error-color);
        }
        
        .status-message.warning {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .status-message.info {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        @media (max-width: 768px) {
            .status-message {
                top: 10px;
                right: 10px;
                left: auto;
                bottom: auto;
                transform: translateX(150%);
            }
            .status-message.active {
                transform: translateX(0);
            }
        }

        @media (min-width: 1440px) {
            .container {
                max-width: 1600px;
                padding: 30px;
            }
            
            .search-section,
            .results-section {
                padding: 40px;
            }
            
            .floating-player {
                max-width: 1000px;
                padding: 25px;
            }
            
            .player-header {
                gap: 25px;
            }
            
            .player-cover {
                width: 80px;
                height: 80px;
            }
            
            .player-song-title {
                font-size: 18px;
            }
            
            .player-song-artist {
                font-size: 16px;
            }
        }

        @media (min-width: 1200px) and (max-width: 1439px) {
            .container {
                max-width: 1200px;
            }
        }

        @media (min-width: 992px) and (max-width: 1199px) {
            .container {
                max-width: 1000px;
                padding: 25px;
            }
            
            .search-section,
            .results-section {
                padding: 25px;
            }
            
            .search-form {
                grid-template-columns: 1fr 2fr auto;
                gap: 15px;
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            body {
                padding-bottom: 150px;
            }
            
            .container {
                max-width: 800px;
                padding: 20px;
            }
            
            .header {
                flex-direction: row;
                align-items: center;
                gap: 20px;
            }
            
            .logo-text h1 {
                font-size: 24px;
            }
            
            .logo-text p {
                font-size: 13px;
            }
            
            .search-section,
            .results-section {
                padding: 25px;
                min-height: auto;
            }
            
            .search-form {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .search-btn {
                grid-column: 1 / -1;
                justify-self: center;
                width: 200px;
            }
            
            .floating-player {
                width: calc(100% - 30px);
                max-width: 700px;
                padding: 12px;
            }
            
            .player-header {
                gap: 10px;
            }
            
            .player-cover {
                width: 45px;
                height: 45px;
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
            }
            
            .player-song-title {
                font-size: 14px;
                margin-bottom: 2px;
            }
            
            .player-song-artist {
                font-size: 12px;
                margin-bottom: 2px;
            }
            
            .player-lyrics-line {
                font-size: 11px;
                height: 14px;
                margin-top: 2px;
            }
            
            .player-controls {
                gap: 8px;
            }
            
            .control-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .play-btn {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .toggle-player-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .player-expanded {
                padding: 10px 0;
            }
            
            .progress-section {
                margin-bottom: 10px;
            }
            
            .time-display {
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .progress-container {
                height: 5px;
            }
            
            .progress-handle {
                width: 14px;
                height: 14px;
            }
            
            .extra-controls {
                flex-direction: row;
                gap: 10px;
                align-items: center;
                justify-content: space-between;
            }
            
            .secondary-controls {
                gap: 8px;
                flex-wrap: nowrap;
            }
            
            .secondary-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .volume-control {
                min-width: 100px;
                max-width: none;
                gap: 8px;
            }
            
            .volume-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .volume-slider-embedded {
                min-width: 60px;
                padding: 0 8px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .player-expanded {
                padding: 15px 0;
            }
            
            .extra-controls {
                flex-wrap: wrap;
                gap: 20px;
                justify-content: space-around;
            }
            
            .secondary-controls {
                gap: 12px;
            }
            
            .volume-control {
                min-width: 120px;
                max-width: none;
                gap: 12px;
            }
            
            .volume-slider-embedded {
                min-width: 70px;
                padding: 0 10px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .lyrics-panel {
                width: 350px;
                max-height: 350px;
            }
            
            .show-lyrics-btn {
                bottom: 190px;
                right: 25px;
            }
            
            .pagination-controls {
                padding-top: 10px;
                margin-bottom: 0;
            }
            
            .playback-rate-selector {
                display: block;
            }
            
            .lyrics-source-selector {
                display: block;
            }
            
            .opacity-btn {
                display: block;
            }
            
            .download-btn {
                display: block;
            }
            
            .opacity-panel {
                width: 260px;
                padding: 12px;
            }
            
            .opacity-panel-title {
                font-size: 13px;
            }
            
            .opacity-label span {
                font-size: 11px;
            }
            
            .opacity-slider {
                height: 3px;
            }
        }

        @media (min-width: 576px) and (max-width: 767px) {
            body {
                padding-bottom: 120px;
                font-size: 14px;
            }
            
            .container {
                padding: 15px;
                gap: 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                padding: 15px 0;
            }
            
            .logo {
                gap: 10px;
            }
            
            .logo-icon {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .logo-text h1 {
                font-size: 22px;
            }
            
            .logo-text p {
                font-size: 12px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }
            
            .search-section,
            .results-section {
                padding: 20px;
                border-radius: 15px;
                min-height: 500px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 15px;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 15px;
                padding-top: 15px;
            }
            
            .pagination-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .page-btn {
                flex: 1;
                max-width: 140px;
                justify-content: center;
            }
            
            .song-item {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .song-cover {
                width: 60px;
                height: 60px;
            }
            
            .song-title {
                font-size: 16px;
            }
            
            .song-artist {
                font-size: 14px;
            }
            
            .song-album {
                font-size: 13px;
            }
            
            .song-action-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .floating-player {
                width: calc(100% - 20px);
                padding: 10px;
                bottom: 8px;
                border-radius: 10px;
            }
            
            .player-header {
                gap: 8px;
                align-items: center;
            }
            
            .player-cover {
                width: 40px;
                height: 40px;
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
            }
            
            .player-song-title {
                font-size: 13px;
                margin-bottom: 2px;
            }
            
            .player-song-artist {
                font-size: 11px;
                margin-bottom: 2px;
            }
            
            .player-lyrics-line {
                font-size: 10px;
                height: 14px;
                margin-top: 2px;
            }
            
            .player-controls {
                gap: 6px;
            }
            
            .control-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .play-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .toggle-player-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .player-expanded {
                padding: 8px 0;
            }
            
            .progress-section {
                margin-bottom: 8px;
            }
            
            .time-display {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .progress-container {
                height: 4px;
            }
            
            .progress-handle {
                width: 12px;
                height: 12px;
            }
            
            .extra-controls {
                flex-direction: row;
                gap: 8px;
                align-items: center;
                justify-content: space-between;
            }
            
            .secondary-controls {
                gap: 6px;
                flex-wrap: nowrap;
            }
            
            .secondary-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .playback-rate-selector {
                display: block;
            }
            
            .lyrics-source-selector {
                display: block;
            }
            
            .volume-control {
                min-width: 100px;
                max-width: none;
                gap: 6px;
            }
            
            .volume-slider-embedded {
                min-width: 60px;
                padding: 0 6px;
            }
            
            .volume-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .opacity-btn {
                display: block;
            }
            
            .download-btn {
                display: block;
            }
        }

        @media (max-width: 575px) {
            body {
                padding-bottom: 100px;
                font-size: 13px;
            }
            
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            .header {
                padding: 10px 0;
                gap: 12px;
            }
            
            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .logo-text h1 {
                font-size: 20px;
            }
            
            .logo-text p {
                font-size: 11px;
            }
            
            .header-btn {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .search-section,
            .results-section {
                padding: 15px;
                border-radius: 12px;
                min-height: 450px;
            }
            
            .section-title {
                font-size: 16px;
                gap: 8px;
            }
            
            .search-form {
                gap: 12px;
            }
            
            .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .platform-toggle,
            .search-input {
                padding: 12px;
                font-size: 14px;
            }
            
            .search-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .song-item {
                padding: 12px;
                margin-bottom: 10px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .song-cover {
                width: 80px;
                height: 80px;
            }
            
            .song-info {
                width: 100%;
            }
            
            .song-title {
                font-size: 15px;
                margin-bottom: 4px;
            }
            
            .song-artist {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .song-album {
                font-size: 12px;
            }
            
            .song-actions {
                width: 100%;
                justify-content: center;
            }
            
            .song-action-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .floating-player {
                width: calc(100% - 10px);
                padding: 8px;
                bottom: 5px;
                border-radius: 8px;
            }
            
            .player-header {
                gap: 6px;
                align-items: center;
            }
            
            .player-cover {
                width: 36px;
                height: 36px;
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
            }
            
            .player-song-title {
                font-size: 12px;
                margin-bottom: 1px;
            }
            
            .player-song-artist {
                font-size: 10px;
                margin-bottom: 1px;
            }
            
            .player-lyrics-line {
                font-size: 9px;
                height: 12px;
                margin-top: 1px;
            }
            
            .player-controls {
                gap: 4px;
            }
            
            .control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .play-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
            
            .toggle-player-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .player-expanded {
                padding: 6px 0;
            }
            
            .progress-section {
                margin-bottom: 6px;
            }
            
            .time-display {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .progress-container {
                height: 3px;
            }
            
            .progress-handle {
                width: 10px;
                height: 10px;
            }
            
            .extra-controls {
                flex-direction: row;
                gap: 6px;
                align-items: center;
                justify-content: space-between;
            }
            
            .secondary-controls {
                gap: 4px;
                flex-wrap: nowrap;
            }
            
            .secondary-btn {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            
            .playback-rate-selector {
                display: block;
            }
            
            .lyrics-source-selector {
                display: block;
            }
            
            .volume-control {
                min-width: 90px;
                max-width: none;
                gap: 4px;
            }
            
            .volume-slider-embedded {
                min-width: 50px;
                padding: 0 5px;
            }
            
            .volume-btn {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .opacity-btn {
                display: block;
            }
            
            .download-btn {
                display: block;
            }
            
            .opacity-panel {
                width: 240px;
                padding: 10px;
            }
            
            .opacity-panel-title {
                font-size: 12px;
            }
            
            .opacity-label span {
                font-size: 10px;
            }
            
            .opacity-slider {
                height: 2px;
            }
            
            .lyrics-panel {
                width: calc(100% - 30px);
                max-height: 200px;
                right: 15px;
                bottom: 160px;
                padding: 15px;
            }
            
            .show-lyrics-btn {
                bottom: 160px;
                right: 15px;
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .lyrics-line {
                padding: 4px 6px;
                font-size: 11px;
                line-height: 1.5;
            }
        }

        @media (max-width: 479px) {
            body {
                padding-bottom: 90px;
                font-size: 12px;
            }
            
            .container {
                padding: 8px;
                gap: 12px;
            }
            
            .header {
                padding: 8px 0;
                gap: 10px;
            }
            
            .logo-text h1 {
                font-size: 18px;
            }
            
            .logo-text p {
                font-size: 10px;
            }
            
            .search-section,
            .results-section {
                padding: 12px;
                min-height: 400px;
            }
            
            .section-title {
                font-size: 15px;
            }
            
            .platform-toggle,
            .search-input {
                padding: 10px;
                font-size: 13px;
            }
            
            .search-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .page-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .song-item {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .song-cover {
                width: 70px;
                height: 70px;
            }
            
            .song-title {
                font-size: 14px;
            }
            
            .song-artist {
                font-size: 12px;
            }
            
            .song-album {
                font-size: 11px;
            }
            
            .floating-player {
                width: calc(100% - 8px);
                padding: 6px;
                bottom: 4px;
                border-radius: 6px;
            }
            
            .player-header {
                gap: 4px;
                align-items: center;
            }
            
            .player-cover {
                width: 32px;
                height: 32px;
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
            }
            
            .player-song-title {
                font-size: 11px;
                margin-bottom: 1px;
            }
            
            .player-song-artist {
                font-size: 9px;
                margin-bottom: 1px;
            }
            
            .player-lyrics-line {
                font-size: 8px;
                height: 10px;
                margin-top: 1px;
            }
            
            .player-controls {
                gap: 3px;
            }
            
            .control-btn {
                width: 26px;
                height: 26px;
                font-size: 11px;
            }
            
            .play-btn {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
            
            .toggle-player-btn {
                width: 22px;
                height: 22px;
                font-size: 9px;
            }
            
            .player-expanded {
                padding: 4px 0;
            }
            
            .progress-section {
                margin-bottom: 4px;
            }
            
            .time-display {
                font-size: 9px;
                margin-bottom: 3px;
            }
            
            .progress-container {
                height: 4px;
            }
            
            .progress-handle {
                width: 10px;
                height: 10px;
            }
            
            .extra-controls {
                flex-direction: row;
                gap: 4px;
                align-items: center;
                justify-content: space-between;
            }
            
            .secondary-controls {
                gap: 3px;
                flex-wrap: nowrap;
            }
            
            .secondary-btn {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }
            
            .playback-rate-selector {
                display: block;
            }
            
            .lyrics-source-selector {
                display: block;
            }
            
            .volume-control {
                min-width: 80px;
                max-width: none;
                gap: 3px;
            }
            
            .volume-slider-embedded {
                min-width: 45px;
                padding: 0 4px;
            }
            
            .volume-btn {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }
            
            .volume-slider {
                height: 6px;
            }
            
            .opacity-btn {
                display: block;
            }
            
            .download-btn {
                display: block;
            }
            
            .opacity-panel {
                width: 220px;
                padding: 8px;
            }
            
            .opacity-panel-title {
                font-size: 11px;
            }
            
            .opacity-label span {
                font-size: 9px;
            }
            
            .opacity-slider {
                height: 2px;
            }
            
            .lyrics-panel {
                width: calc(100% - 20px);
                max-height: 180px;
                right: 10px;
                bottom: 150px;
                padding: 12px;
            }
            
            .show-lyrics-btn {
                bottom: 150px;
                right: 10px;
                width: 30px;
                height: 30px;
                font-size: 13px;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .song-item:hover {
                transform: none;
                box-shadow: none;
            }
            
            .song-action-btn:hover,
            .header-btn:hover,
            .page-btn:hover,
            .control-btn:hover {
                background: rgba(255, 255, 255, 0.05);
                transform: none;
            }
            
            .progress-handle {
                opacity: 1;
                width: 20px;
                height: 20px;
            }
            
            .volume-slider {
                height: 10px;
            }
            
            .volume-slider::-webkit-slider-thumb {
                width: 22px;
                height: 22px;
            }
            
            .volume-slider::-moz-range-thumb {
                width: 22px;
                height: 22px;
            }
            
            .song-item {
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
            }
            
            .song-action-btn,
            .header-btn,
            .page-btn,
            .control-btn {
                -webkit-tap-highlight-color: rgba(67, 97, 238, 0.2);
            }
            
            .song-action-btn,
            .header-btn,
            .control-btn {
                min-width: 36px;
                min-height: 36px;
            }
            
            .page-btn {
                min-height: 36px;
            }
            
            .results-container {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
            
            .lyrics-content {
                -webkit-overflow-scrolling: touch;
            }

            html {
                -webkit-overflow-scrolling: touch;
            }

            .song-list {
                -webkit-overflow-scrolling: touch;
                overflow-y: auto;
            }
        }

        @media (orientation: portrait) {
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            .volume-control {
                flex-wrap: wrap;
                min-width: 250px;
                max-width: 300px;
            }
            
            .volume-slider-embedded {
                min-width: 60px;
                flex: 1;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .results-section {
                padding: 15px;
                min-height: 50vh;
            }
            
            .floating-player {
                width: calc(100% - 20px);
                padding: 8px;
                bottom: 8px;
                max-height: 35vh;
                overflow-y: auto;
            }
            
            .player-header {
                display: flex;
                flex-direction: column;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .player-header > div:first-child {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .player-cover {
                flex-shrink: 0;
                width: 45px;
                height: 45px;
                border-radius: 8px;
                overflow: hidden;
                background: rgba(255, 255, 255, 0.05);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .player-controls {
                align-self: flex-end;
            }
            
            .player-cover img,
            .player-cover .cover-placeholder {
                width: 45px;
                height: 45px;
                border-radius: 8px;
                object-fit: cover;
            }
            
            .player-cover .cover-placeholder {
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.05);
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .player-controls {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 2px;
            }
            
            .player-lyrics-line {
                font-size: 11px;
                height: 14px;
                margin-top: 2px;
                opacity: 0.8;
            }
            
            .player-song-title {
                font-size: 14px;
                margin-bottom: 2px;
            }
            
            .player-song-artist {
                font-size: 12px;
            }
            
            .control-btn {
                width: 14px;
                height: 14px;
                font-size: 6px;
                padding: 2px;
            }
            
            .play-btn {
                width: 17px;
                height: 17px;
                font-size: 7px;
            }
            
            .toggle-player-btn {
                width: 13px;
                height: 13px;
                font-size: 5px;
            }
            
            .bottom-progress-container {
                height: 3px;
                left: 0;
                right: 0;
                margin-top: 4px;
            }
            
            .bottom-progress-bar {
                height: 100%;
            }
            
            .lyrics-panel {
                width: calc(100% - 30px);
                max-height: 30vh;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                bottom: auto;
                right: auto;
            }
            
            .show-lyrics-btn {
                bottom: 170px;
                right: 20px;
            }
            
            .song-item {
                padding: 15px;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .song-cover {
                width: 100px;
                height: 100px;
                margin-bottom: 10px;
            }
            
            .song-info {
                width: 100%;
            }
            
            .song-actions {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .search-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-btn {
                width: 100%;
                justify-content: center;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .pagination-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                padding: 10px 0;
            }
            
            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }
            
            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .view-toggle {
                margin-left: 0;
            }
            
            .download-panel {
                width: calc(100% - 30px);
                max-width: 90vw;
                padding: 15px;
            }
            
            .announcement-panel {
                width: calc(100% - 30px);
                max-width: 90vw;
                padding: 15px;
            }
        }

        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .logo-icon,
            .song-cover,
            .player-cover {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            .progress-bar,
            .progress-buffer {
                border-radius: 2px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            body {
                padding-bottom: 120px;
            }
            
            .container {
                padding: 10px;
                gap: 15px;
            }
            
            .search-section,
            .results-section {
                padding: 15px;
                min-height: 300px;
            }
            
            .floating-player {
                padding: 10px;
                bottom: 5px;
            }
            
            .player-header {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .player-cover {
                flex-shrink: 0;
                width: 45px;
                height: 45px;
                border-radius: 8px;
                overflow: hidden;
                background: rgba(255, 255, 255, 0.05);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .player-cover img,
            .player-cover .cover-placeholder {
                width: 45px;
                height: 45px;
                border-radius: 8px;
                object-fit: cover;
            }
            
            .player-cover .cover-placeholder {
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(255, 255, 255, 0.05);
            }
            
            .player-info {
                flex: 1;
                min-width: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .player-controls-section {
                display: none;
            }
            
            .player-controls {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .player-lyrics-line {
                font-size: 11px;
                height: 14px;
                margin-top: 2px;
            }
            
            .bottom-progress-container {
                height: 3px;
                left: 0;
                right: 0;
                margin-top: 4px;
            }
            
            .bottom-progress-bar {
                height: 100%;
            }
            
            .playback-rate-selector {
                display: inline-block;
            }
            
            .lyrics-source-selector {
                display: inline-block;
            }
            
            .opacity-btn {
                display: block;
            }
            
            .download-btn {
                display: block;
            }
            
            .lyrics-panel {
                max-height: 150px;
                bottom: 130px;
            }
            
            .show-lyrics-btn {
                bottom: 130px;
            }
        }

        @media print {
            .floating-player,
            .lyrics-panel,
            .show-lyrics-btn,
            .header-controls {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
                padding-bottom: 0 !important;
            }
            
            .search-section,
            .results-section {
                background: white !important;
                color: black !important;
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }

        .touch-device .control-btn,
        .touch-device .song-item {
            min-height: 35px !important;
            min-width: 35px !important;
        }
        
        .mobile-device .floating-player {
            position: fixed;
            z-index: 1000;
        }
        
        .high-dpi .song-cover,
        .high-dpi .player-cover {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        .mobile-layout .header {
            flex-direction: column;
            gap: 15px;
        }
        
        .mobile-layout .search-form {
            grid-template-columns: 1fr;
        }
        
        .mobile-device .player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            flex-shrink: 0;
        }
        
        .mobile-device .control-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-device .toggle-player-btn {
            width: 36px;
            height: 36px;
            font-size: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-device .player-header {
            flex-direction: row;
            gap: 10px;
            align-items: center;
            text-align: left;
        }
        
        .mobile-device .player-cover {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
        }
        
        .mobile-device .player-info {
            flex: 1;
            min-width: 0;
        }
        
        .mobile-device .player-controls {
            flex-shrink: 0;
            width: auto;
            justify-content: flex-end;
        }
        
        .mobile-device .bottom-progress-container {
            height: 4px;
            left: 0;
            right: 0;
            margin-top: 6px;
        }
        
        .mobile-device .bottom-progress-bar {
            height: 100%;
        }
        
        .mobile-device .player-expanded {
            padding: 15px;
        }
        
        .mobile-device .extra-controls {
            flex-direction: column;
            gap: 15px;
        }
        
        .mobile-device .secondary-controls {
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        
        .mobile-device .volume-control {
            width: 100%;
            max-width: none;
        }
        
        .mobile-device .volume-slider-embedded {
            min-width: 50px;
            padding: 0 8px;
        }
        
        .mobile-device .secondary-btn {
            padding: 8px 12px;
            font-size: 12px;
            min-height: 35px;
            min-width: 35px;
        }
        
        .tablet-layout .grid-view .song-list {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important; 
            }
        }
        
        @media (pointer: coarse) {
            a, button {
                touch-action: manipulation;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(env(safe-area-inset-bottom) + 140px);
            }
            
            .floating-player {
                bottom: calc(10px + env(safe-area-inset-bottom));
                width: calc(100% - 20px);
                left: 50%;
                transform: translateX(-50%);
                padding: 15px;
            }
            
            @media (orientation: portrait) {
                .player-header {
                    flex-direction: row;
                    align-items: center;
                    justify-content: space-between;
                    gap: 8px;
                    padding: 8px 12px;
                }
                
                .player-cover {
                    flex-shrink: 0;
                    width: 45px;
                    height: 45px;
                    border-radius: 8px;
                    overflow: hidden;
                    background: rgba(255, 255, 255, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .player-cover img,
                .player-cover .cover-placeholder {
                    width: 45px;
                    height: 45px;
                    border-radius: 8px;
                    object-fit: cover;
                }
                
                .player-cover .cover-placeholder {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(255, 255, 255, 0.05);
                }
                
                .player-info {
                    flex: 1;
                    min-width: 0;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    width: 100%;
                }
                
                .player-controls {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
            }
            
            @media (orientation: landscape) {
                .floating-player {
                    padding: 10px;
                }
                
                .player-header {
                    flex-direction: row;
                    align-items: center;
                    justify-content: space-between;
                    gap: 10px;
                }
                
                .player-cover {
                    flex-shrink: 0;
                    width: 45px;
                    height: 45px;
                    border-radius: 8px;
                    overflow: hidden;
                    background: rgba(255, 255, 255, 0.05);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .player-cover img,
                .player-cover .cover-placeholder {
                    width: 45px;
                    height: 45px;
                    border-radius: 8px;
                    object-fit: cover;
                }
                
                .player-cover .cover-placeholder {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(255, 255, 255, 0.05);
                }
                
                .player-info {
                    flex: 1;
                    min-width: 0;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }
                
                .player-controls {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }
                
                .player-song-title {
                    font-size: 14px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                
                .player-song-artist {
                    font-size: 12px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
            }
        }

        @media (orientation: portrait) {
            .floating-player .player-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .floating-player .player-cover {
                width: 50px;
                height: 50px;
                flex-shrink: 0;
                order: 1;
            }

            .floating-player .player-info {
                flex: 1;
                min-width: 0;
                order: 2;
            }

            .floating-player .player-controls {
                flex: 1 0 100%;
                order: 3;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                margin-top: 5px;
            }

            .floating-player .player-controls .control-btn {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .floating-player .player-controls .play-btn {
                width: 52px;
                height: 52px;
                font-size: 22px;
            }

            .floating-player .player-controls .toggle-player-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .floating-player .bottom-progress-container {
                display: block;
                margin-top: 6px;
                height: 4px;
            }

            .floating-player .player-expanded {
                padding-top: 10px;
            }

            @media (max-width: 480px) {
                .floating-player .player-controls {
                    gap: 8px;
                }
                .floating-player .player-controls .control-btn {
                    width: 38px;
                    height: 38px;
                    font-size: 16px;
                }
                .floating-player .player-controls .play-btn {
                    width: 46px;
                    height: 46px;
                    font-size: 20px;
                }
            }
        }

        .playlist-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 280px;
            max-width: 90vw;
            max-height: 70vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            z-index: 3000;
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: panelSlideIn 0.3s ease forwards;
            outline: none;
            transition: backdrop-filter 0.3s ease, background-color 0.3s ease;
        }

        .playlist-panel.active {
            display: flex;
        }

        .playlist-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }

        .playlist-panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-panel-title i {
            color: var(--primary-light);
        }

        .close-playlist-panel {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-playlist-panel:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-panel-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clear-playlist-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .clear-playlist-btn:hover {
            color: var(--error-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 5px;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-item:hover {
            background: rgba(67, 97, 238, 0.1);
            border-color: rgba(76, 201, 240, 0.3);
            transform: translateX(3px);
        }

        .playlist-item.active {
            background: rgba(67, 97, 238, 0.2);
            border-color: var(--primary-color);
        }

        .playlist-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .playlist-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-remove-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .playlist-item:hover .playlist-remove-btn {
            opacity: 1;
        }

        .playlist-remove-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--error-color);
        }

        .playlist-empty {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .playlist-empty i {
            font-size: 40px;
            margin-bottom: 10px;
            color: rgba(148, 163, 184, 0.3);
        }

        .playlist-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
            margin-left: 5px;
        }

        .playlist-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.5);
        }

        .playlist-btn i {
            transition: transform 0.3s;
        }

        @media (max-width: 768px) {
            .playlist-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .playlist-panel {
                width: 280px;
                padding: 15px;
            }
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: .3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .fullscreen-player {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
            color: var(--text-primary);
        }

        .fullscreen-player.active {
            display: flex;
            opacity: 1;
        }

        .close-fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
            transition: all 0.3s;
        }

        .close-fullscreen-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .fullscreen-layout {
            flex: 1;
            display: flex;
            flex-direction: row;
            height: calc(100% - 150px);
            padding: 60px 20px 20px 20px;
            overflow: hidden;
        }

        .fullscreen-left {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .fullscreen-cover {
            width: 80%;
            max-width: 300px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .fullscreen-cover img {
            width: 100%;
            height: auto;
            display: block;
        }

        .fullscreen-info {
            text-align: center;
        }

        .fullscreen-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .fullscreen-artist {
            font-size: 18px;
            color: var(--text-secondary);
        }

        .fullscreen-right {
            flex: 0 0 60%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
            border-left: 1px solid var(--border-color);
        }

        .fullscreen-lyrics {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            font-size: 16px;
            line-height: 2;
            text-align: left;
            color: var(--text-secondary);
            scroll-behavior: smooth;
        }

        .fullscreen-lyrics .lyrics-line {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            opacity: 0.8;
            transform: scale(0.98);
            cursor: default;
            border-left: 3px solid transparent;
        }

        .fullscreen-lyrics .lyrics-line.active {
            background: var(--lyrics-highlight);
            color: var(--primary-light);
            font-weight: 600;
            opacity: 1;
            transform: scale(1);
            border-left-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(76, 201, 240, 0.2);
        }

        .fullscreen-lyrics .lyrics-line.past {
            opacity: 0.6;
            color: var(--text-primary);
        }

        .fullscreen-bottom {
            height: 150px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .fullscreen-progress {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
        }

        .fullscreen-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
        }

        .fullscreen-controls .control-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .fullscreen-controls .play-btn {
            width: 70px;
            height: 70px;
            font-size: 28px;
        }

        .fullscreen-progress .time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .fullscreen-progress .progress-container {
            position: relative;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }

        .fullscreen-progress .progress-bar {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .fullscreen-progress .progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .fullscreen-progress .progress-container:hover .progress-handle {
            opacity: 1;
        }

        .fullscreen-controls .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fullscreen-controls .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .fullscreen-layout {
                flex-direction: column;
                padding: 50px 10px 10px;
            }
            .fullscreen-left {
                flex: 0 0 auto;
                max-height: 40vh;
            }
            .fullscreen-right {
                flex: 1;
                border-left: none;
                border-top: 1px solid var(--border-color);
                padding: 10px 0;
            }
            .fullscreen-cover {
                width: 50%;
            }
            .fullscreen-title {
                font-size: 20px;
            }
            .fullscreen-artist {
                font-size: 16px;
            }
            .fullscreen-lyrics {
                font-size: 14px;
                line-height: 1.8;
            }
        }
    </style>
</head>
<body>
    <!-- 背景层 -->
    <div class="background-layer" id="backgroundLayer"></div>

    <!-- 烟花效果画布（置于背景与内容之间） -->
    <canvas id="fireworksCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;"></canvas>

    <!-- 首页 -->
    <div class="page-container active" id="home-page">
        <div class="container">
            <!-- 头部区域 -->
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="logo-text">
                        <h1>零柒零音乐 0.2.2<span class="beta-badge">Beta</span></h1>
                        <p>更好的音乐搜索与播放体验</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="header-btn" id="announcementBtn" title="公告">
                        <i class="fas fa-bullhorn"></i>
                        <span class="notification-badge" id="announcementBadge">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索页 -->
    <div class="page-container" id="search-page">
        <div class="container">
            <!-- 搜索区域 -->
            <div class="search-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-search"></i> 搜索音乐
                    </h2>
                    <div class="page-info">
                        第 <span id="currentPage" class="page-number">1</span> 页
                    </div>
                </div>

                <div class="search-form">
                    <div class="form-group platform-selector">
                        <div class="form-label"><i class="fas fa-music"></i> 音乐平台</div>
                        <div class="platform-toggle" id="platformToggle">
                            <div class="platform-name">
                                <div class="platform-icon">
                                    <i class="fab fa-napster"></i>
                                </div>
                                <span>网易云音乐</span>
                            </div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="platform-dropdown" id="platformDropdown">
                            <div class="platform-option active" data-value="wy">
                                <i class="fab fa-napster"></i>
                                <span>网易云音乐</span>
                            </div>
                            <div class="platform-option" data-value="qq">
                                <i class="fab fa-qq"></i>
                                <span>QQ音乐</span>
                            </div>
                            <div class="platform-option" data-value="kw">
                                <i class="fas fa-headphones"></i>
                                <span>酷我音乐</span>
                            </div>
                            <div class="platform-option" data-value="mg">
                                <i class="fas fa-mobile-alt"></i>
                                <span>咪咕音乐</span>
                            </div>
                            <div class="platform-option" data-value="qi">
                                <i class="fas fa-play-circle"></i>
                                <span>千千音乐</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i class="fas fa-headphones-alt"></i> 歌曲名称或歌手</div>
                        <div class="search-input-container">
                            <input type="text" class="search-input" id="songName" placeholder="输入歌曲名或歌手名...">
                            <button class="search-input-btn" id="searchInputBtn" title="搜索">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-label"><i class="fas fa-fire"></i> 每日推荐</div>
                        <div class="quick-actions">
                            <button class="recommend-btn" id="recommendBtn">
                                <i class="fas fa-fire"></i> 每日推荐
                            </button>
                        </div>
                    </div>
                </div>

                <div class="history-section" id="historySection" style="display: none;">
                    <div class="history-header">
                        <span class="history-title"><i class="fas fa-history"></i> 最近搜索</span>
                        <button class="history-clear-btn" id="clearHistoryBtn" title="清空历史记录"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="history-list" id="historyList"></div>
                </div>

                <div class="pagination-controls">
                    <div class="pagination-buttons">
                        <button class="page-btn" id="prevPageBtn" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <button class="page-btn" id="nextPageBtn" disabled>
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">正在搜索音乐，请稍候...</p>
                </div>

                <div class="preload-info" id="preloadInfo">
                    <p><i class="fas fa-sync-alt"></i> 正在加载歌曲信息...</p>
                    <div class="preload-progress">
                        <div class="preload-progress-bar" id="preloadProgressBar"></div>
                    </div>
                    <p id="preloadStatus" style="margin-top: 8px; font-size: 0.9rem;">0/0 已加载</p>
                </div>

                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- 搜索结果区域 -->
            <div class="results-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-list"></i> 搜索结果
                    </h2>
                    <div class="results-count">
                        <span>已加载 <span id="loadedSongCount">0</span> 首歌曲</span>
                    </div>
                </div>

                <div class="results-container">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-music"></i>
                        <h3>搜索结果显示在这里</h3>
                        <p>输入关键词并点击搜索按钮开始搜索</p>
                    </div>

                    <ul class="song-list" id="songList">
                        <!-- 歌曲列表将动态插入 -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 个人中心页 -->
    <div class="page-container" id="profile-page">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="logo-text">
                        <h1>个人中心</h1>
                        <p>我的音乐空间</p>
                    </div>
                </div>
            </div>

            <div class="search-section" style="min-height: auto;">
                <div class="profile-info">
                    <div class="profile-avatar">
                        <div class="avatar-container">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h2 class="profile-name" id="profileName">音乐爱好者</h2>
                            <p class="profile-id" id="profileId">ID: 000001</p>
                        </div>
                    </div>

                    <div class="account-info">
                        <h3 class="info-title">
                            <i class="fas fa-info-circle"></i> 账户信息
                        </h3>
                        <div class="info-item">
                            <span class="info-label">会员状态</span>
                            <span class="info-value active">免费会员</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">注册时间</span>
                            <span class="info-value">2026-01-01</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">上次登录</span>
                            <span class="info-value" id="lastLoginTime">刚刚</span>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <h3 class="info-title">
                            <i class="fas fa-chart-bar"></i> 听歌统计
                        </h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="totalPlayCount">0</div>
                                <div class="stat-label">总播放次数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalPlayTime">0</div>
                                <div class="stat-label">总播放时长(分钟)</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="favoriteCount">0</div>
                                <div class="stat-label">收藏歌曲</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="downloadCount">0</div>
                                <div class="stat-label">下载歌曲</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置页 -->
    <div class="page-container" id="settings-page">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="logo-text">
                        <h1>设置</h1>
                        <p>个性化你的音乐体验</p>
                    </div>
                </div>
            </div>

            <div class="search-section" style="min-height: auto;">
                <div class="section-header" style="margin-top: 0;">
                    <h2 class="section-title">
                        <i class="fas fa-key"></i> API 授权
                    </h2>
                    <a href="https://yunzhiapi.cn/user" target="_blank" style="color: var(--primary-light); font-size: 14px; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> 获取Token
                    </a>
                </div>
                <div class="settings-group">
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>云智API Token</span>
                        </div>
                        <input type="text" class="config-input" id="yunzhiTokenInput" 
                               placeholder="请输入你的云智API Token" value="">
                        <button class="config-btn" id="saveYunzhiTokenBtn" style="margin-top: 8px;">保存Token</button>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 15px;">
                    <h2 class="section-title"><i class="fas fa-search"></i> 搜索设置</h2>
                </div>
                <div class="settings-group">
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>每页搜索数量</span>
                        </div>
                        <input type="number" class="config-input" id="pageSizeInput" min="1" max="50" value="20" step="1" style="width: 100%;">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">设置每页显示的歌曲数量（1-20）</p>
                    </div>
                    <div class="settings-item" style="flex-direction: row; align-items: center; justify-content: space-between; margin-top: 15px;">
                        <span class="settings-label">启用搜索记录</span>
                        <label class="switch">
                            <input type="checkbox" id="historyToggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <div class="section-header collapsible-header" id="opacitySectionHeader">
                    <h2 class="section-title">
                        <i class="fas fa-adjust"></i> 透明度设置
                    </h2>
                    <button class="collapse-btn" id="toggleOpacitySection">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="settings-group collapse-content collapsed" id="opacitySectionContent">
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>播放器透明度</span>
                            <span class="settings-value" id="playerOpacityValue">100%</span>
                        </div>
                        <input type="range" min="20" max="100" value="100" class="settings-slider" id="playerOpacitySlider">
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>文本透明度</span>
                            <span class="settings-value" id="textOpacityValue">100%</span>
                        </div>
                        <input type="range" min="20" max="100" value="100" class="settings-slider" id="textOpacitySlider">
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>工具栏透明度</span>
                            <span class="settings-value" id="toolbarOpacityValue">100%</span>
                        </div>
                        <input type="range" min="20" max="100" value="100" class="settings-slider" id="toolbarOpacitySlider">
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <span>导航栏透明度</span>
                            <span class="settings-value" id="navbarOpacityValue">100%</span>
                        </div>
                        <input type="range" min="20" max="100" value="100" class="settings-slider" id="navbarOpacitySlider">
                    </div>
                </div>

                <div class="section-header" style="margin-top: 15px;">
                    <h2 class="section-title">
                        <i class="fas fa-arrows-alt-h"></i> 工具栏位置
                    </h2>
                </div>
                <div class="settings-group">
                    <div class="settings-options">
                        <button class="settings-option-btn" data-position="left">左侧</button>
                        <button class="settings-option-btn" data-position="right">右侧</button>
                    </div>
                </div>

                <div class="section-header collapsible-header" id="bgSectionHeader">
                    <h2 class="section-title">
                        <i class="fas fa-image"></i> 背景设置
                    </h2>
                    <button class="collapse-btn" id="toggleBgSection">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="settings-group collapse-content collapsed" id="bgSectionContent">
                    <div class="settings-item" style="flex-direction: row; align-items: center; justify-content: space-between;">
                        <span class="settings-label">显示背景</span>
                        <label class="switch">
                            <input type="checkbox" id="backgroundToggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="settings-item" style="margin-top: 15px;">
                        <span class="settings-label" style="display: block; margin-bottom: 8px;"></span>
                        <input type="text" id="urlWallpaperInput" placeholder="输入图片URL" style="width: 100%; padding: 8px 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 12px; margin-bottom: 8px;">
                        <button class="config-btn" id="applyUrlWallpaperBtn">应用URL背景</button>
                    </div>
                    <div class="settings-item">
                        <button class="config-btn" id="localWallpaperBtn">选择本地壁纸</button>
                        <input type="file" id="wallpaperFileInput" accept="image/*" style="display: none;">
                        <button class="config-btn" id="resetWallpaperBtn" style="margin-top: 8px;">恢复默认背景</button>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 15px;">
                    <h2 class="section-title">
                        <i class="fas fa-palette"></i> 主题设置
                    </h2>
                </div>
                <div class="settings-group">
                    <div class="settings-options">
                        <button class="settings-option-btn theme-option" data-theme="default">默认主题</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 播放器顶部工具栏（播放列表 + 展开/收起） -->
    <div class="player-top-bar" id="playerTopBar">
        <button class="hide-player-btn" id="togglePlayerVisibilityBtn" title="隐藏播放器">
            <i class="fas fa-eye-slash"></i>
        </button>
        <button class="toggle-player-btn" id="togglePlayerBtn" title="展开/收起">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="playlist-btn" id="playlistBtn" title="播放列表">
            <i class="fas fa-list"></i>
        </button>
    </div>

    <!-- 悬浮播放器 -->
    <div class="floating-player" id="floatingPlayer">
        <div class="player-header">
            <div class="player-cover">
                <div class="cover-placeholder">
                    <i class="fas fa-music"></i>
                </div>
                <img id="playerAlbumArt" src="" alt="专辑封面">
            </div>
            
            <div class="player-info">
                <div class="player-song-title" id="playerTitle">未选择歌曲</div>
                <div class="player-song-artist" id="playerArtist">--</div>
                <!-- 新增：播放器歌词行 -->
                <div class="player-lyrics-line" id="playerLyricsLine"></div>
                
                <!-- 底部进度条 -->
                <div class="bottom-progress-container" id="bottomProgressContainer">
                    <div class="bottom-progress-bar" id="bottomProgressBar"></div>
                </div>
            </div>
            
            <div class="player-controls">
                <button class="control-btn" id="prevBtn" title="上一曲">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-btn" id="playPauseBtn" title="播放/暂停">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn" title="下一曲">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>
        </div>
        
        <div class="player-expanded" id="playerExpanded">
            <div class="progress-section">
                <div class="time-display">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-buffer" id="progressBuffer"></div>
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-handle" id="progressHandle"></div>
                </div>
            </div>
            
            <div class="extra-controls">
                <div class="secondary-controls">
                    <button class="secondary-btn" id="playModeBtn" title="播放模式">
                        <i class="fas fa-retweet"></i>
                    </button>
                    <!-- 播放速度选择器 - 菜单式 -->
                    <div class="playback-rate-selector" id="playbackRateSelector">
                        <button class="secondary-btn playback-rate-trigger" id="playbackRateBtn" title="播放速度">
                            <span id="playbackRateText">1x</span>
                            <i class="fas fa-chevron-up" style="font-size: 10px; margin-left: 5px;"></i>
                        </button>
                    </div>
                    <!-- 歌词来源选择器 -->
                    <div class="lyrics-source-selector" id="lyricsSourceSelector">
                        <div class="lyrics-source-trigger" id="lyricsSourceTrigger">
                            <span id="lyricsSourceText" style="font-size: 12px;">选择歌词源</span>
                            <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                        </div>
                        <div class="lyrics-source-dropdown" id="lyricsSourceDropdown">
                            <!-- 歌词源选项将动态添加 -->
                        </div>
                    </div>
                    
                    <button class="secondary-btn" id="downloadBtn" title="下载歌曲">
                        <i class="fas fa-download"></i>
                    </button>

                    <div class="volume-control">
                        <button class="volume-btn" id="volumeBtn" title="音量">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div class="volume-slider-embedded">
                            <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 面板背景遮罩 -->
    <div class="panel-overlay" id="panelOverlay"></div>

    <!-- 下载选项面板 -->
    <div class="download-options-panel" id="downloadOptionsPanel">
        <div class="download-options-panel-header">
            <div class="download-options-panel-title">下载选项</div>
            <button class="close-download-options-panel" id="closeDownloadOptionsPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="download-options-content">
            <div class="download-options-info">
                <div class="download-options-song-name" id="downloadOptionsSongName">歌曲名称</div>
                <div class="download-options-song-artist" id="downloadOptionsSongArtist">艺术家</div>
            </div>
            <div class="download-options-select-all">
                <button class="select-all-btn" id="selectAllBtn">
                    <i class="fas fa-check-double"></i> 全选
                </button>
            </div>
            <div class="download-options-list">
                <label class="download-option-item">
                    <input type="checkbox" id="downloadSongCheckbox" checked>
                    <span class="custom-checkbox"><i class="fas fa-check"></i></span>
                    <span class="download-option-label">
                        <i class="fas fa-music"></i> 歌曲文件
                    </span>
                </label>
                <label class="download-option-item">
                    <input type="checkbox" id="downloadLyricsCheckbox">
                    <span class="custom-checkbox"><i class="fas fa-check"></i></span>
                    <span class="download-option-label">
                        <i class="fas fa-file-alt"></i> 歌词文件
                    </span>
                </label>
                <label class="download-option-item">
                    <input type="checkbox" id="downloadCoverCheckbox">
                    <span class="custom-checkbox"><i class="fas fa-check"></i></span>
                    <span class="download-option-label">
                        <i class="fas fa-image"></i> 歌曲封面
                    </span>
                </label>
            </div>
            <div class="download-options-controls">
                <button class="download-options-btn cancel" id="cancelDownloadOptionsBtn">取消</button>
                <button class="download-options-btn confirm" id="packageDownloadBtnPanel">打包下载</button>
                <button class="download-options-btn confirm" id="confirmDownloadBtn">开始下载</button>
            </div>
        </div>
    </div>

    <!-- 下载进度面板 -->
    <div class="download-panel" id="downloadPanel">
        <div class="download-panel-header">
            <div class="download-panel-title">下载进度</div>
            <button class="close-download-panel" id="closeDownloadPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="download-content">
            <div class="download-info">
                <div class="download-file-name" id="downloadFileName">准备下载...</div>
                <div class="download-status" id="downloadStatus">等待中</div>
            </div>
            <div class="download-progress-container">
                <div class="download-progress-bar" id="downloadProgressBar"></div>
            </div>
            <div class="download-stats">
                <span class="download-percentage" id="downloadPercentage">0%</span>
                <span class="download-speed" id="downloadSpeed">0 KB/s</span>
                <span class="download-size" id="downloadSize">0 MB / 0 MB</span>
            </div>
            <div class="download-controls">
                <button class="download-btn cancel" id="cancelDownloadBtn">取消下载</button>
            </div>
        </div>
    </div>

    <!-- 公告面板 -->
    <div class="announcement-panel" id="announcementPanel">
        <div class="announcement-panel-header">
            <div class="announcement-panel-title">最新公告</div>
            <button class="close-announcement-panel" id="closeAnnouncementPanel">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="announcement-content">
            <div class="announcement-item">
                <div class="announcement-date">2026-02-16</div>
                <div class="announcement-title">新年快乐！</div>
                <div class="announcement-text">
                    本次更新内容：
                    <ul>
                        <li>更名为零柒零音乐</li>
                        <li>完善了一些功能</li>
                        <li>修复了一些问题</li>
                        <li>增加了一些新功能</li>
                    </ul>
                </div>
            </div>
            <div class="announcement-item">
                <div class="announcement-date">2026-01-31</div>
                <div class="announcement-title">JokingMusic 0.2.1 Beta 版本更新</div>
                <div class="announcement-text">
                    本次更新内容：
                    <ul>
                        <li>优化下载功能</li>
                        <li>提高了搜索速度和稳定性</li>
                        <li>增加了公告功能</li>
                    </ul>
                </div>
            </div>
            <div class="announcement-item">
                <div class="announcement-date">2026-01-09</div>
                <div class="announcement-title">JokingMusic 0.2 Beta 版本发布</div>
                <div class="announcement-text">
                    欢迎使用 JokingMusic 0.2 Beta 版本！
                    <br><br>
                    <strong>本次更新亮点：</strong>
                    <ul>
                        <li>全新播放器 UI：更现代、更沉浸手</li>
                        <li>API 调用深度优化：搜索更快、结果更准</li>
                    </ul>
                    <br>
                    感谢一路有你，继续听歌，继续快乐！🎧
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- 歌词面板 - 修改：支持拖动 -->
    <div class="lyrics-panel" id="lyricsPanel" style="display: none;">
        <div class="lyrics-header" id="lyricsDragHandle">
            <div class="lyrics-title">
                <i class="fas fa-file-alt"></i> 歌词
                <span id="lyricsSourceBadge" style="font-size: 12px; opacity: 0.7; margin-left: 5px;"></span>
            </div>
            <div class="lyrics-controls">
                <!-- 佳欣歌词API配置区域 -->
                <div class="config-panel" id="jiaxinConfigPanel">
                    <div class="config-title">
                        <i class="fas fa-key"></i> 佳欣歌词API Key
                    </div>
                    <input type="text" class="config-input" id="jiaxinApiKey" placeholder="输入API Key，如：9024401e275f939d">
                    <button class="config-btn" id="saveJiaxinKeyBtn">保存</button>
                </div>
                <!-- 歌词透明度调节 - 改为按钮触发 -->
                <div style="position: relative; margin: 0 10px;">
                    <button class="lyrics-control-btn" id="toggleOpacityBtn" title="调整透明度">
                        <i class="fas fa-adjust"></i>
                    </button>
                    <!-- 透明度滑块容器，初始隐藏 -->
                    <div id="opacitySliderContainer" style="position: absolute; top: 100%; right: 0; margin-top: 5px; display: none; background: rgba(15, 23, 42, 0.95); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); z-index: 1001;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-adjust" style="font-size: 12px; color: var(--text-secondary);"></i>
                            <input type="range" id="lyricsOpacitySlider" min="30" max="100" value="95" style="width: 100px; height: 4px; -webkit-appearance: none; appearance: none; background: rgba(255, 255, 255, 0.1); border-radius: 2px; outline: none;" title="调整透明度">
                            <span id="opacityValue" style="font-size: 12px; color: var(--text-secondary); min-width: 30px; text-align: right;">95%</span>
                        </div>
                    </div>
                </div>
                <button class="lyrics-control-btn" id="closeLyricsBtn" title="关闭歌词面板">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="lyrics-content" id="playerLyrics">
            歌词将在此显示...
        </div>
    </div>
    
    <!-- 显示歌词按钮 -->
    <button class="show-lyrics-btn" id="showLyricsBtn" title="显示歌词" style="display: none;">
        <i class="fas fa-file-alt"></i>
    </button>
    
    <!-- 状态消息 -->
    <div class="status-message" id="statusMessage">
        <i class="fas fa-info-circle"></i>
        <span id="statusText">消息内容</span>
    </div>

    <!-- 隐藏的音频元素 -->
    <div class="hidden-audio">
        <audio id="audioPlayer" preload="metadata" crossorigin="anonymous" playsinline></audio>
        <audio id="audioPreloader" preload="auto" crossorigin="anonymous" playsinline style="display:none;"></audio>
    </div>

    <!-- 全屏沉浸式播放界面（左侧封面 + 右侧歌词） -->
    <div class="fullscreen-player" id="fullscreenPlayer">
        <button class="close-fullscreen-btn" id="closeFullscreenBtn"><i class="fas fa-times"></i></button>
        
        <div class="fullscreen-layout">
            <!-- 左侧：封面 -->
            <div class="fullscreen-left">
                <div class="fullscreen-cover">
                    <img id="fullscreenAlbumArt" src="" alt="专辑封面">
                </div>
                <div class="fullscreen-info">
                    <div class="fullscreen-title" id="fullscreenTitle">--</div>
                    <div class="fullscreen-artist" id="fullscreenArtist">--</div>
                </div>
            </div>
            
            <!-- 右侧：歌词 -->
            <div class="fullscreen-right">
                <div class="fullscreen-lyrics" id="fullscreenLyrics">
                    <!-- 歌词将动态插入 -->
                </div>
            </div>
        </div>
        
        <!-- 底部控制区 -->
        <div class="fullscreen-bottom">
            <div class="fullscreen-progress">
                <div class="time-display">
                    <span id="fullscreenCurrentTime">00:00</span>
                    <span id="fullscreenTotalTime">00:00</span>
                </div>
                <div class="progress-container" id="fullscreenProgressContainer">
                    <div class="progress-bar" id="fullscreenProgressBar"></div>
                    <div class="progress-handle" id="fullscreenProgressHandle"></div>
                </div>
            </div>
            <div class="fullscreen-controls">
                <button class="control-btn" id="fullscreenPrevBtn"><i class="fas fa-step-backward"></i></button>
                <button class="control-btn play-btn" id="fullscreenPlayPauseBtn"><i class="fas fa-play"></i></button>
                <button class="control-btn" id="fullscreenNextBtn"><i class="fas fa-step-forward"></i></button>
            </div>
        </div>
    </div>

    <script>
        const deviceInfo = {
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            isTablet: /iPad|Android(?!.*Mobile)|Tablet/i.test(navigator.userAgent),
            isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            screenWidth: window.innerWidth,
            screenHeight: window.innerHeight,
            pixelRatio: window.devicePixelRatio || 1,
            isPortrait: window.innerHeight > window.innerWidth
        };

        function applyDeviceOptimizations() {
            if (deviceInfo.isTouchDevice) {
                document.body.classList.add('touch-device');
                
                const touchElements = document.querySelectorAll('button, .song-item, .control-btn');
                touchElements.forEach(el => {
                    el.style.minHeight = '35px';
                    el.style.minWidth = '35px';
                });
            }
            
            if (deviceInfo.isMobile) {
                document.body.classList.add('mobile-device');
                
                const style = document.createElement('style');
                style.textContent = `
                    @media (hover: none) {
                        .song-item:hover, .control-btn:hover {
                            transform: none !important;
                            box-shadow: none !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            if (deviceInfo.isTablet) {
                document.body.classList.add('tablet-device');
            }
            
            if (deviceInfo.pixelRatio >= 2) {
                document.body.classList.add('high-dpi');
            }
        }
        
        function handleResize() {
            deviceInfo.screenWidth = window.innerWidth;
            deviceInfo.screenHeight = window.innerHeight;
            deviceInfo.isPortrait = window.innerHeight > window.innerWidth;
            
            if (deviceInfo.screenWidth <= 768) {
                document.body.classList.add('mobile-layout');
                document.body.classList.remove('tablet-layout', 'desktop-layout');
            } else if (deviceInfo.screenWidth <= 1024) {
                document.body.classList.add('tablet-layout');
                document.body.classList.remove('mobile-layout', 'desktop-layout');
            } else {
                document.body.classList.add('desktop-layout');
                document.body.classList.remove('mobile-layout', 'tablet-layout');
            }
            
            if (deviceInfo.isPortrait) {
                document.body.classList.add('portrait-device');
                document.body.classList.remove('landscape-device');
                
                if (lyricsPanel) {
                    lyricsPanel.style.top = '10px';
                    lyricsPanel.style.left = '50%';
                    lyricsPanel.style.transform = 'translateX(-50%)';
                    lyricsPanel.style.bottom = 'auto';
                    lyricsPanel.style.right = 'auto';
                    lyricsPanel.style.width = 'calc(100% - 30px)';
                    lyricsPanel.style.maxHeight = '30vh';
                }
                
                if (showLyricsBtn) {
                    showLyricsBtn.style.bottom = '170px';
                    showLyricsBtn.style.right = '20px';
                }
            } else {
                document.body.classList.add('landscape-device');
                document.body.classList.remove('portrait-device');
                
                if (lyricsPanel) {
                    lyricsPanel.style.top = '50%';
                    lyricsPanel.style.left = '50%';
                    lyricsPanel.style.transform = 'translate(-50%, -50%)';
                    lyricsPanel.style.width = '300px';
                    lyricsPanel.style.maxHeight = '400px';
                }
                
                if (showLyricsBtn) {
                    showLyricsBtn.style.bottom = '180px';
                    showLyricsBtn.style.right = '20px';
                }
            }
        }

        function updatePlayerVisibilityButtonState() {
            const isVisible = floatingPlayer.style.display !== 'none';
            const togglePlayerVisibilityBtn = document.getElementById('togglePlayerVisibilityBtn');
            if (togglePlayerVisibilityBtn) {
                if (isVisible) {
                    togglePlayerVisibilityBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    togglePlayerVisibilityBtn.title = '隐藏播放器';
                } else {
                    togglePlayerVisibilityBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    togglePlayerVisibilityBtn.title = '显示播放器';
                }
            }
            
            if (togglePlayerBtn) {
                togglePlayerBtn.style.display = isVisible ? 'flex' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            applyDeviceOptimizations();
            handleResize();
            window.addEventListener('resize', handleResize);
            
            const hidden = localStorage.getItem('playerHidden') === 'true';
            if (hidden) {
                floatingPlayer.style.display = 'none';
                isPlayerHiddenByUser = true;
                updatePlayerVisibilityButtonState();
            }
        });
        
        const songNameInput = document.getElementById('songName');
        const platformToggle = document.getElementById('platformToggle');
        const platformDropdown = document.getElementById('platformDropdown');
        const platformOptions = document.querySelectorAll('.platform-option');
        const currentPageElement = document.getElementById('currentPage');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const loadingElement = document.getElementById('loading');
        const preloadInfo = document.getElementById('preloadInfo');
        const preloadProgressBar = document.getElementById('preloadProgressBar');
        const preloadStatus = document.getElementById('preloadStatus');
        const errorMessageElement = document.getElementById('errorMessage');
        const emptyStateElement = document.getElementById('emptyState');
        const loadedSongCountElement = document.getElementById('loadedSongCount');
        const songListElement = document.getElementById('songList');
        
        const floatingPlayer = document.getElementById('floatingPlayer');
        const playerTitle = document.getElementById('playerTitle');
        const playerArtist = document.getElementById('playerArtist');
        const playerAlbumArt = document.getElementById('playerAlbumArt');
        const playerLyricsLine = document.getElementById('playerLyricsLine');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPreloader = document.getElementById('audioPreloader');
        const playerLyrics = document.getElementById('playerLyrics');
        
        const fullscreenPlayer = document.getElementById('fullscreenPlayer');
        const closeFullscreenBtn = document.getElementById('closeFullscreenBtn');
        const fullscreenAlbumArt = document.getElementById('fullscreenAlbumArt');
        const fullscreenTitle = document.getElementById('fullscreenTitle');
        const fullscreenArtist = document.getElementById('fullscreenArtist');
        const fullscreenLyrics = document.getElementById('fullscreenLyrics');
        const fullscreenCurrentTime = document.getElementById('fullscreenCurrentTime');
        const fullscreenTotalTime = document.getElementById('fullscreenTotalTime');
        const fullscreenProgressBar = document.getElementById('fullscreenProgressBar');
        const fullscreenProgressContainer = document.getElementById('fullscreenProgressContainer');
        const fullscreenPrevBtn = document.getElementById('fullscreenPrevBtn');
        const fullscreenPlayPauseBtn = document.getElementById('fullscreenPlayPauseBtn');
        const fullscreenNextBtn = document.getElementById('fullscreenNextBtn');
        
        const lyricsPanel = document.getElementById('lyricsPanel');
        const lyricsDragHandle = document.getElementById('lyricsDragHandle');
        const lyricsSourceSelector = document.getElementById('lyricsSourceSelector');
        const lyricsSourceTrigger = document.getElementById('lyricsSourceTrigger');
        const lyricsSourceText = document.getElementById('lyricsSourceText');
        const lyricsSourceDropdown = document.getElementById('lyricsSourceDropdown');
        const lyricsSourceBadge = document.getElementById('lyricsSourceBadge');
        
        const jiaxinConfigPanel = document.getElementById('jiaxinConfigPanel');
        const jiaxinApiKeyInput = document.getElementById('jiaxinApiKey');
        const saveJiaxinKeyBtn = document.getElementById('saveJiaxinKeyBtn');
        
        const lyricsOpacitySlider = document.getElementById('lyricsOpacitySlider');
        const toggleOpacityBtn = document.getElementById('toggleOpacityBtn');
        const opacitySliderContainer = document.getElementById('opacitySliderContainer');
        const opacityValue = document.getElementById('opacityValue');
        
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const totalTimeElement = document.getElementById('totalTime');
        const progressBar = document.getElementById('progressBar');
        const progressBuffer = document.getElementById('progressBuffer');
        const progressHandle = document.getElementById('progressHandle');
        const progressContainer = document.getElementById('progressContainer');
        const volumeBtn = document.getElementById('volumeBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const opacityBtn = document.getElementById('opacityBtn');
        const playModeBtn = document.getElementById('playModeBtn');
        const playbackRateBtn = document.getElementById('playbackRateBtn');
        const togglePlayerBtn = document.getElementById('togglePlayerBtn');
        const playerExpanded = document.getElementById('playerExpanded');
        const lyricsBtn = document.getElementById('lyricsBtn');
        const closeLyricsBtn = document.getElementById('closeLyricsBtn');
        const showLyricsBtn = document.getElementById('showLyricsBtn');
        
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        let currentSongId = null;
        let currentPlatform = 'wy';
        let currentSearchResults = [];
        let playlistSongs = [];
        let pendingTimeouts = [];
        let currentSearchRequestId = 0;
        let searchPageNumber = 1;
        let hasNextPage = false;
        let loadedSongsCount = 0;
        let totalSongsCount = 0;
        let isPlayerExpanded = false;
        let isLyricsVisible = false;
        let isPlayerHiddenByUser = false;
        
        const songCache = new Map();
        const SONG_CACHE_EXPIRY = 5 * 60 * 1000;
        
        const DAILY_RECOMMEND_KEY = 'dailyRecommendation';
        const DAILY_RECOMMEND_DATE_KEY = 'dailyRecommendationDate';
        
        let isLyricsDragging = false;
        let lyricsDragStartX = 0;
        let lyricsDragStartY = 0;

        function escapeHTML(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"]/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return m;
            });
        }
        let lyricsPanelStartX = 0;
        let lyricsPanelStartY = 0;
        
        let lyricsData = [];
        let currentLyricIndex = -1;
        let lyricsScrollInterval = null;
        let currentLyricsSource = 'original';
        let availableLyricsSources = [];
        
        let jiaxinApiKey = localStorage.getItem('jiaxin_api_key') || '9024401e275f939d';
        let yunzhiToken = localStorage.getItem('yunzhi_token') || '';
        
        let isPlaying = false;
        let lastUpdateTime = null;
        let isSeeking = false;
        let currentVolume = 1.0;
        let playbackRates = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
        let currentPlaybackRateIndex = 2;
        let currentPlaybackRate = 1.0;
        let playModes = ['order', 'loop', 'random'];
        let currentPlayModeIndex = 0;
        let searchPageSize = 20;
        let searchHistory = [];
        const MAX_HISTORY = 10;
        const HISTORY_KEY = 'searchHistory';
        let historyEnabled = true;
        let tempShowPlayerForSettings = false;
        let opacitySliderTimer = null;
        let wasPlayerHiddenBySettings = false;
        
        const platformNames = {
            'wy': '网易云音乐',
            'qq': 'QQ音乐',
            'kw': '酷我音乐',
            'mg': '咪咕音乐',
            'qi': '千千音乐'
        };
        
        const platformIcons = {
            'wy': 'fab fa-napster',
            'qq': 'fab fa-qq',
            'kw': 'fas fa-headphones',
            'mg': 'fas fa-mobile-alt',
            'qi': 'fas fa-play-circle'
        };
        
        const lyricsSourceNames = {
            'original': '原始歌词',
            'wy': '网易云',
            'qq': 'QQ音乐',
            'kw': '酷我音乐',
            'qi': '千千音乐',
            'jx-netease': '佳欣歌词(网易)',
            'jx-tencent': '佳欣歌词(腾讯)'
        };
        
        function updateToolbarPosition() {
            const playerTopBar = document.getElementById('playerTopBar');
            const floatingPlayer = document.getElementById('floatingPlayer');
            if (!playerTopBar) return;

            const toolbarHeight = playerTopBar.offsetHeight;
            const windowHeight = window.innerHeight;

            let toolbarTop = (windowHeight - toolbarHeight) / 2;
            toolbarTop = Math.max(10, Math.min(toolbarTop, windowHeight - toolbarHeight - 10));

            if (floatingPlayer && floatingPlayer.style.display !== 'none') {
                const playerRect = floatingPlayer.getBoundingClientRect();
                const toolbarBottom = toolbarTop + toolbarHeight;
                const playerTop = playerRect.top;
                const playerBottom = playerRect.bottom;

                if (toolbarBottom > playerTop && toolbarTop < playerBottom) {
                    toolbarTop = playerTop - toolbarHeight - 10;
                    toolbarTop = Math.max(10, toolbarTop);
                }
            }

            playerTopBar.style.top = toolbarTop + 'px';
            playerTopBar.style.bottom = 'auto';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search');
            
            if (searchQuery) {
                songNameInput.value = searchQuery;
                performSearch();
                const cleanUrl = window.location.pathname;
                history.replaceState({}, '', cleanUrl);
            }
            
            initPlaybackRateDisplay();
            
            updateQuickRateButtons();
            
            platformToggle.addEventListener('click', function() {
                platformDropdown.classList.toggle('active');
                platformToggle.classList.toggle('active');
            });
            
            platformOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const text = this.querySelector('span').textContent;
                    const iconClass = this.querySelector('i').className;
                    
                    updateSelectedPlatform(value, text, iconClass);
                    
                    platformDropdown.classList.remove('active');
                    platformToggle.classList.remove('active');
                });
            });
            
            document.addEventListener('click', function(event) {
                if (!platformToggle.contains(event.target) && !platformDropdown.contains(event.target)) {
                    platformDropdown.classList.remove('active');
                    platformToggle.classList.remove('active');
                }
            });
            
            document.getElementById('searchInputBtn').addEventListener('click', performSearch);
            
            document.getElementById('recommendBtn').addEventListener('click', loadDailyRecommendation);
            
            document.getElementById('closeRecommendModal').addEventListener('click', function() {
                document.getElementById('recommendModal').classList.remove('active');
            });
            
            document.getElementById('recommendModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    this.classList.remove('active');
                }
            });
            
            let searchDebounceTimer = null;
            songNameInput.addEventListener('input', function(event) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    if (this.value.trim()) {
                        performSearch();
                    }
                }, 500);
            });
            
            songNameInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    clearTimeout(searchDebounceTimer);
                    performSearch();
                }
            });
            
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            
            saveJiaxinKeyBtn.addEventListener('click', saveJiaxinApiKey);
            
            const yunzhiTokenInput = document.getElementById('yunzhiTokenInput');
            const saveYunzhiTokenBtn = document.getElementById('saveYunzhiTokenBtn');

            if (yunzhiTokenInput) {
                yunzhiTokenInput.value = yunzhiToken;
            }

            if (saveYunzhiTokenBtn) {
                saveYunzhiTokenBtn.addEventListener('click', function() {
                    const token = yunzhiTokenInput.value.trim();
                    if (token) {
                        yunzhiToken = token;
                        localStorage.setItem('yunzhi_token', token);
                        showStatusMessage('云智API Token已保存', 'success');
                    } else {
                        yunzhiToken = '';
                        localStorage.removeItem('yunzhi_token');
                        showStatusMessage('Token已清空', 'info');
                    }
                });
            }
            
            const backgroundLayer = document.getElementById('backgroundLayer');
            const backgroundToggle = document.getElementById('backgroundToggle');
            const wallpaperFileInput = document.getElementById('wallpaperFileInput');
            const localWallpaperBtn = document.getElementById('localWallpaperBtn');
            const resetWallpaperBtn = document.getElementById('resetWallpaperBtn');

            const defaultBackgrounds = {
                portrait: 'url("https://free.picui.cn/free/2026/02/08/6987f0c183dc5.png")',
                landscape: 'url("https://free.picui.cn/free/2026/02/08/6987f0bfd71dc.png")'
            };

            function applyThemeBackground(theme) {
                const bgLayer = document.getElementById('backgroundLayer');
                const customWallpaper = localStorage.getItem('customWallpaper');
                const bgEnabled = localStorage.getItem('bgEnabled') !== 'false';
                const toggle = document.getElementById('backgroundToggle');

                if (customWallpaper) {
                    bgLayer.style.setProperty('background-image', customWallpaper);
                    bgLayer.style.setProperty('opacity', bgEnabled ? (theme === 'newyear' ? '0.7' : '0.5') : '0');
                    if (toggle) toggle.checked = bgEnabled;
                    return;
                }

                bgLayer.style.removeProperty('background-image');

                if (bgEnabled) {
                    bgLayer.style.removeProperty('opacity');
                } else {
                    bgLayer.style.setProperty('opacity', '0');
                }

                if (toggle) toggle.checked = bgEnabled;

                bgLayer.style.display = 'none';
                bgLayer.offsetHeight;
                bgLayer.style.display = '';
            }

            function initBackgroundSettings() {
                const bgEnabled = localStorage.getItem('bgEnabled') !== 'false';
                backgroundToggle.checked = bgEnabled;
                backgroundLayer.style.opacity = bgEnabled ? '0.5' : '0';

                const customWallpaper = localStorage.getItem('customWallpaper');
                if (customWallpaper) {
                    if (customWallpaper.startsWith('url("http')) {
                        const urlMatch = customWallpaper.match(/url\("([^"]+)"\)/);
                        if (urlMatch && urlMatch[1]) {
                            urlWallpaperInput.value = urlMatch[1];
                        }
                        backgroundLayer.style.backgroundImage = customWallpaper;
                    } else if (customWallpaper.startsWith('url("data:')) {
                        backgroundLayer.style.backgroundImage = customWallpaper;
                    } else {
                        localStorage.removeItem('customWallpaper');
                        applyThemeBackground(localStorage.getItem('theme') || 'default');
                    }
                } else {
                    applyThemeBackground(localStorage.getItem('theme') || 'default');
                }

                backgroundToggle.addEventListener('change', function() {
                    const enabled = this.checked;
                    backgroundLayer.style.opacity = enabled ? (document.body.classList.contains('new-year-theme') ? '0.6' : '0.5') : '0';
                    localStorage.setItem('bgEnabled', enabled);
                });
            }

            localWallpaperBtn.addEventListener('click', () => {
                wallpaperFileInput.click();
            });

            wallpaperFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const maxSize = 2 * 1024 * 1024;
                if (file.size > maxSize) {
                    showStatusMessage('图片过大，请选择小于2MB的图片', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    try {
                        localStorage.setItem('customWallpaper', `url("${dataUrl}")`);
                        backgroundLayer.style.backgroundImage = `url("${dataUrl}")`;
                        backgroundToggle.checked = true;
                        backgroundLayer.style.opacity = document.body.classList.contains('new-year-theme') ? '0.7' : '0.5';
                        localStorage.setItem('bgEnabled', 'true');
                        showStatusMessage('壁纸已应用', 'success');
                    } catch (storageError) {
                        applyTempWallpaper(file);
                    }
                };
                reader.onerror = function() {
                    applyTempWallpaper(file);
                };
                reader.readAsDataURL(file);
            });

            function applyTempWallpaper(file) {
                try {
                    const objectUrl = URL.createObjectURL(file);
                    backgroundLayer.style.backgroundImage = `url("${objectUrl}")`;
                    backgroundToggle.checked = true;
                    backgroundLayer.style.opacity = document.body.classList.contains('new-year-theme') ? '0.7' : '0.5';
                    localStorage.setItem('bgEnabled', 'true');
                    showStatusMessage('壁纸已临时应用（刷新后失效）', 'info');
                    if (window._lastWallpaperUrl) {
                        URL.revokeObjectURL(window._lastWallpaperUrl);
                    }
                    window._lastWallpaperUrl = objectUrl;
                } catch (e) {
                    showStatusMessage('无法应用壁纸，请尝试其他图片', 'error');
                }
            }

            applyUrlWallpaperBtn.addEventListener('click', function() {
                const url = urlWallpaperInput.value.trim();
                if (!url) {
                    showStatusMessage('请输入图片URL', 'error');
                    return;
                }

                try {
                    new URL(url);
                } catch (e) {
                    showStatusMessage('请输入有效的URL', 'error');
                    return;
                }

                localStorage.setItem('customWallpaper', `url("${url}")`);
                backgroundLayer.style.backgroundImage = `url("${url}")`;
                backgroundToggle.checked = true;
                backgroundLayer.style.opacity = document.body.classList.contains('new-year-theme') ? '0.7' : '0.5';
                localStorage.setItem('bgEnabled', 'true');
                showStatusMessage('URL背景已应用', 'success');
            });

            resetWallpaperBtn.addEventListener('click', function() {
                localStorage.removeItem('customWallpaper');
                backgroundLayer.style.backgroundImage = '';
                if (window._lastWallpaperUrl) {
                    URL.revokeObjectURL(window._lastWallpaperUrl);
                    window._lastWallpaperUrl = null;
                }
                showStatusMessage('已恢复默认背景', 'info');
            });

            initBackgroundSettings();

            function initTheme() {
                const savedTheme = 'default';
                localStorage.setItem('theme', savedTheme);
                document.body.classList.remove('new-year-theme');

                updateThemeButtons();

                applyThemeBackground(savedTheme);

                if (window.fireworksControl) window.fireworksControl.stop();
            }

            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    localStorage.setItem('theme', theme);
                    document.body.classList.remove('new-year-theme');

                    updateThemeButtons();

                    applyThemeBackground(theme);

                    if (window.fireworksControl) window.fireworksControl.stop();

                    showStatusMessage('默认主题已应用', 'success');
                });
            });

            initTheme();

            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrevSong);
            nextBtn.addEventListener('click', playNextSong);
            playModeBtn.addEventListener('click', togglePlayMode);
            volumeBtn.addEventListener('click', toggleMute);
            togglePlayerBtn.addEventListener('click', togglePlayerExpanded);
            closeLyricsBtn.addEventListener('click', closeLyricsPanel);
            
            if (playerAlbumArt) {
                playerAlbumArt.addEventListener('click', function(e) {
                    e.stopPropagation();
                    updateFullscreenInfo();
                    renderFullscreenLyrics();
                    fullscreenPlayer.classList.add('active');
                    updateFullscreenPlayPauseButton();
                });
            }
            
            closeFullscreenBtn.addEventListener('click', function() {
                fullscreenPlayer.classList.remove('active');
                clearFullscreenLyrics();
            });
            
            fullscreenPlayer.addEventListener('click', function(e) {
                if (e.target === fullscreenPlayer) {
                    fullscreenPlayer.classList.remove('active');
                    clearFullscreenLyrics();
                }
            });
            
            fullscreenPlayPauseBtn.addEventListener('click', togglePlayPause);
            fullscreenPrevBtn.addEventListener('click', playPrevSong);
            fullscreenNextBtn.addEventListener('click', playNextSong);
            
            fullscreenProgressContainer.addEventListener('click', function(e) {
                if (!audioPlayer.duration || isNaN(audioPlayer.duration)) return;
                const rect = this.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newTime = percent * audioPlayer.duration;
                audioPlayer.currentTime = newTime;
            });
            
            if (fullscreenProgressContainer) {
                const fullscreenProgressHandle = document.getElementById('fullscreenProgressHandle');
                let isFullscreenSeekingTouch = false;

                const startFullscreenSeekingTouch = (e) => {
                    e.preventDefault();
                    isFullscreenSeekingTouch = true;

                    const touch = e.touches[0];
                    const rect = fullscreenProgressContainer.getBoundingClientRect();
                    let percent = (touch.clientX - rect.left) / rect.width;
                    percent = Math.max(0, Math.min(1, percent));

                    fullscreenProgressBar.style.width = `${percent * 100}%`;
                    if (fullscreenProgressHandle) {
                        fullscreenProgressHandle.style.left = `${percent * 100}%`;
                    }
                    fullscreenCurrentTime.textContent = formatTime(percent * audioPlayer.duration);

                    const handleTouchMove = (e) => {
                        if (!isFullscreenSeekingTouch) return;
                        e.preventDefault();

                        const touch = e.touches[0];
                        const rect = fullscreenProgressContainer.getBoundingClientRect();
                        let percent = (touch.clientX - rect.left) / rect.width;
                        percent = Math.max(0, Math.min(1, percent));

                        fullscreenProgressBar.style.width = `${percent * 100}%`;
                        if (fullscreenProgressHandle) {
                            fullscreenProgressHandle.style.left = `${percent * 100}%`;
                        }
                        fullscreenCurrentTime.textContent = formatTime(percent * audioPlayer.duration);
                    };

                    const handleTouchEnd = (e) => {
                        if (!isFullscreenSeekingTouch) return;
                        e.preventDefault();
                        isFullscreenSeekingTouch = false;

                        const touch = e.changedTouches[0];
                        const rect = fullscreenProgressContainer.getBoundingClientRect();
                        let percent = (touch.clientX - rect.left) / rect.width;
                        percent = Math.max(0, Math.min(1, percent));

                        audioPlayer.currentTime = percent * audioPlayer.duration;
                        updatePlayerDisplay();

                        document.removeEventListener('touchmove', handleTouchMove);
                        document.removeEventListener('touchend', handleTouchEnd);
                    };

                    document.addEventListener('touchmove', handleTouchMove, { passive: true });
                    document.addEventListener('touchend', handleTouchEnd, { passive: true });
                };

                fullscreenProgressContainer.addEventListener('touchstart', startFullscreenSeekingTouch, { passive: true });
            }
            
            const togglePlayerVisibilityBtn = document.getElementById('togglePlayerVisibilityBtn');
            const playerTopBar = document.getElementById('playerTopBar');

            function togglePlayerVisibility() {
                if (floatingPlayer.style.display !== 'none') {
                    floatingPlayer.style.display = 'none';
                    isPlayerHiddenByUser = true;
                } else {
                    floatingPlayer.style.display = 'flex';
                    isPlayerHiddenByUser = false;
                }
                updatePlayerVisibilityButtonState();
                updateToolbarPosition();
                localStorage.setItem('playerHidden', isPlayerHiddenByUser ? 'true' : 'false');
            }

            if (togglePlayerVisibilityBtn) {
                togglePlayerVisibilityBtn.addEventListener('click', togglePlayerVisibility);
            }
            
            window.updateToolbarPosition = updateToolbarPosition;
            window.updatePlayerVisibilityButtonState = updatePlayerVisibilityButtonState;

            const resizeObserver = new ResizeObserver(updateToolbarPosition);
            if (floatingPlayer) resizeObserver.observe(floatingPlayer);

            window.addEventListener('resize', updateToolbarPosition);

            const styleObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'style') {
                        if (floatingPlayer.style.display !== 'none') {
                            updateToolbarPosition();
                        }
                    }
                });
            });
            if (floatingPlayer) styleObserver.observe(floatingPlayer, { attributes: true, attributeFilter: ['style'] });

            updateToolbarPosition();

            const playerOpacitySlider = document.getElementById('playerOpacitySlider');
            const textOpacitySlider = document.getElementById('textOpacitySlider');
            const toolbarOpacitySlider = document.getElementById('toolbarOpacitySlider');
            const navbarOpacitySlider = document.getElementById('navbarOpacitySlider');
            const playerOpacityValue = document.getElementById('playerOpacityValue');
            const textOpacityValue = document.getElementById('textOpacityValue');
            const toolbarOpacityValue = document.getElementById('toolbarOpacityValue');
            const navbarOpacityValue = document.getElementById('navbarOpacityValue');
            const settingsOptionBtns = document.querySelectorAll('.settings-option-btn');

            let playerOpacity = 1.0;
            let textOpacity = 1.0;
            let toolbarOpacity = 1.0;
            let navbarOpacity = 1.0;

            playerOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                playerOpacityValue.textContent = value + '%';
                updatePlayerOpacity(value);

                if (currentPage === 'settings') {
                    const player = document.getElementById('floatingPlayer');
                    if (player && player.style.display === 'none') {
                        player.style.display = 'flex';
                        tempShowPlayerForSettings = true;
                        
                        if (opacitySliderTimer) {
                            clearTimeout(opacitySliderTimer);
                            opacitySliderTimer = null;
                        }
                        opacitySliderTimer = setTimeout(() => {
                            if (tempShowPlayerForSettings && currentPage === 'settings') {
                                document.getElementById('floatingPlayer').style.display = 'none';
                                tempShowPlayerForSettings = false;
                            }
                            opacitySliderTimer = null;
                        }, 2000);
                    }
                }
            });

            playerOpacitySlider.addEventListener('change', function() {
                if (opacitySliderTimer) {
                    clearTimeout(opacitySliderTimer);
                    opacitySliderTimer = null;
                }
                if (tempShowPlayerForSettings && currentPage === 'settings') {
                    document.getElementById('floatingPlayer').style.display = 'none';
                    tempShowPlayerForSettings = false;
                }
            });

            textOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                textOpacityValue.textContent = value + '%';
                updateTextOpacity(value);
            });

            toolbarOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                toolbarOpacityValue.textContent = value + '%';
                updateToolbarOpacity(value);
            });

            navbarOpacitySlider.addEventListener('input', function() {
                const value = this.value;
                navbarOpacityValue.textContent = value + '%';
                updateNavbarOpacity(value);
            });

            settingsOptionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const position = this.dataset.position;
                    if (!position) return;

                    settingsOptionBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    playerTopBar.classList.remove('position-left', 'position-right');
                    playerTopBar.classList.add(`position-${position}`);

                    localStorage.setItem('toolbarPosition', position);
                });
            });

            function initSettingsValues() {
                const savedPlayerOpacity = localStorage.getItem('playerOpacity');
                if (savedPlayerOpacity) {
                    playerOpacity = parseFloat(savedPlayerOpacity);
                    playerOpacitySlider.value = playerOpacity * 100;
                    playerOpacityValue.textContent = Math.round(playerOpacity * 100) + '%';
                    updatePlayerOpacity(playerOpacity * 100);
                }

                const savedTextOpacity = localStorage.getItem('textOpacity');
                if (savedTextOpacity) {
                    textOpacity = parseFloat(savedTextOpacity);
                    textOpacitySlider.value = textOpacity * 100;
                    textOpacityValue.textContent = Math.round(textOpacity * 100) + '%';
                    updateTextOpacity(textOpacity * 100);
                }

                const savedToolbarOpacity = localStorage.getItem('toolbarOpacity');
                if (savedToolbarOpacity) {
                    toolbarOpacity = parseFloat(savedToolbarOpacity);
                    toolbarOpacitySlider.value = toolbarOpacity * 100;
                    toolbarOpacityValue.textContent = Math.round(toolbarOpacity * 100) + '%';
                    updateToolbarOpacity(toolbarOpacity * 100);
                }

                const savedNavbarOpacity = localStorage.getItem('navbarOpacity');
                if (savedNavbarOpacity) {
                    navbarOpacity = parseFloat(savedNavbarOpacity);
                    navbarOpacitySlider.value = navbarOpacity * 100;
                    navbarOpacityValue.textContent = Math.round(navbarOpacity * 100) + '%';
                    updateNavbarOpacity(navbarOpacity * 100);
                }

                const savedPosition = localStorage.getItem('toolbarPosition');
                if (savedPosition) {
                    playerTopBar.classList.add(`position-${savedPosition}`);
                    document.querySelector(`.settings-option-btn[data-position="${savedPosition}"]`)?.classList.add('active');
                } else {
                    playerTopBar.classList.add('position-left');
                    document.querySelector('.settings-option-btn[data-position="left"]')?.classList.add('active');
                }
            }

            initSettingsValues();

            const opacitySectionHeader = document.getElementById('opacitySectionHeader');
            const opacitySectionContent = document.getElementById('opacitySectionContent');
            const opacityCollapseBtn = document.getElementById('toggleOpacitySection');
            const opacityCollapseIcon = opacityCollapseBtn.querySelector('i');

            if (opacitySectionContent.classList.contains('collapsed')) {
                opacityCollapseIcon.style.transform = 'rotate(0deg)';
            } else {
                opacitySectionContent.classList.add('collapsed');
                opacityCollapseIcon.style.transform = 'rotate(0deg)';
            }

            function toggleOpacityCollapse() {
                const isCollapsed = opacitySectionContent.classList.contains('collapsed');
                if (isCollapsed) {
                    opacitySectionContent.classList.remove('collapsed');
                    opacityCollapseIcon.style.transform = 'rotate(180deg)';
                } else {
                    opacitySectionContent.classList.add('collapsed');
                    opacityCollapseIcon.style.transform = 'rotate(0deg)';
                }
            }

            opacitySectionHeader.addEventListener('click', function(e) {
                if (e.target.closest('.collapse-btn')) return;
                toggleOpacityCollapse();
            });

            opacityCollapseBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleOpacityCollapse();
            });

            const bgSectionHeader = document.getElementById('bgSectionHeader');
            const bgSectionContent = document.getElementById('bgSectionContent');
            const bgCollapseBtn = document.getElementById('toggleBgSection');
            const bgCollapseIcon = bgCollapseBtn.querySelector('i');

            if (bgSectionContent.classList.contains('collapsed')) {
                bgCollapseIcon.style.transform = 'rotate(0deg)';
            } else {
                bgSectionContent.classList.add('collapsed');
                bgCollapseIcon.style.transform = 'rotate(0deg)';
            }

            function toggleBgCollapse() {
                const isCollapsed = bgSectionContent.classList.contains('collapsed');
                if (isCollapsed) {
                    bgSectionContent.classList.remove('collapsed');
                    bgCollapseIcon.style.transform = 'rotate(180deg)';
                } else {
                    bgSectionContent.classList.add('collapsed');
                    bgCollapseIcon.style.transform = 'rotate(0deg)';
                }
            }

            bgSectionHeader.addEventListener('click', function(e) {
                if (e.target.closest('.collapse-btn')) return;
                toggleBgCollapse();
            });

            bgCollapseBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleBgCollapse();
            });

            downloadBtn.addEventListener('click', downloadSong);

            lyricsSourceTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                lyricsSourceDropdown.classList.toggle('active');
                lyricsSourceTrigger.classList.toggle('active');
            });
            
            initDownloadPanel();
            initDownloadOptionsPanel();
            initAnnouncementPanel();
            
            playbackRateBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                showPlaybackRateModal();
            });
            
            const playbackRateSlider = document.getElementById('playbackRateSlider');
            if (playbackRateSlider) {
                playbackRateSlider.addEventListener('input', function() {
                    const rate = parseFloat(this.value);
                    currentPlaybackRate = rate;
                    
                    audioPlayer.playbackRate = rate;
                    
                    const sliderValue = document.getElementById('playbackRateSliderValue');
                    if (sliderValue) {
                        sliderValue.textContent = `${rate.toFixed(2)}x`;
                    }

                    const rateText = document.getElementById('playbackRateText');
                    if (rateText) {
                        rateText.textContent = `${rate.toFixed(2)}x`;
                        playbackRateBtn.title = `播放速度: ${rate.toFixed(2)}x`;
                    }
                    
                    updateQuickRateButtons();
                });
            }
            
            const quickRateButtons = document.querySelectorAll('.quick-rate-btn');
            quickRateButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const rate = parseFloat(this.dataset.rate);
                    currentPlaybackRate = rate;
                    
                    audioPlayer.playbackRate = rate;
                    
                    if (playbackRateSlider) {
                        playbackRateSlider.value = rate;
                    }
                    
                    const sliderValue = document.getElementById('playbackRateSliderValue');
                    if (sliderValue) {
                        sliderValue.textContent = `${rate.toFixed(2)}x`;
                    }
                    
                    const rateText = document.getElementById('playbackRateText');
                    if (rateText) {
                        rateText.textContent = `${rate.toFixed(2)}x`;
                        playbackRateBtn.title = `播放速度: ${rate.toFixed(2)}x`;
                    }
                    
                    updateQuickRateButtons();
                });
            });

            const closePlaybackRateModalBtn = document.getElementById('closePlaybackRateModal');
            if (closePlaybackRateModalBtn) {
                closePlaybackRateModalBtn.addEventListener('click', hidePlaybackRateModal);
            }

            const playbackRateModal = document.getElementById('playbackRateModal');
            if (playbackRateModal) {
                playbackRateModal.addEventListener('click', function(e) {
                    if (e.target === playbackRateModal) {
                        hidePlaybackRateModal();
                    }
                });
            }

            toggleOpacityBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                opacitySliderContainer.style.display = opacitySliderContainer.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', function(e) {
                if (!lyricsSourceSelector.contains(e.target)) {
                    lyricsSourceDropdown.classList.remove('active');
                    lyricsSourceTrigger.classList.remove('active');
                }

                if (!opacitySliderContainer.contains(e.target) && !toggleOpacityBtn.contains(e.target)) {
                    opacitySliderContainer.style.display = 'none';
                }
            });

            volumeSlider.addEventListener('input', function() {
                const volume = this.value / 100;
                audioPlayer.volume = volume;
                audioPlayer.muted = volume === 0;
                updateVolumeButton();

                const volumeContainer = document.querySelector('.volume-slider-container');
                if (volumeContainer) {
                    volumeContainer.setAttribute('data-volume', `${this.value}%`);
                }
            });
            
            lyricsOpacitySlider.addEventListener('input', function() {
                const opacity = this.value / 100;
                updateLyricsPanelOpacity(opacity);
                opacityValue.textContent = `${this.value}%`;
            });

            updateLyricsPanelOpacity(lyricsOpacitySlider.value / 100);
            opacityValue.textContent = `${lyricsOpacitySlider.value}%`;

            progressContainer.addEventListener('click', function(e) {
                if (!audioPlayer.duration || isNaN(audioPlayer.duration)) return;
                
                const rect = this.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newTime = percent * audioPlayer.duration;
                
                audioPlayer.currentTime = newTime;
                updatePlayerDisplay();
            });

            progressHandle.addEventListener('mousedown', startSeeking);
            progressContainer.addEventListener('mousedown', startSeeking);

            if (progressContainer) {
                let isProgressSeekingTouch = false;

                const startProgressSeekingTouch = (e) => {
                    e.preventDefault();
                    isProgressSeekingTouch = true;

                    const touch = e.touches[0];
                    const rect = progressContainer.getBoundingClientRect();
                    let percent = (touch.clientX - rect.left) / rect.width;
                    percent = Math.max(0, Math.min(1, percent));

                    progressBar.style.width = `${percent * 100}%`;
                    if (progressHandle) {
                        progressHandle.style.left = `${percent * 100}%`;
                    }
                    currentTimeElement.textContent = formatTime(percent * audioPlayer.duration);

                    const handleTouchMove = (e) => {
                        if (!isProgressSeekingTouch) return;
                        e.preventDefault();

                        const touch = e.touches[0];
                        const rect = progressContainer.getBoundingClientRect();
                        let percent = (touch.clientX - rect.left) / rect.width;
                        percent = Math.max(0, Math.min(1, percent));

                        progressBar.style.width = `${percent * 100}%`;
                        if (progressHandle) {
                            progressHandle.style.left = `${percent * 100}%`;
                        }
                        currentTimeElement.textContent = formatTime(percent * audioPlayer.duration);
                    };

                    const handleTouchEnd = (e) => {
                        if (!isProgressSeekingTouch) return;
                        e.preventDefault();
                        isProgressSeekingTouch = false;

                        const touch = e.changedTouches[0];
                        const rect = progressContainer.getBoundingClientRect();
                        let percent = (touch.clientX - rect.left) / rect.width;
                        percent = Math.max(0, Math.min(1, percent));

                        audioPlayer.currentTime = percent * audioPlayer.duration;
                        updatePlayerDisplay();

                        document.removeEventListener('touchmove', handleTouchMove);
                        document.removeEventListener('touchend', handleTouchEnd);
                    };

                    document.addEventListener('touchmove', handleTouchMove, { passive: true });
                    document.addEventListener('touchend', handleTouchEnd, { passive: true });
                };

                progressContainer.addEventListener('touchstart', startProgressSeekingTouch, { passive: true });
            }

            setupLyricsPanelDrag();

            audioPlayer.addEventListener('play', function() {
                isPlaying = true;
                isPlaybackActive = true;
                updatePlayPauseButton();
                updateFullscreenPlayPauseButton();
                startLyricsHighlight();
                showStatusMessage('开始播放', 'success');

                lastUpdateTime = Date.now();
            });
            
            audioPlayer.addEventListener('pause', function() {
                isPlaying = false;
                isPlaybackActive = false;
                updatePlayPauseButton();
                updateFullscreenPlayPauseButton();
                stopLyricsHighlight();

                if (lastUpdateTime !== null) {
                    const now = Date.now();
                    const delta = now - lastUpdateTime;
                    if (delta > 0) {
                        const totalPlayTime = parseInt(localStorage.getItem('totalPlayTime') || 0) + delta;
                        localStorage.setItem('totalPlayTime', totalPlayTime);
                        if (currentPage === 'profile') {
                            updateProfilePage();
                        }
                    }
                    lastUpdateTime = null;
                }
            });
            
            audioPlayer.addEventListener('timeupdate', function() {
                updatePlayerDisplay();
                updateLyricsHighlight();
                updatePlayerLyricsLine();

                if (fullscreenPlayer.classList.contains('active')) {
                    if (!audioPlayer.duration || isNaN(audioPlayer.duration)) {
                        fullscreenCurrentTime.textContent = "00:00";
                        fullscreenTotalTime.textContent = "00:00";
                        fullscreenProgressBar.style.width = "0%";
                        return;
                    }
                    const currentTime = audioPlayer.currentTime;
                    const duration = audioPlayer.duration;
                    const progressPercent = (currentTime / duration) * 100;
                    fullscreenCurrentTime.textContent = formatTime(currentTime);
                    fullscreenTotalTime.textContent = formatTime(duration);
                    fullscreenProgressBar.style.width = `${progressPercent}%`;
                }

                if (isPlaybackActive && lastUpdateTime !== null) {
                    const now = Date.now();
                    if (now - lastUpdateTime >= 1000) {
                        const delta = now - lastUpdateTime;
                        const totalPlayTime = parseInt(localStorage.getItem('totalPlayTime') || 0) + delta;
                        localStorage.setItem('totalPlayTime', totalPlayTime);
                        lastUpdateTime = now;
                        if (currentPage === 'profile') {
                            updateProfilePage();
                        }
                    }
                }
            });
            
            audioPlayer.addEventListener('loadedmetadata', function() {
                updatePlayerDisplay();
            });
            
            audioPlayer.addEventListener('ended', function() {

                if (lastUpdateTime !== null) {
                    const now = Date.now();
                    const delta = now - lastUpdateTime;
                    if (delta > 0) {
                        const totalPlayTime = parseInt(localStorage.getItem('totalPlayTime') || 0) + delta;
                        localStorage.setItem('totalPlayTime', totalPlayTime);
                        if (currentPage === 'profile') {
                            updateProfilePage();
                        }
                    }
                    lastUpdateTime = null;
                }
                isPlaybackActive = false;

                if (audioPlayer.currentTime < 1) {
                    return;
                }

                if (audioPlayer.duration - audioPlayer.currentTime > 1) {
                    return;
                }

                const mode = playModes[currentPlayModeIndex];
                if (mode === 'loop') {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play().catch(e => {});
                } else {
                    playNextSong();
                }
            });

            audioPlayer.addEventListener('volumechange', updateVolumeButton);

            audioPlayer.addEventListener('error', (e) => {
                showStatusMessage('音频加载错误，自动播放下一首', 'error');
                setTimeout(() => {
                    playNextSong();
                }, 1000);
            });

            audioPlayer.addEventListener('stalled', () => {
            });

            audioPlayer.addEventListener('waiting', () => {
                showStatusMessage('正在缓冲...', 'info');
            });

            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        playPrevSong();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        playNextSong();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        const newVolumeUp = Math.min(1, currentVolume + 0.1);
                        setVolume(newVolumeUp);
                        showStatusMessage(`音量: ${Math.round(newVolumeUp * 100)}%`, 'info');
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        const newVolumeDown = Math.max(0, currentVolume - 0.1);
                        setVolume(newVolumeDown);
                        showStatusMessage(`音量: ${Math.round(newVolumeDown * 100)}%`, 'info');
                        break;
                }
            });

            if (fullscreenPlayer) {
                let touchStartX = 0;
                let touchEndX = 0;
                const minSwipeDistance = 50;
                
                fullscreenPlayer.addEventListener('touchstart', function(e) {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });
                
                fullscreenPlayer.addEventListener('touchend', function(e) {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });
                
                function handleSwipe() {
                    const swipeDistance = touchEndX - touchStartX;
                    
                    if (Math.abs(swipeDistance) < minSwipeDistance) {
                        return;
                    }
                    
                    if (swipeDistance > 0) {
                        playPrevSong();
                        showStatusMessage('上一首', 'info');
                    } else {
                        playNextSong();
                        showStatusMessage('下一首', 'info');
                    }
                }
            }
            
            audioPlayer.addEventListener('canplay', () => {
            });

            audioPlayer.addEventListener('progress', () => {
                updateBufferProgress();
            });

            audioPlayer.volume = currentVolume;
            updateVolumeButton();
            updatePlayModeDisplay();

            window.addEventListener('resize', () => {
                if (lyricsPanel.classList.contains('active')) {
                    ensureLyricsPanelInViewport();
                }
            });

            jiaxinApiKeyInput.value = jiaxinApiKey;
            if (jiaxinApiKey) {
                jiaxinConfigPanel.classList.remove('active');
            } else {
                jiaxinConfigPanel.classList.add('active');
            }

            playerExpanded.classList.remove('active');
            floatingPlayer.classList.add('player-collapsed');

            updatePlayerVisibilityButtonState();
        });
        
        function saveJiaxinApiKey() {
            const key = jiaxinApiKeyInput.value.trim();
            if (!key) {
                showStatusMessage('请输入API Key', 'error');
                return;
            }
            
            jiaxinApiKey = key;
            localStorage.setItem('jiaxin_api_key', key);
            jiaxinConfigPanel.classList.remove('active');
            showStatusMessage('佳欣歌词API Key已保存', 'success');

            if (currentSongId && currentSongInfo) {
                fetchJiaXinLyricsSources();
            }
        }

        function toggleJiaXinConfigPanel() {
            jiaxinConfigPanel.classList.toggle('active');
        }

        function setupLyricsPanelDrag() {
            lyricsDragHandle.addEventListener('mousedown', startLyricsDrag);
            
            document.addEventListener('mousemove', handleLyricsDrag);
            
            document.addEventListener('mouseup', stopLyricsDrag);
            
            ensureLyricsPanelInViewport();
        }

        function startLyricsDrag(e) {
            if (e.target.closest('.lyrics-control-btn') || 
                e.target.closest('.lyrics-source-btn') ||
                e.target.closest('.config-panel') ||
                e.target.closest('.config-input') ||
                e.target.closest('.config-btn')) {
                return;
            }
            
            isLyricsDragging = true;
            
            lyricsDragStartX = e.clientX;
            lyricsDragStartY = e.clientY;
            
            const rect = lyricsPanel.getBoundingClientRect();
            lyricsPanelStartX = rect.left;
            lyricsPanelStartY = rect.top;
            
            lyricsPanel.style.cursor = 'move';
            lyricsPanel.style.userSelect = 'none';
            lyricsDragHandle.style.cursor = 'move';

            e.preventDefault();
        }

        function handleLyricsDrag(e) {
            if (!isLyricsDragging) return;
            
            const deltaX = e.clientX - lyricsDragStartX;
            const deltaY = e.clientY - lyricsDragStartY;

            let newLeft = lyricsPanelStartX + deltaX;
            let newTop = lyricsPanelStartY + deltaY;

            const maxLeft = window.innerWidth - lyricsPanel.offsetWidth;
            const maxTop = window.innerHeight - lyricsPanel.offsetHeight;

            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            lyricsPanel.style.left = newLeft + 'px';
            lyricsPanel.style.top = newTop + 'px';
            lyricsPanel.style.right = 'auto';
            lyricsPanel.style.bottom = 'auto';
        }

        function stopLyricsDrag() {
            if (!isLyricsDragging) return;
            
            isLyricsDragging = false;

            lyricsPanel.style.cursor = 'default';
            lyricsPanel.style.userSelect = 'auto';
            lyricsDragHandle.style.cursor = 'move';
        }

        function ensureLyricsPanelInViewport() {
            const panelWidth = lyricsPanel.offsetWidth;
            const panelHeight = lyricsPanel.offsetHeight;
            
            const right = 20;
            const bottom = 180;

            lyricsPanel.style.left = 'auto';
            lyricsPanel.style.top = 'auto';
            lyricsPanel.style.right = right + 'px';
            lyricsPanel.style.bottom = bottom + 'px';
        }

        function updateSelectedPlatform(value, text, iconClass) {
            currentPlatform = value;

            platformToggle.querySelector('.platform-name span').textContent = text;
            platformToggle.querySelector('.platform-icon i').className = iconClass;

            platformOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.value === value) {
                    option.classList.add('active');
                }
            });
        }

        function loadSearchHistory() {
            const saved = localStorage.getItem(HISTORY_KEY);
            if (saved) {
                try {
                    searchHistory = JSON.parse(saved);
                } catch (e) {
                    searchHistory = [];
                }
            } else {
                searchHistory = [];
            }
            if (!Array.isArray(searchHistory)) searchHistory = [];
            if (searchHistory.length > MAX_HISTORY) {
                searchHistory = searchHistory.slice(0, MAX_HISTORY);
            }
            updateHistoryUI();
        }

        function saveSearchHistory() {
            searchHistory = [...new Set(searchHistory)].slice(0, MAX_HISTORY);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(searchHistory));
            updateHistoryUI();
        }

        function addSearchHistory(keyword) {
            if (!historyEnabled) return;
            if (!keyword || keyword.trim() === '') return;
            const trimmed = keyword.trim();
            searchHistory = searchHistory.filter(item => item !== trimmed);
            searchHistory.unshift(trimmed);
            if (searchHistory.length > MAX_HISTORY) {
                searchHistory = searchHistory.slice(0, MAX_HISTORY);
            }
            saveSearchHistory();
        }

        function clearSearchHistory() {
            searchHistory = [];
            saveSearchHistory();
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            if (!historySection || !historyList) return;

            if (!historyEnabled || searchHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }

            historySection.style.display = 'block';
            let html = '';
            searchHistory.forEach(keyword => {
                html += `
                    <div class="history-item" data-keyword="${escapeHTML(keyword)}">
                        <i class="fas fa-search"></i>
                        <span>${escapeHTML(keyword)}</span>
                    </div>
                `;
            });
            historyList.innerHTML = html;

            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', function() {
                    const keyword = this.dataset.keyword;
                    if (keyword) {
                        document.getElementById('songName').value = keyword;
                        performSearch();
                    }
                });
            });
        }

        if (typeof escapeHTML !== 'function') {
            window.escapeHTML = function(str) {
                if (!str) return '';
                return String(str).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            };
        }

        async function performSearch() {
            if (!yunzhiToken) {
                showStatusMessage('请先在设置页面配置云智API Token', 'warning');
                return;
            }

            const songName = songNameInput.value.trim();
            const page = searchPageNumber;
            const limit = searchPageSize;
            
            if (!songName) {
                showStatusMessage('请输入歌曲名称或歌手名', 'error');
                return;
            }

            pendingTimeouts.forEach(clearTimeout);
            pendingTimeouts = [];

            currentSearchRequestId++;

            showLoading(true);
            showPreloadInfo(false);
            clearError();
            clearResults();

            loadedSongsCount = 0;
            totalSongsCount = 0;
            updateLoadedCount();

            try {
                const searchParams = {
                    name: songName,
                    type: currentPlatform,
                    page: page,
                    limit: limit
                };
                
                const searchData = await makeRequest(getMusicId, searchParams);

                handleSearchResults(searchData);

                addSearchHistory(songName);

                if (searchData && searchData.code === 1 && searchData.data && searchData.data.length > 0) {
                    totalSongsCount = searchData.data.length;
                    showPreloadInfo(true);

                    loadAllSongDetailsAsync(searchData.data);
                }

                updatePaginationButtons(searchData);

                showStatusMessage(`找到 ${searchData.data?.length || 0} 首歌曲`, 'success');

            } catch (error) {
                showStatusMessage('搜索服务暂时不可用，请稍后再试', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function getQQHotSongs(count) {
            if (typeof count !== 'number' || count <= 0) {
                throw new Error('count参数必须是一个大于0的数字');
            }
            
            const url = 'https://yunzhiapi.cn/API/qqrgbd.php';
            const params = new URLSearchParams();
            params.append('count', count);
            
            if (yunzhiToken) {
                params.append('token', yunzhiToken);
            }
            
            const response = await fetch(`${url}?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data || !data.data || data.data.length === 0) {
                throw new Error('API返回数据为空');
            }

            return data;
        }

        async function loadDailyRecommendation() {
            if (!yunzhiToken) {
                showStatusMessage('请先在设置页面配置云智API Token', 'warning');
                return;
            }

            const recommendBtn = document.getElementById('recommendBtn');
            const recommendModal = document.getElementById('recommendModal');
            const recommendSongList = document.getElementById('recommendSongList');
            
            recommendBtn.disabled = true;

            try {
                const today = new Date().toLocaleDateString('zh-CN');
                let hotSongsData = null;

                const cachedDate = localStorage.getItem(DAILY_RECOMMEND_DATE_KEY);
                const cachedData = localStorage.getItem(DAILY_RECOMMEND_KEY);

                if (cachedDate === today && cachedData) {
                    hotSongsData = JSON.parse(cachedData);
                    showStatusMessage('使用缓存的今日推荐', 'info');
                } else {
                    hotSongsData = await makeRequest(getQQHotSongs, 100);
                    
                    localStorage.setItem(DAILY_RECOMMEND_DATE_KEY, today);
                    localStorage.setItem(DAILY_RECOMMEND_KEY, JSON.stringify(hotSongsData));
                    showStatusMessage('已获取最新每日推荐', 'success');
                }

                recommendSongList.innerHTML = '';

                hotSongsData.data.forEach((song, index) => {
                    const li = document.createElement('li');
                    li.className = 'recommend-song-item';
                    li.innerHTML = `
                        <div class="recommend-song-index">${index + 1}</div>
                        <div class="recommend-song-info">
                            <div class="recommend-song-name">${escapeHTML(song.albumname || '未知歌曲')}</div>
                            <div class="recommend-song-artist">${escapeHTML(song.name || '未知艺术家')}</div>
                        </div>
                    `;
                    
                    li.addEventListener('click', () => {
                        recommendModal.classList.remove('active');
                        songNameInput.value = song.albumname;
                        performSearch();
                    });

                    recommendSongList.appendChild(li);
                });

                recommendModal.classList.add('active');
                showStatusMessage(`今日推荐 ${hotSongsData.data.length} 首热歌`, 'success');

            } catch (error) {
                showStatusMessage('推荐服务暂时不可用，请稍后再试', 'error');
            } finally {
                recommendBtn.disabled = false;
            }
        }

        async function makeRequest(requestFn, ...args) {
            return await requestFn(...args);
        }

        async function getMusicId(params) {
            const requiredParams = ['name', 'type', 'page', 'limit'];
            const missingParams = requiredParams.filter(param => !params[param]);

            if (missingParams.length > 0) {
                throw new Error(`缺少必填参数: ${missingParams.join(', ')}`);
            }

            const requestUrl = 'https://yunzhiapi.cn/API/hqyyid.php';
            const queryParams = new URLSearchParams();

            queryParams.append('name', encodeURIComponent(params.name.trim()));
            queryParams.append('type', params.type);
            queryParams.append('page', params.page);
            queryParams.append('limit', params.limit);

            if (yunzhiToken) {
                queryParams.append('token', yunzhiToken);
            }
            
            const response = await fetch(`${requestUrl}?${queryParams.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (!response.ok) {
                throw new Error(`请求失败，状态码: ${response.status}`);
            }
            
            return await response.json();
        }

        function handleSearchResults(data) {
            emptyStateElement.style.display = 'none';
            songListElement.innerHTML = '';
            
            if (!data || data.code !== 1 || !data.data || data.data.length === 0) {
                emptyStateElement.style.display = 'flex';
                emptyStateElement.innerHTML = `
                    <div>
                        <i class="fas fa-search"></i>
                        <h3>未找到相关歌曲</h3>
                        <p>请尝试其他关键词或更换平台</p>
                    </div>
                `;
                return;
            }
            
            currentSearchResults = data.data;

            data.data.forEach((song, index) => {
                createSongItemStructure(song, index);
            });
        }

        async function loadAllSongDetailsAsync(songs) {
            pendingTimeouts.forEach(clearTimeout);
            pendingTimeouts = [];

            const requestId = currentSearchRequestId;

            songs.forEach((song, index) => {
                const timeoutId = setTimeout(() => {
                    pendingTimeouts = pendingTimeouts.filter(id => id !== timeoutId);
                    loadSingleSongDetail(song, index, requestId);
                }, index * 700);
                pendingTimeouts.push(timeoutId);
            });
        }

        async function loadSingleSongDetail(song, index, requestId) {
            if (requestId !== currentSearchRequestId) {
            }

            const stillExists = currentSearchResults.some(s => String(s.id) === String(song.id));
            if (!stillExists) {
                return;
            }

            try {
                const cacheKey = `${currentPlatform}_${song.id}`;
                const cachedData = songCache.get(cacheKey);
                let result;

                if (cachedData && Date.now() - cachedData.timestamp < SONG_CACHE_EXPIRY) {
                    result = cachedData.data;
                } else {
                    const searchParams = {
                        id: song.id,
                        type: currentPlatform
                    };
                    
                    result = await makeRequest(musicSearchAPI, searchParams);

                    if (result && result.code === 1 && result.data) {
                        songCache.set(cacheKey, {
                            data: result,
                            timestamp: Date.now()
                        });
                    }
                }

                if (requestId !== currentSearchRequestId) return;

                if (String(song.id) === String(currentSongId)) {
                    if (result && result.code === 1 && result.data && result.data.pic) {
                        playerAlbumArt.src = result.data.pic;
                        playerAlbumArt.style.display = 'block';
                        const placeholder = playerAlbumArt.parentElement.querySelector('.cover-placeholder');
                        if (placeholder) {
                            placeholder.style.display = 'none';
                        }
                        playerAlbumArt.onerror = function() {
                            this.style.display = 'none';
                            const placeholder = this.parentElement.querySelector('.cover-placeholder');
                            if (placeholder) {
                                placeholder.style.display = 'flex';
                                placeholder.innerHTML = '<i class="fas fa-music"></i>';
                            }
                        };
                    }
                }
                
                loadedSongsCount++;
                updateLoadedCount();
                updatePreloadProgress(loadedSongsCount, totalSongsCount);

                updateSongItem(song, result, index);

            } catch (error) {
                if (requestId !== currentSearchRequestId) return;

                loadedSongsCount++;
                updateLoadedCount();
                updatePreloadProgress(loadedSongsCount, totalSongsCount);

                updateErrorSongItem(song, error.message);
            }

            if (loadedSongsCount >= totalSongsCount) {
                setTimeout(() => {
                    showPreloadInfo(false);
                    showStatusMessage(`${totalSongsCount} 首歌曲已加载完成`, 'success');
                }, 500);
            }
        }

        function createSongItemStructure(song, index) {
            const songItem = document.createElement('li');
            songItem.className = 'song-item song-loading';
            songItem.dataset.id = song.id;
            songItem.dataset.index = index;

            const escapeHTML = (str) => {
                if (!str) return '';
                return String(str).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            };
            const songName = escapeHTML(song.name) || '未知歌曲';
            const artist = escapeHTML(song.artist) || '未知艺术家';
            const album = escapeHTML(song.album) || '未知专辑';
            const duration = song.duration ? formatDuration(song.duration) : '';

            const coverDiv = document.createElement('div');
            coverDiv.className = 'song-cover';
            const placeholder = document.createElement('div');
            placeholder.className = 'cover-placeholder';
            placeholder.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const img = document.createElement('img');
            img.loading = 'lazy';
            img.src = '';
            img.alt = songName;
            img.dataset.retryCount = '0';
            img.dataset.originalSrc = '';
            img.onerror = function() {
                const retryCount = parseInt(this.dataset.retryCount) || 0;
                if (retryCount < 2 && this.dataset.originalSrc) {
                    this.dataset.retryCount = retryCount + 1;
                    setTimeout(() => {
                        this.src = this.dataset.originalSrc + '&retry=' + retryCount;
                    }, 1000);
                } else {
                    this.style.display = 'none';
                    placeholder.style.display = 'flex';
                    placeholder.innerHTML = '<i class="fas fa-music"></i>';
                }
            };
            img.onload = function() {
                this.style.display = 'block';
                placeholder.style.display = 'none';
            };
            coverDiv.appendChild(placeholder);
            coverDiv.appendChild(img);

            const infoDiv = document.createElement('div');
            infoDiv.className = 'song-info';
            const title = document.createElement('h4');
            title.className = 'song-title';
            title.textContent = songName;
            const artistP = document.createElement('p');
            artistP.className = 'song-artist';
            artistP.textContent = artist;
            const albumP = document.createElement('p');
            albumP.className = 'song-album';
            albumP.innerHTML = '<i class="fas fa-compact-disc"></i> ' + album;
            infoDiv.appendChild(title);
            infoDiv.appendChild(artistP);
            infoDiv.appendChild(albumP);
            if (duration) {
                const durationDiv = document.createElement('div');
                durationDiv.className = 'song-duration';
                durationDiv.textContent = duration;
                infoDiv.appendChild(durationDiv);
            }

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'song-actions';

            const addToListBtn = document.createElement('button');
            addToListBtn.className = 'song-action-btn add-to-list-btn';
            addToListBtn.dataset.id = song.id;
            addToListBtn.disabled = true;
            addToListBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addToListBtn.title = '添加至播放列表';
            actionsDiv.appendChild(addToListBtn);

            const playBtn = document.createElement('button');
            playBtn.className = 'song-action-btn';
            playBtn.dataset.id = song.id;
            playBtn.disabled = true;
            playBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            actionsDiv.appendChild(playBtn);

            songItem.appendChild(coverDiv);
            songItem.appendChild(infoDiv);
            songItem.appendChild(actionsDiv);

            playBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                playSong(song.id, true);
            });

            songListElement.appendChild(songItem);
        }

        function loadAndCacheCover(imgElement, coverUrl, placeholder) {
            if (!coverUrl) {
                if (placeholder) {
                    placeholder.style.display = 'flex';
                    placeholder.innerHTML = '<i class="fas fa-music"></i>';
                }
                return;
            }

            imgElement.dataset.retryCount = '0';
            imgElement.dataset.originalSrc = coverUrl;
            imgElement.src = coverUrl;
            imgElement.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';

            imgElement.onerror = function() {
                const retryCount = parseInt(this.dataset.retryCount) || 0;
                if (retryCount < 2 && this.dataset.originalSrc) {
                    this.dataset.retryCount = retryCount + 1;
                    setTimeout(() => {
                        this.src = this.dataset.originalSrc + '&retry=' + retryCount;
                    }, 1000);
                } else {
                    this.style.display = 'none';
                    if (placeholder) {
                        placeholder.style.display = 'flex';
                        placeholder.innerHTML = '<i class="fas fa-music"></i>';
                    }
                }
            };
        }

        function updateSongItem(song, result, index) {
            const songItem = document.querySelector(`.song-item[data-id="${song.id}"]`);
            if (!songItem) return;
            
            songItem.classList.remove('song-loading');
            songItem.classList.add('song-loaded');

            const playBtn = songItem.querySelector('.song-action-btn:not(.add-to-list-btn)');
            if (playBtn) {
                playBtn.disabled = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                playBtn.onclick = (e) => {
                    e.stopPropagation();
                    addSongToPlaylist(song.id, true);
                };
            }

            const addBtn = songItem.querySelector('.add-to-list-btn');
            if (addBtn) {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.onclick = (e) => {
                    e.stopPropagation();
                    addSongToPlaylist(song.id, false);
                };
            }

            const placeholder = songItem.querySelector('.cover-placeholder');
            const img = songItem.querySelector('img');

            if (placeholder && placeholder.querySelector('.fa-spinner')) {
                placeholder.innerHTML = '<i class="fas fa-music"></i>';
            }

            let coverUrl = null;
            if (result && result.code === 1 && result.data && result.data.pic) {
                coverUrl = result.data.pic;
            }

            if (coverUrl && coverUrl.startsWith('//')) {
                coverUrl = 'https:' + coverUrl;
            }

            if (coverUrl && img) {
                (async () => {
                    await loadAndCacheCover(img, coverUrl, placeholder);
                })();
            } else {
                if (placeholder) {
                    placeholder.style.display = 'flex';
                    placeholder.innerHTML = '<i class="fas fa-music"></i>';
                }
                if (img) img.style.display = 'none';
            }

            const searchResult = currentSearchResults.find(s => String(s.id) === String(song.id));
            if (searchResult) {
                searchResult.cover = coverUrl || '';
            }
        }

        function refreshSongItem(songId, result) {
            const songItem = document.querySelector(`.song-item[data-id="${songId}"]`);
            if (!songItem) return;

            const song = {
                id: songId,
                name: result.data?.name || '未知歌曲',
                artist: result.data?.artist || '未知艺术家',
                cover: result.data?.pic || null
            };

            updateSongItem(song, result, 0);
        }

        function updateErrorSongItem(song, errorMessage) {
            const songItem = document.querySelector(`.song-item[data-id="${song.id}"]`);
            if (!songItem) return;

            songItem.classList.add('error');
            const placeholder = songItem.querySelector('.cover-placeholder');
            if (placeholder) {
                placeholder.innerHTML = '<i class="fas fa-music"></i>';
            }

            const songInfo = songItem.querySelector('.song-info');
            if (songInfo) {
                const errorElement = document.createElement('p');
                errorElement.style.color = 'var(--error-color)';
                errorElement.style.fontSize = '12px';
                errorElement.textContent = '加载失败';
                songInfo.appendChild(errorElement);
            }

            const playBtn = songItem.querySelector('.song-action-btn:not(.add-to-list-btn)');
            if (playBtn) {
                playBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                playBtn.disabled = true;
            }

            const addBtn = songItem.querySelector('.add-to-list-btn');
            if (addBtn) {
                addBtn.disabled = true;
            }
        }

        function loadAlbumCover(song, imgElement, placeholder) {
            let coverUrl = null;
            
            if (song.pic) {
                coverUrl = song.pic;
            } else if (song.picUrl) {
                coverUrl = song.picUrl;
            } else if (song.cover) {
                coverUrl = song.cover;
            } else if (song.coverUrl) {
                coverUrl = song.coverUrl;
            } else if (song.pic_id && currentPlatform === 'wy') {
                coverUrl = `https://p3.music.126.net/${song.pic_id}/${song.pic_id}.jpg?param=100y100`;
            }
            
            if (coverUrl) {
                const img = new Image();
                img.dataset.retryCount = '0';
                img.onload = function() {
                    imgElement.src = coverUrl;
                    imgElement.style.display = 'block';
                    placeholder.style.display = 'none';
                };
                img.onerror = function() {
                    const retryCount = parseInt(this.dataset.retryCount) || 0;
                    if (retryCount < 2) {
                        this.dataset.retryCount = retryCount + 1;
                        setTimeout(() => {
                            this.src = coverUrl + '&retry=' + retryCount;
                        }, 1000);
                    } else {
                    }
                };
                img.src = coverUrl;
            }
        }

        async function addSongToPlaylist(songId, autoPlay = false) {
            if (playlistSongs.some(s => String(s.id) === String(songId))) {
                if (autoPlay) {
                    playSong(songId, true);
                } else {
                    showStatusMessage('歌曲已在播放列表中', 'info');
                }
                return;
            }

            try {
                const searchParams = { id: songId, type: currentPlatform };
                const result = await makeRequest(musicSearchAPI, searchParams);
                if (result && result.code === 1 && result.data) {
                    const songData = result.data;
                    const songInfo = {
                        id: songId,
                        name: songData.name || '未知歌曲',
                        artist: songData.artist || '未知艺术家',
                        cover: songData.pic || '',
                        album: songData.album || '',
                        duration: songData.timeLength || 0
                    };
                    playlistSongs.push(songInfo);
                    updatePlaylistUI();

                    if (autoPlay) {
                        playSong(songId, true);
                    } else {
                        showStatusMessage(`已添加《${songInfo.name}》到播放列表`, 'success');
                    }
                } else {
                    showStatusMessage('无法获取歌曲信息', 'error');
                }
            } catch (error) {
                showStatusMessage(`添加失败: ${error.message}`, 'error');
            }
        }

        function updatePlaylistUI() {
            playlistSongs = deduplicatePlaylist(playlistSongs);

            const playlistContent = document.getElementById('playlistContent');
            if (!playlistContent) return;

            if (playlistSongs.length === 0) {
                playlistContent.innerHTML = '<div class="playlist-empty"><i class="fas fa-music"></i><p>播放列表为空，请添加歌曲</p></div>';
                return;
            }

            let html = '';
            playlistSongs.forEach((song, index) => {
                const isActive = (String(song.id) === String(currentSongId)) ? 'active' : '';
                const coverPlaceholder = `<div class="cover-placeholder" style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-music"></i></div>`;
                const coverImg = song.cover ? `<img src="${song.cover}" alt="cover" style="display: none;" onload="this.style.display='block'; this.parentElement.querySelector('.cover-placeholder').style.display='none';" onerror="this.style.display='none'; this.parentElement.querySelector('.cover-placeholder').style.display='flex';">` : '';

                html += `
                    <div class="playlist-item ${isActive}" data-id="${song.id}" data-index="${index}">
                        <div class="playlist-item-cover">
                            ${coverPlaceholder}
                            ${coverImg}
                        </div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${escapeHTML(song.name)}</div>
                            <div class="playlist-item-artist">${escapeHTML(song.artist)}</div>
                        </div>
                        <button class="playlist-remove-btn" data-id="${song.id}" title="从列表移除">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });

            playlistContent.innerHTML = html;

            document.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.closest('.playlist-remove-btn')) return;
                    const songId = this.dataset.id;
                    playSong(songId, true);
                });
            });

            document.querySelectorAll('.playlist-remove-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const songId = this.dataset.id;
                    playlistSongs = playlistSongs.filter(s => String(s.id) !== String(songId));
                    if (String(currentSongId) === String(songId)) {
                        audioPlayer.pause();
                        audioPlayer.removeAttribute('src');
                        currentSongId = null;
                        playerTitle.textContent = '未选择歌曲';
                        playerArtist.textContent = '--';
                        playerLyricsLine.textContent = '';
                        playerAlbumArt.src = '';
                        playerAlbumArt.style.display = 'none';
                        const placeholder = document.querySelector('.player-cover .cover-placeholder');
                        if (placeholder) placeholder.style.display = 'flex';
                    }
                    updatePlaylistUI();
                    showStatusMessage('已从播放列表移除', 'success');
                });
            });
        }

        async function playSong(songId, autoPlay = false, songObj = null) {
            songId = String(songId);
            
            if (isPlayingSong) {
                return;
            }

            if (currentSongId === songId && audioPlayer.src) {
                isPlayingSong = true;
                try {
                    if (autoPlay) {
                        if (isPlaying) {
                            audioPlayer.pause();
                        } else {
                            audioPlayer.play().catch(e => {
                                showStatusMessage('播放失败: ' + e.message, 'error');
                            });
                        }
                    }
                } finally {
                    isPlayingSong = false;
                }
                return;
            }

            isPlayingSong = true;

            try {
                hasPlayedCurrentSong = false;

                if (floatingPlayer.style.display === 'none') {
                    floatingPlayer.style.display = 'flex';
                    isPlayerHiddenByUser = false;
                    updatePlayerVisibilityButtonState();
                    updateToolbarPosition();
                    localStorage.setItem('playerHidden', 'false');
                }
                if (isPlaybackActive && lastUpdateTime !== null) {
                    const now = Date.now();
                    const delta = now - lastUpdateTime;
                    if (delta > 0) {
                        const totalPlayTime = parseInt(localStorage.getItem('totalPlayTime') || 0) + delta;
                        localStorage.setItem('totalPlayTime', totalPlayTime);
                        if (currentPage === 'profile') {
                            updateProfilePage();
                        }
                    }
                    lastUpdateTime = null;
                }
                isPlaybackActive = false;

            songId = String(songId);

            const cacheKey = `${currentPlatform}_${songId}`;
            const cachedData = songCache.get(cacheKey);
            let result;

            if (cachedData && Date.now() - cachedData.timestamp < SONG_CACHE_EXPIRY) {
                result = cachedData.data;
            } else {
                const searchParams = {
                    id: songId,
                    type: currentPlatform
                };
                result = await makeRequest(musicSearchAPI, searchParams);

                if (result && result.code === 1 && result.data) {
                    songCache.set(cacheKey, {
                        data: result,
                        timestamp: Date.now()
                    });
                }
            }

            if (!result || result.code !== 1 || !result.data) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }

            const songData = result.data;
            const song = {
                    id: songId,
                    name: songData.name || '未知歌曲',
                    artist: songData.artist || '未知艺术家',
                    cover: songData.pic || '',
                    album: songData.album || '',
                    duration: songData.timeLength || 0
                };

                if (!songData.url) {
                    showStatusMessage('无法获取歌曲播放链接，请稍后重试', 'error');
                    return;
                }

                currentSongId = songId;
                currentSongInfo = song;

                const exists = playlistSongs.some(s => String(s.id) === String(songId));
                if (!exists) {
                    playlistSongs.push({
                        id: songId,
                        name: song.name,
                        artist: song.artist,
                        cover: song.cover,
                        album: song.album,
                        duration: song.duration
                    });
                    updatePlaylistUI();
                }

                if (currentPage === 'search') {
                    refreshSongItem(songId, result);
                }

                handlePlayLinkResult(result, song, autoPlay);

                const totalPlayCount = parseInt(localStorage.getItem('totalPlayCount') || 0) + 1;
                localStorage.setItem('totalPlayCount', totalPlayCount);
                if (currentPage === 'profile') {
                    updateProfilePage();
                }

                document.querySelectorAll('.song-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.id === songId) {
                        item.classList.add('active');
                        if (item) {
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });

                const playlistPanel = document.getElementById('playlistPanel');
                if (playlistPanel && playlistPanel.classList.contains('active')) {
                    updatePlaylistUI();
                }

                showStatusMessage(`准备播放: ${song.name}`, 'success');

            } catch (error) {
                showStatusMessage(`播放失败: ${error.message}`, 'error');
            } finally {
                isPlayingSong = false;
            }
        }

        async function musicSearchAPI(params) {
            return new Promise((resolve, reject) => {
                if (!params.id || !params.type) {
                    reject(new Error("缺少必填参数：id或type"));
                    return;
                }

                const requestUrl = "https://yunzhiapi.cn/API/yyjhss.php";
                const queryParams = new URLSearchParams();

                queryParams.append("id", params.id);
                queryParams.append("type", params.type);

                if (yunzhiToken) {
                    queryParams.append("token", yunzhiToken);
                }

                fetch(`${requestUrl}?${queryParams.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态码: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        resolve(data);
                    })
                    .catch(error => {
                        if (error.message.includes("HTTP error")) {
                            reject(new Error("服务器响应错误"));
                        } else {
                            reject(new Error("网络请求失败: " + error.message));
                        }
                    });
            });
        }

        async function fetchLrcLyrics(id, msg, type = 'text') {
            if (!id || !msg) {
                return {
                    error: true,
                    message: '缺少必填参数: id 和 msg 都不能为空'
                };
            }

            const validMsgs = ['qq', 'wy', 'kw', 'qi'];
            if (!validMsgs.includes(msg)) {
                return {
                    error: true,
                    message: 'msg参数错误: 只支持 qq(QQ音乐)、wy(网易云音乐)、kw(酷我音乐)、qi(千千音乐)'
                };
            }

            const params = new URLSearchParams();
            params.append('id', id);
            params.append('msg', msg);
            params.append('type', type);

            if (yunzhiToken) {
                params.append('token', yunzhiToken);
            }

            try {
                const response = await fetch('https://yunzhiapi.cn/API/jhlrcgc.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }

                if (type === 'json') {
                    const data = await response.json();
                    return data;
                } else {
                    const text = await response.text();
                    return text;
                }
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }

        async function searchJiaXinSongs(title, server = 'netease') {
            if (!jiaxinApiKey) {
                return {
                    error: true,
                    message: '请先配置佳欣歌词API Key'
                };
            }

            const params = new URLSearchParams();
            params.append('key', jiaxinApiKey);
            params.append('title', title);
            params.append('server', server);

            try {
                const response = await fetch(`https://apix.iqfk.top/api/lyric?${params.toString()}`);

                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }

        async function fetchJiaXinLyrics(server, id, auth) {
            if (!jiaxinApiKey) {
                return {
                    error: true,
                    message: '请先配置佳欣歌词API Key'
                };
            }

            const params = new URLSearchParams();
            params.append('key', jiaxinApiKey);
            params.append('server', server);
            params.append('id', id);
            params.append('auth', auth);

            try {
                const response = await fetch(`https://apix.iqfk.top/api/lyric?${params.toString()}`);

                if (!response.ok) {
                    return {
                        error: true,
                        message: `请求失败: HTTP状态码 ${response.status}`
                    };
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                return {
                    error: true,
                    message: `请求出错: ${error.message}`
                };
            }
        }

        function parseLrcParams(lrcString) {
            const params = new URLSearchParams(lrcString);
            return {
                server: params.get('server'),
                id: params.get('id'),
                auth: params.get('auth')
            };
        }

        function handlePlayLinkResult(data, song, autoPlay = false) {
            updatePlayerSection(data, song, autoPlay);
        }
        async function updatePlayerSection(data, song, autoPlay = false) {
            if (isUpdatingPlayer) {
                return;
            }
            isUpdatingPlayer = true;

            try {
                if (currentTimeoutId) {
                    clearTimeout(currentTimeoutId);
                    currentTimeoutId = null;
                }
                if (currentPlayWhenReady) {
                    audioPlayer.removeEventListener('canplay', currentPlayWhenReady);
                    currentPlayWhenReady = null;
                }
                if (currentClearTimeoutHandler) {
                    audioPlayer.removeEventListener('canplay', currentClearTimeoutHandler);
                    currentClearTimeoutHandler = null;
                }

                audioPlayer.pause();
                audioPlayer.removeAttribute('src');
                audioPlayer.currentTime = 0;

                if (song) {
                    playerTitle.textContent = song.name || '未知歌曲';
                    playerArtist.textContent = song.artist || '未知艺术家';
                } else {
                    playerTitle.textContent = '未知歌曲';
                    playerArtist.textContent = '未知艺术家';
                }

                updateFullscreenInfo();
                
                playerLyricsLine.textContent = '';
                playerLyricsLine.classList.remove('active');

                resetLyricsSources();

                if (data && data.code === 1 && data.data) {
                    const songData = data.data;

                    if (songData.pic) {
                        playerAlbumArt.src = songData.pic;
                        playerAlbumArt.style.display = 'block';
                        playerAlbumArt.parentElement.querySelector('.cover-placeholder').style.display = 'none';

                        playerAlbumArt.onerror = function() {
                            this.style.display = 'none';
                            const placeholder = this.parentElement.querySelector('.cover-placeholder');
                            if (placeholder) {
                                placeholder.style.display = 'flex';
                                placeholder.innerHTML = '<i class="fas fa-music"></i>';
                            }
                            if (fullscreenPlayer && fullscreenPlayer.classList.contains('active')) {
                                fullscreenAlbumArt.src = '';
                            }
                        };

                        playerAlbumArt.onload = function() {
                            if (fullscreenPlayer && fullscreenPlayer.classList.contains('active')) {
                                fullscreenAlbumArt.src = playerAlbumArt.src;
                            }
                        };

                        if (fullscreenPlayer && fullscreenPlayer.classList.contains('active')) {
                            fullscreenAlbumArt.src = songData.pic;
                        }
                    }

                    if (songData.url) {
                        const decodedUrl = songData.url.replace(/\\\//g, '/');

                        const isSameSong = audioPlayer.src === decodedUrl && currentSongId === song.id;

                        if (!isSameSong) {
                            audioPlayer.pause();
                            audioPlayer.removeAttribute('src');
                            audioPlayer.currentTime = 0;

                            audioPlayer.src = decodedUrl;
                        }
                        
                        hasPlayedCurrentSong = false;

                        audioPlayer.playbackRate = currentPlaybackRate;

                        isPlaying = false;
                        updatePlayPauseButton();
                        updatePlayerDisplay();

                        if (autoPlay) {
                            const playAudio = () => {
                                if (hasPlayedCurrentSong) {
                                    return;
                                }

                                if (currentSongId !== song.id) {
                                    return;
                                }

                                hasPlayedCurrentSong = true;

                                audioPlayer.play().catch(e => {
                                    hasPlayedCurrentSong = false;
                                    isPlaying = false;
                                    updatePlayPauseButton();
                                    if (e.name === 'AbortError') {
                                        showStatusMessage('播放被中断', 'warning');
                                    } else if (e.name === 'NotAllowedError') {
                                        showStatusMessage('浏览器阻止了自动播放，请手动点击播放按钮', 'warning');
                                    } else {
                                        showStatusMessage('播放失败: ' + e.message, 'error');
                                    }
                                });
                            };

                            if (currentPlayWhenReady) {
                                audioPlayer.removeEventListener('canplay', currentPlayWhenReady);
                            }
                            if (currentClearTimeoutHandler) {
                                audioPlayer.removeEventListener('canplay', currentClearTimeoutHandler);
                            }
                            if (currentTimeoutId) {
                                clearTimeout(currentTimeoutId);
                                currentTimeoutId = null;
                            }

                            if (!isSameSong) {
                                audioPlayer.load();
                            }

                            playAudio();

                            preloadNextSong();
                        } else {
                            if (!isSameSong) {
                                audioPlayer.load();
                            }
                        }
                    }

                    if (songData.lrc) {
                        parseAndDisplayLyrics(songData.lrc, 'original');
                        addLyricsSource('original', '原始歌词');

                        if (song) {
                            fetchJiaXinLyricsSources(song);
                        }
                    } else {
                        displaySimpleLyrics('暂无歌词');

                        if (song) {
                            fetchJiaXinLyricsSources(song);
                        }
                    }
                } else {
                    displaySimpleLyrics('无法获取歌曲详情');
                    
                    playerAlbumArt.style.display = 'none';
                    playerAlbumArt.parentElement.querySelector('.cover-placeholder').style.display = 'flex';
                    playerAlbumArt.onerror = null;
                    
                    audioPlayer.src = '';
                    isPlaying = false;
                    updatePlayPauseButton();
                    updatePlayerDisplay();
                }
            } catch (error) {
                showStatusMessage('更新播放器失败: ' + error.message, 'error');
            } finally {
                isUpdatingPlayer = false;
            }
        }

        function resetLyricsSources() {
            if (lyricsSourceDropdown) {
                lyricsSourceDropdown.innerHTML = '';
            }
            availableLyricsSources = [];
            currentLyricsSource = 'original';
            lyricsSourceBadge.textContent = '';
            if (lyricsSourceText) {
                lyricsSourceText.textContent = '选择歌词源';
            }
        }

        function addLyricsSource(source, name) {
            if (availableLyricsSources.includes(source)) return;
            
            availableLyricsSources.push(source);
            
            const sourceItem = document.createElement('div');
            sourceItem.className = 'lyrics-source-item';
            if (source === currentLyricsSource) {
                sourceItem.classList.add('active');
                lyricsSourceText.textContent = name;
            }
            sourceItem.dataset.source = source;
            sourceItem.textContent = name;
            sourceItem.title = `切换至${name}歌词`;
            
            if (source.startsWith('jx-')) {
                if (!jiaxinApiKey) {
                    sourceItem.title = `${name} (需要配置API Key)`;
                }
            }

            sourceItem.addEventListener('click', function() {
                switchLyricsSource(source);
                lyricsSourceDropdown.classList.remove('active');
                lyricsSourceTrigger.classList.remove('active');
            });

            lyricsSourceDropdown.appendChild(sourceItem);
        }

        function setLyricsSourceLoading(source, isLoading) {
            const sourceItem = lyricsSourceDropdown.querySelector(`.lyrics-source-item[data-source="${source}"]`);
            if (sourceItem) {
                if (isLoading) {
                    sourceItem.classList.add('loading');
                    sourceItem.innerHTML = '<i class="fas fa-spinner fa-spin lyrics-loading-spinner"></i> ' + (lyricsSourceNames[source] || source);
                } else {
                    sourceItem.classList.remove('loading');
                    sourceItem.textContent = lyricsSourceNames[source] || source;
                }
            }
        }

        async function switchLyricsSource(source) {
            if (source === currentLyricsSource) return;
            
            if (source.startsWith('jx-') && !jiaxinApiKey) {
                showStatusMessage('请先配置佳欣歌词API Key', 'warning');
                jiaxinConfigPanel.classList.add('active');
                return;
            }

            document.querySelectorAll('.lyrics-source-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.source === source) {
                    item.classList.add('active');
                    lyricsSourceText.textContent = item.textContent;
                }
            });
            
            currentLyricsSource = source;
            lyricsSourceBadge.textContent = lyricsSourceNames[source] || source;
            localStorage.setItem('preferredLyricsSource', source);

            if (source === 'original') {
                try {
                    const searchParams = { id: currentSongId, type: currentPlatform };
                    const result = await makeRequest(musicSearchAPI, searchParams);
                    if (result && result.code === 1 && result.data && result.data.lrc) {
                        parseAndDisplayLyrics(result.data.lrc, source);
                    } else {
                        displaySimpleLyrics('暂无歌词');
                    }
                } catch (error) {
                    displaySimpleLyrics('获取歌词失败');
                }
            } else if (source.startsWith('jx-')) {
                await fetchLyricsFromJiaXin(source);
            }

            showStatusMessage(`已切换至${lyricsSourceNames[source] || source}歌词`, 'info');
        }

        async function fetchLyricsFromJiaXin(source) {
            if (!currentSongInfo || !jiaxinApiKey) {
                showStatusMessage('请先配置佳欣歌词API Key', 'warning');
                return;
            }

            setLyricsSourceLoading(source, true);

            try {
                const server = source === 'jx-netease' ? 'netease' : 'tencent';

                const searchResult = await searchJiaXinSongs(currentSongInfo.name, server);

                if (searchResult && searchResult.code === 200 && searchResult.data && searchResult.data.length > 0) {
                    const firstResult = searchResult.data[0];
                    const lrcParams = parseLrcParams(firstResult.lrc);

                    if (lrcParams.server && lrcParams.id && lrcParams.auth) {
                        const lyricsResult = await fetchJiaXinLyrics(
                            lrcParams.server,
                            lrcParams.id,
                            lrcParams.auth
                        );

                        if (lyricsResult && lyricsResult.code === 200 && lyricsResult.data && lyricsResult.data.lyrics) {
                            parseAndDisplayLyrics(lyricsResult.data.lyrics, source);
                        } else {
                            displaySimpleLyrics(`暂无${lyricsSourceNames[source]}歌词`);
                        }
                    } else {
                        displaySimpleLyrics(`无法解析${lyricsSourceNames[source]}歌词参数`);
                    }
                } else {
                    const errorMsg = searchResult ? searchResult.message : '搜索失败';
                    displaySimpleLyrics(`无法获取${lyricsSourceNames[source]}歌词: ${errorMsg}`);
                }

                setLyricsSourceLoading(source, false);
            } catch (error) {
                displaySimpleLyrics(`获取${lyricsSourceNames[source]}歌词失败`);
                setLyricsSourceLoading(source, false);
            }
        }

        function fetchJiaXinLyricsSources(song) {
            if (!song || !song.name) return;
            
            addLyricsSource('jx-netease', '佳欣歌词(网易)');
            addLyricsSource('jx-tencent', '佳欣歌词(腾讯)');
            
            if (!jiaxinApiKey) {
                showStatusMessage('佳欣歌词API需要配置Key，点击歌词源按钮进行配置', 'info');
            }
        }

        function updatePlayerLyricsLine() {
            if (lyricsData.length === 0 || !audioPlayer.currentTime) {
                playerLyricsLine.textContent = '';
                playerLyricsLine.classList.remove('active');
                return;
            }
            
            const currentTime = audioPlayer.currentTime;
            let currentLyricText = '';
            
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= currentTime && lyricsData[i].time >= 0) {
                    if (i === lyricsData.length - 1 || lyricsData[i + 1].time > currentTime) {
                        currentLyricText = lyricsData[i].text;
                        break;
                    }
                }
            }
            
            if (currentLyricText) {
                playerLyricsLine.textContent = currentLyricText;
                playerLyricsLine.classList.add('active');
            } else {
                playerLyricsLine.textContent = '';
                playerLyricsLine.classList.remove('active');
            }
        }

        function parseLyrics(lrcText) {
            const lines = lrcText.split('\n');
            const lyrics = [];
            
            const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/g;
            
            lines.forEach(line => {
                const matches = [...line.matchAll(timeRegex)];
                
                if (matches.length > 0) {
                    const text = line.replace(timeRegex, '').trim();
                    
                    matches.forEach(match => {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const milliseconds = match[3] ? parseInt(match[3].padEnd(3, '0')) : 0;
                        
                        const timeInSeconds = minutes * 60 + seconds + milliseconds / 1000;
                        
                        if (text) {
                            lyrics.push({
                                time: timeInSeconds,
                                text: text
                            });
                        }
                    });
                } else if (line.trim()) {
                    lyrics.push({
                        time: -1,
                        text: line.trim()
                    });
                }
            });
            
            lyrics.sort((a, b) => a.time - b.time);
            
            return lyrics;
        }

        function parseAndDisplayLyrics(lrcText, source = 'original') {
            lyricsData = parseLyrics(lrcText);
            currentLyricIndex = -1;
            
            playerLyrics.innerHTML = '';
            
            if (lyricsData.length === 0) {
                displaySimpleLyrics(lrcText);
                return;
            }
            
            lyricsData.forEach((lyric, index) => {
                const lineElement = document.createElement('div');
                lineElement.className = 'lyrics-line';
                lineElement.dataset.index = index;
                lineElement.dataset.time = lyric.time;
                lineElement.textContent = lyric.text;
                lineElement.addEventListener('click', function() {
                    const time = parseFloat(this.dataset.time);
                    if (!isNaN(time) && time >= 0) {
                        audioPlayer.currentTime = time;
                        if (!isPlaying) audioPlayer.play();
                    }
                });
                
                playerLyrics.appendChild(lineElement);
            });
            
            if (isLyricsVisible) {
                setTimeout(adjustLyricsCardSize, 100);
            }
            
            if (isLyricsVisible && isPlaying) {
                startLyricsHighlight();
            }
            
            updatePlayerLyricsLine();
            
            lyricsSourceBadge.textContent = lyricsSourceNames[source] || source;
            
            if (fullscreenPlayer && fullscreenPlayer.classList.contains('active')) {
                renderFullscreenLyrics();
            }
        }

        function displaySimpleLyrics(text) {
            lyricsData = [];
            currentLyricIndex = -1;
            playerLyrics.innerHTML = text;
            playerLyricsLine.textContent = '';
            playerLyricsLine.classList.remove('active');
            lyricsSourceBadge.textContent = '';
        }

        function startLyricsHighlight() {
            if (lyricsData.length === 0) return;
            
            stopLyricsHighlight();
            
            updateLyricsHighlight();
            
            lyricsScrollInterval = setInterval(updateLyricsHighlight, 100);
        }

        function stopLyricsHighlight() {
            if (lyricsScrollInterval) {
                clearInterval(lyricsScrollInterval);
                lyricsScrollInterval = null;
            }
        }

        function updateLyricsHighlight() {
            if (lyricsData.length === 0 || !audioPlayer.currentTime) return;
            
            const currentTime = audioPlayer.currentTime;
            let newIndex = -1;
            
            for (let i = 0; i < lyricsData.length; i++) {
                if (lyricsData[i].time <= currentTime && lyricsData[i].time >= 0) {
                    if (i === lyricsData.length - 1 || lyricsData[i + 1].time > currentTime) {
                        newIndex = i;
                        break;
                    }
                }
            }
            
            if (newIndex !== -1 && newIndex !== currentLyricIndex) {
                if (currentLyricIndex !== -1) {
                    const prevLine = playerLyrics.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                    if (prevLine) {
                        prevLine.classList.remove('active');
                        prevLine.classList.add('past');
                    }
                    if (fullscreenPlayer.classList.contains('active')) {
                        const prevFullLine = fullscreenLyrics.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                        if (prevFullLine) {
                            prevFullLine.classList.remove('active');
                            prevFullLine.classList.add('past');
                        }
                    }
                }
                
                const newLine = playerLyrics.querySelector(`.lyrics-line[data-index="${newIndex}"]`);
                if (newLine) {
                    newLine.classList.add('active');
                    newLine.classList.remove('past', 'future');
                    scrollToLyricLine(newLine);
                    updateFutureLyricsStyle(newIndex);
                }
                if (fullscreenPlayer.classList.contains('active')) {
                    const newFullLine = fullscreenLyrics.querySelector(`.lyrics-line[data-index="${newIndex}"]`);
                    if (newFullLine) {
                        newFullLine.classList.add('active');
                        newFullLine.classList.remove('past', 'future');
                        newFullLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                currentLyricIndex = newIndex;
            }
        }

        function updateFutureLyricsStyle(currentIndex) {
            const allLines = playerLyrics.querySelectorAll('.lyrics-line');
            
            allLines.forEach((line, index) => {
                if (index > currentIndex) {
                    line.classList.remove('past', 'active');
                    line.classList.add('future');
                } else if (index < currentIndex) {
                    line.classList.remove('active', 'future');
                    line.classList.add('past');
                }
            });
        }

        function scrollToLyricLine(lineElement) {
            if (!lineElement || !playerLyrics) return;
            
            const container = playerLyrics;
            const lineHeight = lineElement.offsetHeight;
            const containerHeight = container.offsetHeight;
            const lineTop = lineElement.offsetTop;

            const targetScrollTop = lineTop - (containerHeight / 2) + (lineHeight / 2);

            const maxScrollTop = container.scrollHeight - containerHeight;
            const finalScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));

            container.scrollTo({
                top: finalScrollTop,
                behavior: 'smooth'
            });
        }

        function adjustLyricsCardSize() {
            if (!isLyricsVisible || !lyricsPanel) return;
            
            const lyricsContent = playerLyrics;
            if (!lyricsContent) return;
            
            const lyricLines = lyricsContent.querySelectorAll('.lyrics-line');
            if (lyricLines.length === 0) return;
            
            let totalHeight = 0;
            lyricLines.forEach(line => {
                totalHeight += line.offsetHeight;
            });
            const avgLineHeight = totalHeight / lyricLines.length;
            
            const visibleLines = 7; 
            const optimalHeight = avgLineHeight * visibleLines;
            
            const minHeight = 200;
            const maxHeight = window.innerHeight * 0.6; 
            const finalHeight = Math.max(minHeight, Math.min(optimalHeight, maxHeight));
            
            lyricsPanel.style.height = `${finalHeight}px`;
            
            if (currentLyricIndex !== -1) {
                const currentLine = lyricsContent.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                if (currentLine) {
                    scrollToLyricLine(currentLine);
                }
            }
        }

        function updateLyricsPanelOpacity(opacity) {
            if (!lyricsPanel) return;
            
            localStorage.setItem('lyricsOpacity', opacity);
        
            const baseColor = document.body.classList.contains('new-year-theme') ? '43, 45, 66' : '15, 23, 42';
            
            lyricsPanel.style.background = `rgba(${baseColor}, ${opacity})`;
            
            const lyricsContent = playerLyrics;
            if (lyricsContent) {
                lyricsContent.style.background = `rgba(${baseColor}, ${Math.max(0, opacity - 0.1)})`;
            }
            
            if (lyricsSourceDropdown) {
                lyricsSourceDropdown.style.background = `rgba(${baseColor}, ${opacity})`;
            }
            
            if (lyricsSourceTrigger) {
                lyricsSourceTrigger.style.background = `rgba(255, 255, 255, ${opacity * 0.05})`;
            }
        }

        function updatePlayerDisplay() {
            if (!audioPlayer.duration || isNaN(audioPlayer.duration)) {
                currentTimeElement.textContent = "00:00";
                totalTimeElement.textContent = "00:00";
                progressBar.style.width = "0%";
                progressBuffer.style.width = "0%";
                progressHandle.style.left = "0%";
                
                const bottomProgressBar = document.getElementById('bottomProgressBar');
                if (bottomProgressBar) {
                    bottomProgressBar.style.width = "0%";
                }
                return;
            }
            
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            const progressPercent = (currentTime / duration) * 100;
            
            currentTimeElement.textContent = formatTime(currentTime);
            totalTimeElement.textContent = formatTime(duration);
            progressBar.style.width = `${progressPercent}%`;
            progressHandle.style.left = `${progressPercent}%`;
            
            const bottomProgressBar = document.getElementById('bottomProgressBar');
            if (bottomProgressBar) {
                bottomProgressBar.style.width = `${progressPercent}%`;
            }
            
            if (audioPlayer.buffered.length > 0) {
                const bufferedEnd = audioPlayer.buffered.end(audioPlayer.buffered.length - 1);
                const bufferedPercent = (bufferedEnd / duration) * 100;
                progressBuffer.style.width = `${bufferedPercent}%`;
            }

        }

        function updateBufferProgress() {
            if (!audioPlayer.duration || isNaN(audioPlayer.duration)) {
                progressBuffer.style.width = "0%";
                return;
            }
            
            if (audioPlayer.buffered.length > 0) {
                const duration = audioPlayer.duration;
                const bufferedEnd = audioPlayer.buffered.end(audioPlayer.buffered.length - 1);
                const bufferedPercent = (bufferedEnd / duration) * 100;
                progressBuffer.style.width = `${Math.min(bufferedPercent, 100)}%`;
            }
        }

        function preloadNextSong() {
            if (playlistSongs.length === 0) {
                return;
            }

            const currentIndex = playlistSongs.findIndex(song => String(song.id) === String(currentSongId));
            let nextIndex;

            if (currentIndex === -1) {
                nextIndex = 0;
            } else {
                if (playModes[currentPlayModeIndex] === 'random') {
                    do {
                        nextIndex = Math.floor(Math.random() * playlistSongs.length);
                    } while (playlistSongs.length > 1 && nextIndex === currentIndex);
                } else {
                    nextIndex = currentIndex + 1;
                    if (nextIndex >= playlistSongs.length) nextIndex = 0;
                }
            }

            if (nextIndex >= 0 && nextIndex < playlistSongs.length) {
                const nextSong = playlistSongs[nextIndex];
                const cacheKey = `${currentPlatform}_${nextSong.id}`;
                
                if (songCache.has(cacheKey)) {
                    const cachedData = songCache.get(cacheKey);
                    if (cachedData && cachedData.data && cachedData.data.data && cachedData.data.data.url) {
                        const nextSongUrl = cachedData.data.data.url.replace(/\\\//g, '/');
                        if (audioPreloader.src !== nextSongUrl) {
                            audioPreloader.src = nextSongUrl;
                            audioPreloader.load();
                        }
                    }
                }
            }
        }

        function togglePlayPause() {
            if (floatingPlayer.style.display === 'none') {
                floatingPlayer.style.display = 'flex';
                isPlayerHiddenByUser = false;
                updatePlayerVisibilityButtonState();
                updateToolbarPosition();
                localStorage.setItem('playerHidden', 'false');
            }
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(e => {
                    showStatusMessage("播放失败: " + e.message, 'error');
                });
            }
        }

        function updatePlayPauseButton() {
            const icon = playPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
                playPauseBtn.title = "暂停";
            } else {
                icon.className = 'fas fa-play';
                playPauseBtn.title = "播放";
            }
            
            updateFullscreenPlayPauseButton();
        }

        function updateFullscreenInfo() {
            fullscreenTitle.textContent = playerTitle.textContent;
            fullscreenArtist.textContent = playerArtist.textContent;
            if (playerAlbumArt.src && playerAlbumArt.src !== '') {
                fullscreenAlbumArt.src = playerAlbumArt.src;
            } else {
                fullscreenAlbumArt.src = '';
            }
        }

        function renderFullscreenLyrics() {
            if (!fullscreenLyrics) return;
            fullscreenLyrics.innerHTML = '';
            if (lyricsData.length === 0) {
                fullscreenLyrics.innerHTML = '<div class="lyrics-line" style="text-align:center;">暂无歌词</div>';
                return;
            }
            lyricsData.forEach((lyric, index) => {
                const line = document.createElement('div');
                line.className = 'lyrics-line';
                line.dataset.index = index;
                line.dataset.time = lyric.time;
                line.textContent = lyric.text;
                line.addEventListener('click', function() {
                    const time = parseFloat(this.dataset.time);
                    if (!isNaN(time) && time >= 0) {
                        audioPlayer.currentTime = time;
                        if (!isPlaying) audioPlayer.play();
                    }
                });
                fullscreenLyrics.appendChild(line);
            });
            if (currentLyricIndex !== -1) {
                const activeLine = fullscreenLyrics.querySelector(`.lyrics-line[data-index="${currentLyricIndex}"]`);
                if (activeLine) {
                    activeLine.classList.add('active');
                    activeLine.scrollIntoView({ behavior: 'auto', block: 'center' });
                }
            }
        }

        function clearFullscreenLyrics() {
            if (fullscreenLyrics) fullscreenLyrics.innerHTML = '';
        }

        function updateFullscreenPlayPauseButton() {
            const icon = fullscreenPlayPauseBtn.querySelector('i');
            if (isPlaying) {
                icon.className = 'fas fa-pause';
            } else {
                icon.className = 'fas fa-play';
            }
        }

        function togglePlayMode() {
            currentPlayModeIndex = (currentPlayModeIndex + 1) % playModes.length;
            updatePlayModeDisplay(true);
        }

        function updatePlayModeDisplay(showMessage = false) {
            const mode = playModes[currentPlayModeIndex];
            const icon = playModeBtn.querySelector('i');
            let modeText = '';
            
            audioPlayer.loop = false;
            
            switch(mode) {
                case 'order':
                    icon.className = 'fas fa-retweet';
                    modeText = '顺序播放';
                    break;
                case 'loop':
                    icon.className = 'fas fa-redo';
                    modeText = '单曲循环';
                    break;
                case 'random':
                    icon.className = 'fas fa-random';
                    modeText = '随机播放';
                    break;
            }
            
            playModeBtn.title = modeText;
            playModeBtn.classList.toggle('active', mode !== 'order');
            if (showMessage) {
                showStatusMessage(`播放模式: ${modeText}`, 'info');
            }
            
        }

        function initPlaybackRateMenu() {
            const dropdown = document.getElementById('playbackRateDropdown');
            const rateText = document.getElementById('playbackRateText');
            
            dropdown.innerHTML = '';
            
            playbackRates.forEach((rate, index) => {
                const option = document.createElement('div');
                option.className = `playback-rate-option ${index === currentPlaybackRateIndex ? 'active' : ''}`;
                option.textContent = `${rate}x`;
                option.title = `播放速度: ${rate}x`;
                
                option.addEventListener('click', function() {
                    currentPlaybackRateIndex = index;
                    currentPlaybackRate = rate;
                    
                    audioPlayer.playbackRate = rate;
                    
                    rateText.textContent = `${rate}x`;
                    playbackRateBtn.title = `播放速度: ${rate}x`;
                    
                    dropdown.querySelectorAll('.playback-rate-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    option.classList.add('active');
                    
                    dropdown.classList.remove('active');
                    
                    showStatusMessage(`播放速度: ${rate}x`, 'info');
                });
                
                dropdown.appendChild(option);
            });
        }

        function togglePlaybackRate() {
            currentPlaybackRateIndex = (currentPlaybackRateIndex + 1) % playbackRates.length;
            currentPlaybackRate = playbackRates[currentPlaybackRateIndex];
            
            audioPlayer.playbackRate = currentPlaybackRate;
            
            const rateText = document.getElementById('playbackRateText');
            rateText.textContent = `${currentPlaybackRate}x`;
            playbackRateBtn.title = `播放速度: ${currentPlaybackRate}x`;
            
            const dropdown = document.getElementById('playbackRateDropdown');
            dropdown.querySelectorAll('.playback-rate-option').forEach((opt, index) => {
                opt.classList.toggle('active', index === currentPlaybackRateIndex);
            });
            
            showStatusMessage(`播放速度: ${currentPlaybackRate}x`, 'info');
        }

        function toggleMute() {
            audioPlayer.muted = !audioPlayer.muted;
            updateVolumeButton();
        }

        function updateVolumeButton() {
            const icon = volumeBtn.querySelector('i');
            const volume = audioPlayer.muted ? 0 : audioPlayer.volume;
            
            if (volume === 0) {
                icon.className = 'fas fa-volume-mute';
                volumeBtn.title = "取消静音";
            } else if (volume < 0.5) {
                icon.className = 'fas fa-volume-down';
                volumeBtn.title = "音量";
            } else {
                icon.className = 'fas fa-volume-up';
                volumeBtn.title = "静音";
            }
            
            if (!audioPlayer.muted) {
                volumeSlider.value = volume * 100;
            }
        }

        function updatePlayerOpacity(opacity) {
            const normalizedOpacity = opacity / 100;
            const playerSection = document.querySelector('.player-section');
            if (playerSection) {
                playerSection.style.backgroundColor = `rgba(15, 23, 42, ${normalizedOpacity * 0.95})`;
                playerSection.style.backdropFilter = `blur(${20 * normalizedOpacity}px)`;
            }
            
            const floatingPlayer = document.querySelector('.floating-player');
            if (floatingPlayer) {
                floatingPlayer.style.backgroundColor = `rgba(15, 23, 42, ${normalizedOpacity * 0.95})`;
                floatingPlayer.style.backdropFilter = `blur(${20 * normalizedOpacity}px)`;
            }
            
            const lyricsPanel = document.getElementById('lyricsPanel');
            if (lyricsPanel && lyricsPanel.style.display !== 'none') {
                lyricsPanel.style.backgroundColor = `rgba(15, 23, 42, ${normalizedOpacity * 0.95})`;
                lyricsPanel.style.backdropFilter = `blur(${20 * normalizedOpacity}px)`;
            }
            
            localStorage.setItem('playerOpacity', normalizedOpacity);
        }

        function updateTextOpacity(opacity) {
            const normalizedOpacity = opacity / 100;

            const playerTextElements = document.querySelectorAll('.floating-player .player-song-title, .floating-player .player-song-artist, .floating-player .player-lyrics-line, .floating-player .current-time, .floating-player .total-time, .floating-player .control-btn, .floating-player .volume-btn, .floating-player .secondary-btn, .floating-player .playback-rate-trigger, .floating-player .playback-rate-option');
            playerTextElements.forEach(element => {
                element.style.opacity = normalizedOpacity;
            });

            const toolbarTextElements = document.querySelectorAll('.player-top-bar .toggle-player-btn, .player-top-bar .playlist-btn, .player-top-bar .hide-player-btn');
            toolbarTextElements.forEach(el => el.style.opacity = normalizedOpacity);

            const navbarTextElements = document.querySelectorAll('.navbar-item i, .navbar-item span');
            navbarTextElements.forEach(el => el.style.opacity = normalizedOpacity);

            const lyricsSourceElements = document.querySelectorAll('.lyrics-source-trigger, .lyrics-source-trigger span');
            lyricsSourceElements.forEach(el => el.style.opacity = normalizedOpacity);

            localStorage.setItem('textOpacity', normalizedOpacity);
        }

        function updateToolbarOpacity(opacity) {
            const normalizedOpacity = opacity / 100;
            const toolbar = document.querySelector('.player-top-bar');
            if (toolbar) {
                toolbar.style.backgroundColor = `rgba(15, 23, 42, ${normalizedOpacity * 0.95})`;
                toolbar.style.backdropFilter = `blur(${20 * normalizedOpacity}px)`;
            }
            localStorage.setItem('toolbarOpacity', normalizedOpacity);
        }

        function updateNavbarOpacity(opacity) {
            const normalizedOpacity = opacity / 100;
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                navbar.style.backgroundColor = `rgba(15, 23, 42, ${normalizedOpacity * 0.95})`;
                navbar.style.backdropFilter = `blur(${20 * normalizedOpacity}px)`;
            }
            localStorage.setItem('navbarOpacity', normalizedOpacity);
        }

        function cleanFileName(str) {
            return String(str).replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
        }

        function getCurrentPlayingSong() {
            if (!currentSongId || !currentSearchResults || currentSearchResults.length === 0) {
                return null;
            }
            
            const song = currentSearchResults.find(s => s.id == currentSongId);
            return song || null;
        }

        function playPrevSong() {
            if (playlistSongs.length === 0) {
                showStatusMessage('播放列表为空', 'warning');
                return;
            }

            const currentIndex = playlistSongs.findIndex(song => String(song.id) === String(currentSongId));
            let prevIndex;

            if (currentIndex === -1) {
                prevIndex = playlistSongs.length - 1;
            } else {
                if (playModes[currentPlayModeIndex] === 'random') {
                    do {
                        prevIndex = Math.floor(Math.random() * playlistSongs.length);
                    } while (playlistSongs.length > 1 && prevIndex === currentIndex);
                } else {
                    prevIndex = currentIndex - 1;
                    if (prevIndex < 0) prevIndex = playlistSongs.length - 1;
                }
            }

            if (prevIndex >= 0 && prevIndex < playlistSongs.length) {
                const prevSong = playlistSongs[prevIndex];
                playSong(prevSong.id, true);
            }
        }

        function playNextSong() {
            if (playlistSongs.length === 0) {
                showStatusMessage('播放列表为空', 'warning');
                return;
            }

            const currentIndex = playlistSongs.findIndex(song => String(song.id) === String(currentSongId));
            let nextIndex;

            if (currentIndex === -1) {
                nextIndex = 0;
            } else {
                if (playModes[currentPlayModeIndex] === 'random') {
                    do {
                        nextIndex = Math.floor(Math.random() * playlistSongs.length);
                    } while (playlistSongs.length > 1 && nextIndex === currentIndex);
                } else {
                    nextIndex = currentIndex + 1;
                    if (nextIndex >= playlistSongs.length) nextIndex = 0;
                }
            }

            if (nextIndex >= 0 && nextIndex < playlistSongs.length) {
                const nextSong = playlistSongs[nextIndex];
                playSong(nextSong.id, true);
            }
        }

        function startSeeking(e) {
            e.preventDefault();
            isSeeking = true;
            
            const seek = (e) => {
                if (!isSeeking) return;
                
                const rect = progressContainer.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                progressBar.style.width = `${percent * 100}%`;
                progressHandle.style.left = `${percent * 100}%`;
                currentTimeElement.textContent = formatTime(percent * audioPlayer.duration);
                
                const bottomProgressBar = document.getElementById('bottomProgressBar');
                if (bottomProgressBar) {
                    bottomProgressBar.style.width = `${percent * 100}%`;
                }
            };
            
            const stopSeeking = (e) => {
                if (!isSeeking) return;
                
                isSeeking = false;
                
                const rect = progressContainer.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                audioPlayer.currentTime = percent * audioPlayer.duration;
                
                document.removeEventListener('mousemove', seek);
                document.removeEventListener('mouseup', stopSeeking);
            };
            
            seek(e);
            document.addEventListener('mousemove', seek);
            document.addEventListener('mouseup', stopSeeking);
        }

        function downloadSong() {
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            const songUrl = audioPlayer.src;
            
            if (!songUrl) {
                showStatusMessage('无法获取歌曲直链', 'error');
                return;
            }
            
            const currentSong = getCurrentPlayingSong();
            if (!currentSong) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }
            
            try {
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(currentSong.name || '未知歌曲');
                const artist = cleanFileName(currentSong.artist || '未知艺术家');
                
                const fileName = `${songName} - ${artist}.mp3`;
                
                const link = document.createElement('a');
                link.href = songUrl;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatusMessage(`开始下载: ${songName} - ${artist}`, 'success');
                
            } catch (error) {
                showStatusMessage('下载失败，请重试', 'error');
                
                window.open(songUrl, '_blank');
            }
        }

        let downloadController = null;
        let isDownloading = false;
        let currentPlayWhenReady = null;
        let currentClearTimeoutHandler = null;
        let currentTimeoutId = null;
        let isUpdatingPlayer = false;
        let isPlayingSong = false;
        let hasPlayedCurrentSong = false;

        function showDownloadPanel() {
            const panel = document.getElementById('downloadPanel');
            const overlay = document.getElementById('panelOverlay');
            if (panel) {
                overlay.classList.add('active');
                panel.classList.add('active');
                document.body.style.pointerEvents = 'none';
                panel.style.pointerEvents = 'auto';
                overlay.style.pointerEvents = 'auto';
                panel.focus();
            }
        }

        function hideDownloadPanel() {
            const panel = document.getElementById('downloadPanel');
            const overlay = document.getElementById('panelOverlay');
            if (panel) {
                overlay.classList.remove('active');
                panel.classList.remove('active');
                document.body.style.pointerEvents = 'auto';
            }
        }
    
        function startDownloadWithProgress(url, fileName, retryCount = 0) {
            downloadController = new AbortController();
            const signal = downloadController.signal;
            
            let startTime = Date.now();
            let downloadedBytes = 0;
            let totalBytes = 0;
            let lastUpdateTime = 0;
            let lastDownloadedBytes = 0;
            let updatedFileName = fileName;
            
            const chunks = [];
            
            function updateProgress(bytesRead, totalBytesLength) {
                downloadedBytes = bytesRead;
                totalBytes = totalBytesLength;
                
                const now = Date.now();
                const elapsedTime = now - startTime;
                const currentSpeed = ((downloadedBytes - lastDownloadedBytes) / (now - lastUpdateTime)) * 1000;
                
                if (!window.downloadSpeedHistory) {
                    window.downloadSpeedHistory = [];
                }
                window.downloadSpeedHistory.push(currentSpeed);
                if (window.downloadSpeedHistory.length > 5) {
                    window.downloadSpeedHistory.shift();
                }
                const avgSpeed = window.downloadSpeedHistory.reduce((a, b) => a + b, 0) / window.downloadSpeedHistory.length;
                
                if (now - lastUpdateTime > 1000) {
                    lastUpdateTime = now;
                    lastDownloadedBytes = downloadedBytes;
                }
                
                const percentage = totalBytes > 0 ? Math.round((downloadedBytes / totalBytes) * 100) : 0;
                
                const formatSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                };
                
                const formatSpeed = (bytesPerSecond) => {
                    if (bytesPerSecond < 1024) return bytesPerSecond.toFixed(2) + ' B/s';
                    if (bytesPerSecond < 1024 * 1024) return (bytesPerSecond / 1024).toFixed(2) + ' KB/s';
                    return (bytesPerSecond / (1024 * 1024)).toFixed(2) + ' MB/s';
                };
                
                document.getElementById('downloadPercentage').textContent = percentage + '%';
                document.getElementById('downloadSpeed').textContent = formatSpeed(avgSpeed);
                document.getElementById('downloadSize').textContent = `${formatSize(downloadedBytes)} / ${formatSize(totalBytes)}`;
                document.getElementById('downloadProgressBar').style.width = percentage + '%';
                document.getElementById('downloadStatus').textContent = '下载中...';
            }
            
            const headers = {
                'Range': 'bytes=0-'
            };
            
            return fetch(url, {
                signal,
                headers
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                totalBytes = parseInt(response.headers.get('content-length') || '0');
                
                let detectedFileType = 'audio/mpeg';
                let detectedExtension = 'mp3';
                
                const contentType = response.headers.get('content-type');
                if (contentType) {
                    detectedFileType = contentType;
                    
                    const mimeToExtension = {
                        'audio/mpeg': 'mp3',
                        'audio/mp4': 'm4a',
                        'audio/ogg': 'ogg',
                        'audio/wav': 'wav',
                        'audio/flac': 'flac',
                        'audio/aac': 'aac'
                    };
                    
                    if (mimeToExtension[contentType]) {
                        detectedExtension = mimeToExtension[contentType];
                    }
                }
                
                const baseFileName = fileName.substring(0, fileName.lastIndexOf('.'));
                updatedFileName = `${baseFileName}.${detectedExtension}`;
                
                const reader = response.body.getReader();
                
                function read() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            const blob = new Blob(chunks, { type: detectedFileType });
                            saveBlobAsFile(blob, updatedFileName);
                            return;
                        }
                        
                        chunks.push(value);
                        downloadedBytes += value.length;
                        updateProgress(downloadedBytes, totalBytes);
                        return read();
                    });
                }
                
                return read();
            }).then(() => {
                document.getElementById('downloadStatus').textContent = '下载完成';
                showStatusMessage(`下载完成: ${updatedFileName}`, 'success');
                
                setTimeout(hideDownloadPanel, 3000);
            }).catch(error => {
                if (error.name === 'AbortError') {
                } else {
                    document.getElementById('downloadStatus').textContent = '下载失败';
                    showStatusMessage('下载失败: ' + error.message, 'error');
                    if (retryCount < 3) {
                        setTimeout(() => {
                            showStatusMessage(`正在重试下载 (${retryCount + 1}/3)...`, 'info');
                            startDownloadWithProgress(url, fileName, retryCount + 1);
                        }, 2000);
                    } else {
                        setTimeout(hideDownloadPanel, 2000);
                    }
                }
            });
        }

        function saveBlobAsFile(blob, fileName) {
            try {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                showStatusMessage('保存文件失败，请重试', 'error');
            }
        }

        function cancelDownload() {
            if (downloadController) {
                downloadController.abort();
                downloadController = null;
            }
            isDownloading = false;
            hideDownloadPanel();
            showStatusMessage('下载已取消', 'info');
        }

        function initDownloadPanel() {
            const closeBtn = document.getElementById('closeDownloadPanel');
            const cancelBtn = document.getElementById('cancelDownloadBtn');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDownloadPanel);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelDownload);
            }
        }

        function initDownloadOptionsPanel() {
            const closeBtn = document.getElementById('closeDownloadOptionsPanel');
            const cancelBtn = document.getElementById('cancelDownloadOptionsBtn');
            const confirmBtn = document.getElementById('confirmDownloadBtn');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const songCheckbox = document.getElementById('downloadSongCheckbox');
            const lyricsCheckbox = document.getElementById('downloadLyricsCheckbox');
            const coverCheckbox = document.getElementById('downloadCoverCheckbox');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDownloadOptionsPanel);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideDownloadOptionsPanel);
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', startSelectedDownloads);
            }

            const packageDownloadBtnPanel = document.getElementById('packageDownloadBtnPanel');
            if (packageDownloadBtnPanel) {
                packageDownloadBtnPanel.addEventListener('click', function() {
                    const currentSong = getCurrentPlayingSong();
                    if (!currentSong) {
                        showStatusMessage('请先选择一首歌曲', 'warning');
                        hideDownloadOptionsPanel();
                        return;
                    }
                    hideDownloadOptionsPanel();
                    downloadAsPackage(currentSong, true, true, true);
                });
            }

            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const allSelected = songCheckbox.checked && lyricsCheckbox.checked && coverCheckbox.checked;
                    
                    if (allSelected) {
                        songCheckbox.checked = false;
                        lyricsCheckbox.checked = false;
                        coverCheckbox.checked = false;
                    } else {
                        songCheckbox.checked = true;
                        lyricsCheckbox.checked = true;
                        coverCheckbox.checked = true;
                    }
                    
                    updateSelectAllButtonText();
                });
            }
            
            const checkboxes = [songCheckbox, lyricsCheckbox, coverCheckbox];
            checkboxes.forEach(checkbox => {
                if (checkbox) {
                    checkbox.addEventListener('change', updateSelectAllButtonText);
                }
            });
        }

        function updateSelectAllButtonText() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const songCheckbox = document.getElementById('downloadSongCheckbox');
            const lyricsCheckbox = document.getElementById('downloadLyricsCheckbox');
            const coverCheckbox = document.getElementById('downloadCoverCheckbox');
            
            if (selectAllBtn && songCheckbox && lyricsCheckbox && coverCheckbox) {
                const allSelected = songCheckbox.checked && lyricsCheckbox.checked && coverCheckbox.checked;
                const icon = selectAllBtn.querySelector('i');
                
                if (allSelected) {
                    selectAllBtn.innerHTML = '<i class="fas fa-times"></i> 取消全选';
                } else {
                    selectAllBtn.innerHTML = '<i class="fas fa-check-double"></i> 全选';
                }
            }
        }

        function initAnnouncementPanel() {
            const announcementBtn = document.getElementById('announcementBtn');
            const closeBtn = document.getElementById('closeAnnouncementPanel');
            const announcementBadge = document.getElementById('announcementBadge');
            
            if (announcementBadge) {
                const announcementItems = document.querySelectorAll('.announcement-item');
                announcementBadge.textContent = announcementItems.length;
            }
            
            if (announcementBtn) {
                announcementBtn.addEventListener('click', showAnnouncementPanel);
                if (announcementBadge) {
                    announcementBtn.addEventListener('click', function() {
                        announcementBadge.style.display = 'none';
                    });
                }
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideAnnouncementPanel);
            }
            
            const hasVisited = localStorage.getItem('hasVisited');
            if (!hasVisited) {
                setTimeout(() => {
                    showAnnouncementPanel();
                    localStorage.setItem('hasVisited', 'true');
                }, 500);
            }
        }

        function showAnnouncementPanel() {
            const panel = document.getElementById('announcementPanel');
            const overlay = document.getElementById('panelOverlay');
            if (panel) {
                overlay.classList.add('active');
                panel.classList.add('active');
                document.body.style.pointerEvents = 'none';
                panel.style.pointerEvents = 'auto';
                overlay.style.pointerEvents = 'auto';
                panel.focus();
            }
        }

        function hideAnnouncementPanel() {
            const panel = document.getElementById('announcementPanel');
            const overlay = document.getElementById('panelOverlay');
            if (panel) {
                overlay.classList.remove('active');
                panel.classList.remove('active');
                document.body.style.pointerEvents = 'auto';
            }
        }

        function isModernBrowser() {
            return (
                'fetch' in window &&
                'AbortController' in window &&
                'ReadableStream' in window &&
                'Blob' in window &&
                'createObjectURL' in window.URL
            );
        }

        function downloadSong() {
            if (!audioPlayer.src) {
                showStatusMessage('请先选择要播放的歌曲', 'warning');
                return;
            }
            
            const currentSong = getCurrentPlayingSong();
            if (!currentSong) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }
            
            showDownloadOptionsPanel(currentSong);
        }

        function showDownloadOptionsPanel(song) {
            const panel = document.getElementById('downloadOptionsPanel');
            const overlay = document.getElementById('panelOverlay');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (panel) {
                document.getElementById('downloadOptionsSongName').textContent = song.name || '未知歌曲';
                document.getElementById('downloadOptionsSongArtist').textContent = song.artist || '未知艺术家';
                
                document.getElementById('downloadSongCheckbox').checked = true;
                document.getElementById('downloadLyricsCheckbox').checked = true;
                document.getElementById('downloadCoverCheckbox').checked = true;
                
                updateSelectAllButtonText();
                
                overlay.classList.add('active');
                panel.classList.add('active');
                document.body.style.pointerEvents = 'none';
                panel.style.pointerEvents = 'auto';
                overlay.style.pointerEvents = 'auto';
                panel.focus();
            }
        }

        function hideDownloadOptionsPanel() {
            const panel = document.getElementById('downloadOptionsPanel');
            const overlay = document.getElementById('panelOverlay');
            
            if (panel) {
                overlay.classList.remove('active');
                panel.classList.remove('active');
                document.body.style.pointerEvents = 'auto';
            }
        }

        function showPlaybackRateModal() {
            const modal = document.getElementById('playbackRateModal');
            const slider = document.getElementById('playbackRateSlider');
            const sliderValue = document.getElementById('playbackRateSliderValue');
            
            if (modal && slider && sliderValue) {
                slider.value = currentPlaybackRate;
                sliderValue.textContent = `${currentPlaybackRate.toFixed(2)}x`;
                
                updateQuickRateButtons();
                
                modal.classList.add('active');
            }
        }

        function hidePlaybackRateModal() {
            const modal = document.getElementById('playbackRateModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function initPlaybackRateDisplay() {
            const rateText = document.getElementById('playbackRateText');
            if (rateText) {
                rateText.textContent = `${currentPlaybackRate.toFixed(2)}x`;
                playbackRateBtn.title = `播放速度: ${currentPlaybackRate.toFixed(2)}x`;
            }
        }

        function updateQuickRateButtons() {
            const quickRateButtons = document.querySelectorAll('.quick-rate-btn');
            quickRateButtons.forEach(btn => {
                const rate = parseFloat(btn.dataset.rate);
                btn.classList.toggle('active', Math.abs(rate - currentPlaybackRate) < 0.01);
            });
        }
        
        async function startSelectedDownloads() {
            const downloadSong = document.getElementById('downloadSongCheckbox').checked;
            const downloadLyrics = document.getElementById('downloadLyricsCheckbox').checked;
            const downloadCover = document.getElementById('downloadCoverCheckbox').checked;

            if (!downloadSong && !downloadLyrics && !downloadCover) {
                showStatusMessage('请至少选择一项下载内容', 'warning');
                return;
            }

            const currentSong = getCurrentPlayingSong();
            if (!currentSong) {
                showStatusMessage('无法获取歌曲信息', 'error');
                return;
            }

            hideDownloadOptionsPanel();

            const tasks = [];
            if (downloadSong) tasks.push(() => downloadAudioFile(currentSong));
            if (downloadLyrics) tasks.push(() => downloadLyricsFile(currentSong));
            if (downloadCover) tasks.push(() => downloadCoverFile(currentSong));

            for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];
                try {
                    await Promise.race([
                        task(),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('下载超时，已跳过')), 180000)
                        )
                    ]);
                } catch (error) {
                    showStatusMessage(`部分文件下载失败: ${error.message}`, 'error');
                }
            }
        }

        function downloadAsPackage(currentSong, downloadSong, downloadLyrics, downloadCover) {
            if (isDownloading) {
                showStatusMessage('下载任务正在进行中，请稍候', 'warning');
                return;
            }
            isDownloading = true;

            showStatusMessage('正在准备打包文件...', 'info');

            const zip = new JSZip();
            const songName = cleanFileName(currentSong.name || '未知歌曲');
            const artist = cleanFileName(currentSong.artist || '未知艺术家');
            const baseName = `${songName} - ${artist}`;

            const promises = [];
            let songDownloadSuccess = false;

            if (downloadSong) {
                const songUrl = audioPlayer.src;
                if (songUrl) {
                    const extMatch = songUrl.match(/\.([a-zA-Z0-9]+)(\?|$)/);
                    const ext = extMatch ? extMatch[1] : 'mp3';
                    const fileName = `${baseName}.${ext}`;
                    const promise = fetch(songUrl)
                        .then(response => {
                            if (!response.ok) throw new Error('歌曲下载失败');
                            return response.blob();
                        })
                        .then(blob => {
                            zip.file(fileName, blob);
                            songDownloadSuccess = true;
                        })
                        .catch(error => {
                            showStatusMessage(`歌曲 ${fileName} 下载失败，已跳过`, 'error');
                        });
                    promises.push(promise);
                } else {
                    showStatusMessage('无法获取歌曲下载链接', 'warning');
                }
            }

            if (downloadLyrics && lyricsData.length > 0) {
                const fileName = `${baseName}.lrc`;
                const lrcContent = lyricsData.map(line => {
                    if (line.time >= 0) {
                        const minutes = Math.floor(line.time / 60);
                        const seconds = Math.floor(line.time % 60);
                        const milliseconds = Math.floor((line.time % 1) * 100);
                        const timeStr = `[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}]`;
                        return `${timeStr}${line.text}`;
                    } else {
                        return line.text;
                    }
                }).join('\n');
                zip.file(fileName, lrcContent, { binary: false });
            } else if (downloadLyrics) {
                showStatusMessage('没有可用的歌词文件', 'warning');
            }

            if (downloadCover) {
                const coverUrl = currentSong.cover || playerAlbumArt.src;
                if (coverUrl && coverUrl !== '') {
                    const extMatch = coverUrl.match(/\.([a-zA-Z0-9]+)(\?|$)/);
                    const ext = extMatch ? extMatch[1] : 'jpg';
                    const fileName = `${baseName}.${ext}`;
                    const promise = fetch(coverUrl)
                        .then(response => {
                            if (!response.ok) throw new Error('封面下载失败');
                            return response.blob();
                        })
                        .then(blob => {
                            zip.file(fileName, blob);
                        })
                        .catch(error => {
                            showStatusMessage(`封面 ${fileName} 下载失败，已跳过`, 'error');
                        });
                    promises.push(promise);
                } else {
                    showStatusMessage('没有可用的封面文件', 'warning');
                }
            }

            Promise.allSettled(promises).then(() => {
                zip.generateAsync({ type: 'blob' })
                    .then(blob => {
                        const zipFileName = `${baseName}.zip`;
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = zipFileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        showStatusMessage(`打包完成: ${zipFileName}`, 'success');

                        if (songDownloadSuccess) {
                            incrementDownloadCount();
                        }
                    })
                    .catch(error => {
                        showStatusMessage('打包失败，请重试', 'error');
                    })
                    .finally(() => {
                        isDownloading = false;
                    });
            });
        }

        function incrementDownloadCount() {
            let count = parseInt(localStorage.getItem('downloadCount') || 0);
            count++;
            localStorage.setItem('downloadCount', count);
            if (currentPage === 'profile') {
                updateProfilePage();
            }
        }

        function downloadAudioFile(song) {
            return new Promise((resolve, reject) => {
                if (isDownloading) {
                    showStatusMessage('下载已在进行中，请稍候', 'warning');
                    reject(new Error('下载已在进行中'));
                    return;
                }
                isDownloading = true;

                const songUrl = audioPlayer.src;
                
                if (!songUrl) {
                    showStatusMessage('无法获取歌曲直链', 'error');
                    isDownloading = false;
                    reject(new Error('无法获取歌曲直链'));
                    return;
                }
                
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(song.name || '未知歌曲');
                const artist = cleanFileName(song.artist || '未知艺术家');
                const fileName = `${songName} - ${artist}.mp3`;
                
                if (downloadController) {
                    downloadController.abort();
                    downloadController = null;
                }
                
                if (isModernBrowser()) {
                    showDownloadPanel();
                    
                    document.getElementById('downloadFileName').textContent = fileName;
                    document.getElementById('downloadStatus').textContent = '准备下载...';
                    document.getElementById('downloadPercentage').textContent = '0%';
                    document.getElementById('downloadSpeed').textContent = '0 KB/s';
                    document.getElementById('downloadSize').textContent = '0 MB / 0 MB';
                    document.getElementById('downloadProgressBar').style.width = '0%';
                    
                    const downloadPromise = startDownloadWithProgress(songUrl, fileName);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('下载超时')), 180000)
                    );

                    Promise.race([downloadPromise, timeoutPromise])
                        .then(() => {
                            incrementDownloadCount();
                            resolve();
                        })
                        .catch(error => {
                            if (error.message !== '下载超时') {
                                showStatusMessage('下载失败: ' + error.message, 'error');
                            } else {
                                showStatusMessage('下载超时，请检查网络', 'error');
                            }
                            reject(error);
                        })
                        .finally(() => {
                            isDownloading = false;
                        });
                } else {
                    const link = document.createElement('a');
                    link.href = songUrl;
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    incrementDownloadCount();
                    showStatusMessage(`开始下载: ${fileName}`, 'success');
                    isDownloading = false;
                    resolve();
                }
            });
        }

        function downloadLyricsFile(song) {
            return new Promise((resolve, reject) => {
                if (isDownloading) {
                    showStatusMessage('下载已在进行中，请稍候', 'warning');
                    reject(new Error('下载已在进行中'));
                    return;
                }
                isDownloading = true;

                const lyrics = lyricsData;
                
                if (!lyrics || lyrics.length === 0) {
                    showStatusMessage('没有可用的歌词', 'warning');
                    isDownloading = false;
                    reject(new Error('没有可用的歌词'));
                    return;
                }
                
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(song.name || '未知歌曲');
                const artist = cleanFileName(song.artist || '未知艺术家');
                
                const excludedSources = ['wy', 'qq', 'kw', 'qi'];
                let sourceName = '原始歌词';
                
                if (!excludedSources.includes(currentLyricsSource) && lyricsSourceNames[currentLyricsSource]) {
                    sourceName = lyricsSourceNames[currentLyricsSource];
                }
                
                const fileName = `${sourceName}-${songName} - ${artist}.lrc`;
                
                const lrcContent = lyrics.map(line => {
                    if (line.time >= 0) {
                        const minutes = Math.floor(line.time / 60);
                        const seconds = Math.floor(line.time % 60);
                        const milliseconds = Math.floor((line.time % 1) * 100);
                        const timeStr = `[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}]`;
                        return `${timeStr}${line.text}`;
                    } else {
                        return line.text;
                    }
                }).join('\n');
                
                const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                showStatusMessage(`歌词下载完成: ${fileName}`, 'success');
                isDownloading = false;
                resolve();
            });
        }

        function downloadCoverFile(song) {
            return new Promise((resolve, reject) => {
                if (isDownloading) {
                    showStatusMessage('下载已在进行中，请稍候', 'warning');
                    reject(new Error('下载已在进行中'));
                    return;
                }
                isDownloading = true;

                const coverUrl = song.cover || document.getElementById('playerAlbumArt').src;
                
                if (!coverUrl || coverUrl === '') {
                    showStatusMessage('没有可用的封面', 'warning');
                    isDownloading = false;
                    reject(new Error('没有可用的封面'));
                    return;
                }
                
                const cleanFileName = (str) => {
                    return str.replace(/[<>:"/\\|?*]/g, '').replace(/\s+/g, ' ').trim();
                };
                
                const songName = cleanFileName(song.name || '未知歌曲');
                const artist = cleanFileName(song.artist || '未知艺术家');
                const fileName = `${songName} - ${artist}.jpg`;
                
                fetch(coverUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('封面下载失败');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        setTimeout(() => {
                            window.URL.revokeObjectURL(url);
                        }, 100);
                        
                        showStatusMessage(`封面下载完成: ${fileName}`, 'success');
                        resolve();
                    })
                    .catch(error => {
                        showStatusMessage('下载封面失败', 'error');
                        reject(error);
                    })
                    .finally(() => {
                        isDownloading = false;
                    });
            });
        }

        function togglePlayerExpanded() {
            isPlayerExpanded = !isPlayerExpanded;
            
            const bottomProgressContainer = document.getElementById('bottomProgressContainer');
            
            if (isPlayerExpanded) {
                playerExpanded.classList.add('active');
                floatingPlayer.classList.remove('player-collapsed');
                togglePlayerBtn.classList.add('active');
                togglePlayerBtn.title = "收起播放器";
                
                if (bottomProgressContainer) {
                    bottomProgressContainer.style.display = 'none';
                }
            } else {
                playerExpanded.classList.remove('active');
                floatingPlayer.classList.add('player-collapsed');
                togglePlayerBtn.classList.remove('active');
                togglePlayerBtn.title = "展开播放器";
                
                if (bottomProgressContainer) {
                    bottomProgressContainer.style.display = 'block';
                }
            }
            
            updateToolbarPosition();
        }

        function toggleLyricsPanel() {
            isLyricsVisible = !isLyricsVisible;
            
            if (isLyricsVisible) {
                lyricsPanel.classList.add('active');
                showLyricsBtn.classList.add('active');
                lyricsBtn.classList.add('active');
                lyricsBtn.title = "隐藏歌词";
                
                setTimeout(adjustLyricsCardSize, 100);
                
                if (isPlaying) {
                    startLyricsHighlight();
                }
            } else {
                lyricsPanel.classList.remove('active');
                showLyricsBtn.classList.remove('active');
                lyricsBtn.classList.remove('active');
                lyricsBtn.title = "显示歌词";
                
                stopLyricsHighlight();
            }
        }

        function openLyricsPanel() {
            isLyricsVisible = true;
            lyricsPanel.classList.add('active');
            showLyricsBtn.classList.add('active');
            lyricsBtn.classList.add('active');
            lyricsBtn.title = "隐藏歌词";
            
            setTimeout(adjustLyricsCardSize, 100);
            
            if (isPlaying) {
                startLyricsHighlight();
            }
            
            const savedSource = localStorage.getItem('preferredLyricsSource');
            if (savedSource && availableLyricsSources.includes(savedSource) && savedSource !== currentLyricsSource) {
                switchLyricsSource(savedSource);
            }
        }

        function closeLyricsPanel() {
            isLyricsVisible = false;
            lyricsPanel.classList.remove('active');
            
            stopLyricsHighlight();
        }

        let statusTimeout = null;

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity) return "00:00";
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            if (!ms) return "00:00";
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function deduplicatePlaylist(songs) {
            const seen = new Set();
            const result = [];
            for (const song of songs) {
                if (!seen.has(String(song.id))) {
                    seen.add(String(song.id));
                    result.push(song);
                }
            }
            return result;
        }

        function showLoading(show, message = '正在搜索音乐，请稍候...') {
            if (show) {
                loadingElement.classList.add('active');
                loadingElement.querySelector('.loading-text').textContent = message;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
            } else {
                loadingElement.classList.remove('active');
            }
        }

        function showPreloadInfo(show) {
            if (show) {
                preloadInfo.classList.add('active');
            } else {
                preloadInfo.classList.remove('active');
            }
        }

        function showStatusMessage(message, type = 'info') {
            if (statusTimeout) {
                clearTimeout(statusTimeout);
                statusTimeout = null;
            }

            statusText.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.classList.add('active');
            
            const iconElement = statusMessage.querySelector('i');
            if (iconElement) {
                iconElement.className = '';
                switch(type) {
                    case 'success':
                        iconElement.className = 'fas fa-check-circle';
                        break;
                    case 'error':
                        iconElement.className = 'fas fa-exclamation-circle';
                        break;
                    case 'warning':
                        iconElement.className = 'fas fa-exclamation-triangle';
                        break;
                    default:
                        iconElement.className = 'fas fa-info-circle';
                }
            }

            statusTimeout = setTimeout(() => {
                statusMessage.classList.remove('active');
                statusTimeout = null;
            }, 3000);
        }
        
        function clearError() {
            errorMessageElement.classList.remove('active');
        }
        
        function clearResults() {
            songListElement.innerHTML = '';
            currentSearchResults = [];
            emptyStateElement.style.display = 'flex';
            emptyStateElement.innerHTML = `
                <div>
                    <i class="fas fa-music"></i>
                    <h3>搜索结果显示在这里</h3>
                    <p>输入关键词并点击搜索按钮开始搜索</p>
                </div>
            `;
        }
        
        function updatePaginationButtons(data) {
            currentPageElement.textContent = searchPageNumber;
            prevPageBtn.disabled = searchPageNumber <= 1;

            const limit = searchPageSize; 
            if (data && data.data && data.data.length === limit) {
                hasNextPage = true;
                nextPageBtn.disabled = false;
            } else {
                hasNextPage = false;
                nextPageBtn.disabled = true;
            }
        }

        function goToPrevPage() {
            if (searchPageNumber > 1) {
                searchPageNumber--;
                performSearch();
            }
        }

        function goToNextPage() {
            searchPageNumber++;
            performSearch();
        }
        
        function updateLoadedCount() {
            loadedSongCountElement.textContent = loadedSongsCount;
            preloadStatus.textContent = `${loadedSongsCount}/${totalSongsCount} 已加载`;
        }
        
        function updatePreloadProgress(loaded, total) {
            const percentage = total > 0 ? Math.round((loaded / total) * 100) : 0;
            preloadProgressBar.style.width = `${percentage}%`;
        }

        function initNavbar() {
            const navbar = document.getElementById('navbar');
            const navbarItems = document.querySelectorAll('.navbar-item');
            const floatingPlayer = document.getElementById('floatingPlayer');
            let lastScrollTop = 0;

            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 100) {
                    navbar.classList.add('scrolled');
                    if (floatingPlayer) {
                        floatingPlayer.style.bottom = '0';
                    }
                } else {
                    navbar.classList.remove('scrolled');
                    if (floatingPlayer) {
                        floatingPlayer.style.bottom = '60px';
                    }
                }
                
                updateToolbarPosition();
                
                lastScrollTop = scrollTop;
            });

            navbarItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    navbarItems.forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                });
            });

            if (floatingPlayer) {
                floatingPlayer.style.bottom = '60px';
            }
        }

        window.addEventListener('beforeunload', function() {
            if (isPlaybackActive && lastUpdateTime !== null) {
                const now = Date.now();
                const delta = now - lastUpdateTime;
                if (delta > 0) {
                    const totalPlayTime = parseInt(localStorage.getItem('totalPlayTime') || 0) + delta;
                    localStorage.setItem('totalPlayTime', totalPlayTime);
                }
            }
        });

        let currentPage = 'home';

        function updateThemeButtons() {
            const currentTheme = localStorage.getItem('theme') || 'default';
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === currentTheme) {
                    btn.classList.add('active');
                }
            });
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-container').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;

                document.querySelectorAll('.navbar-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    }
                });

                if (pageId === 'profile') {
                    updateProfilePage();
                } else if (pageId === 'settings') {
                    updateThemeButtons();
                }

                const floatingPlayer = document.getElementById('floatingPlayer');
                if (floatingPlayer) {
                    const userHidden = localStorage.getItem('playerHidden') === 'true';
                    
                    if (pageId === 'profile' || pageId === 'settings') {
                        floatingPlayer.style.display = 'none';
                        if (pageId === 'settings' && tempShowPlayerForSettings) {
                            tempShowPlayerForSettings = false;
                        }
                        if (opacitySliderTimer) {
                            clearTimeout(opacitySliderTimer);
                            opacitySliderTimer = null;
                        }
                    } else {
                        floatingPlayer.style.display = userHidden ? 'none' : 'flex';
                        tempShowPlayerForSettings = false;
                        if (opacitySliderTimer) {
                            clearTimeout(opacitySliderTimer);
                            opacitySliderTimer = null;
                        }
                    }
                    updatePlayerVisibilityButtonState();
                    updateToolbarPosition();
                }
            }
        }

        function updateProfilePage() {
            const lastLogin = localStorage.getItem('lastLoginTime') || new Date().toLocaleString();
            document.getElementById('lastLoginTime').textContent = lastLogin;

            const totalPlayCount = localStorage.getItem('totalPlayCount') || 0;
            const totalPlayTimeMs = parseInt(localStorage.getItem('totalPlayTime') || 0);
            const favoriteCount = localStorage.getItem('favoriteCount') || 0;
            const downloadCount = localStorage.getItem('downloadCount') || 0;

            document.getElementById('totalPlayCount').textContent = totalPlayCount;

            const totalMinutes = Math.floor(totalPlayTimeMs / 60000);
            const totalSeconds = Math.floor((totalPlayTimeMs % 60000) / 1000);
            document.getElementById('totalPlayTime').textContent = `${totalMinutes}分${totalSeconds}秒`;

            document.getElementById('favoriteCount').textContent = favoriteCount;
            document.getElementById('downloadCount').textContent = downloadCount;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initNavbar();

            loadSearchHistory();

            const historyToggle = document.getElementById('historyToggle');
            const savedHistoryEnabled = localStorage.getItem('historyEnabled');
            if (savedHistoryEnabled !== null) {
                historyEnabled = savedHistoryEnabled === 'true';
                historyToggle.checked = historyEnabled;
            } else {
                historyToggle.checked = true;
                historyEnabled = true;
            }
            historyToggle.addEventListener('change', function() {
                historyEnabled = this.checked;
                localStorage.setItem('historyEnabled', historyEnabled);
                if (!historyEnabled) {
                    document.getElementById('historySection').style.display = 'none';
                } else {
                    if (searchHistory.length > 0) {
                        document.getElementById('historySection').style.display = 'block';
                    }
                }
            });

            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', function() {
                    clearSearchHistory();
                    showStatusMessage('历史记录已清空', 'info');
                });
            }

            const pageSizeInput = document.getElementById('pageSizeInput');
            const savedPageSize = localStorage.getItem('searchPageSize');
            if (savedPageSize) {
                searchPageSize = parseInt(savedPageSize, 10);
                if (isNaN(searchPageSize) || searchPageSize < 1) searchPageSize = 20;
                if (searchPageSize > 20) searchPageSize = 20;
                pageSizeInput.value = searchPageSize;
            } else {
                pageSizeInput.value = searchPageSize;
            }
            pageSizeInput.addEventListener('input', function() {
                let val = parseInt(this.value, 10);
                if (isNaN(val) || val < 1) val = 1;
                if (val > 20) val = 20;
                this.value = val;
                searchPageSize = val;
                localStorage.setItem('searchPageSize', val);
            });

            playlistSongs = deduplicatePlaylist(playlistSongs);
            updatePlaylistUI();

            document.querySelectorAll('.navbar-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    switchPage(page);
                });
            });

            const playlistPanel = document.getElementById('playlistPanel');
            const playlistBtn = document.getElementById('playlistBtn');
            const closePlaylistPanel = document.getElementById('closePlaylistPanel');
            const playlistContent = document.getElementById('playlistContent');

            function togglePlaylistPanel() {
                if (playlistPanel.classList.contains('active')) {
                    playlistPanel.classList.remove('active');
                    playlistBtn.classList.remove('active');
                } else {
                    updatePlaylistUI();
                    playlistPanel.classList.add('active');
                    playlistBtn.classList.add('active');
                    playlistPanel.style.left = '50%';
                    playlistPanel.style.top = '50%';
                    playlistPanel.style.transform = 'translate(-50%, -50%) scale(1)';
                }
            }

            playlistBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                togglePlaylistPanel();
            });

            closePlaylistPanel.addEventListener('click', function() {
                playlistPanel.classList.remove('active');
                playlistBtn.classList.remove('active');
            });

            const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
            if (clearPlaylistBtn) {
                clearPlaylistBtn.addEventListener('click', function() {
                    if (playlistSongs.length === 0) {
                        showStatusMessage('播放列表已为空', 'info');
                        return;
                    }
                    if (confirm('确定要清空播放列表吗？')) {
                        playlistSongs = [];
                        updatePlaylistUI();
                        showStatusMessage('播放列表已清空', 'success');
                    }
                });
            }
        });

        (function() {
            const canvas = document.getElementById('fireworksCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let width, height;
            let fireworks = [];
            let animationId = null;
            let intervalId = null;
            let config = {};
            let isPageVisible = true;

            const colors = [
                '255,99,71', '135,206,250', '50,205,50', '255,215,0',
                '218,112,214', '255,140,0', '75,0,130', '255,20,147',
                '255,255,0', '0,255,255', '255,105,180', '173,255,47',
                '138,43,226', '255,69,0', '0,191,255', '255,182,193'
            ];

            function getDeviceConfig() {
                const w = window.innerWidth;
                if (w < 768) {
                    return {
                        particlesPerFirework: 40,
                        interval: 500,
                        speedFactor: 0.8,
                        riseSpeedBase: 4
                    };
                } else if (w < 1024) {
                    return {
                        particlesPerFirework: 60,
                        interval: 400,
                        speedFactor: 0.9,
                        riseSpeedBase: 5
                    };
                } else {
                    return {
                        particlesPerFirework: 80,
                        interval: 300,
                        speedFactor: 1.0,
                        riseSpeedBase: 6
                    };
                }
            }

            function resizeCanvas() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
            }
            window.addEventListener('resize', resizeCanvas);

            function Particle(x, y, color, cfg) {
                const angle = Math.random() * Math.PI * 2;
                const speed = (Math.random() * 3 + 2) * cfg.speedFactor;
                this.x = x;
                this.y = y;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 150;
                this.color = color;
                
                const shapeRand = Math.random();
                if (shapeRand < 0.3) this.shape = 'circle';
                else if (shapeRand < 0.5) this.shape = 'star';
                else if (shapeRand < 0.7) this.shape = 'heart';
                else if (shapeRand < 0.9) this.shape = 'square';
                else this.shape = 'line';
                
                this.size = Math.random() * 2 + 1.5;
            }

            function initFirework() {
                if (!config) config = getDeviceConfig();
                const x = Math.random() * width;
                const y = height;
                const v = Math.random() * 5 + config.riseSpeedBase;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const targetHeight = Math.random() * height / 2 + height / 4;
                const firework = { x, y, v, color, height: targetHeight, particles: [] };
                fireworks.push(firework);
            }

            function updateFireworks() {
                for (let i = fireworks.length - 1; i >= 0; i--) {
                    const firework = fireworks[i];
                    if (firework.y > firework.height) {
                        firework.y -= firework.v;
                        ctx.beginPath();
                        ctx.arc(firework.x, firework.y, 3, 0, 2 * Math.PI);
                        ctx.fillStyle = `rgb(${firework.color})`;
                        ctx.fill();
                    } else {
                        if (firework.particles.length === 0) {
                            const particleCount = config.particlesPerFirework;
                            for (let j = 0; j < particleCount; j++) {
                                firework.particles.push(new Particle(firework.x, firework.y, firework.color, config));
                            }
                        }
                        for (let j = firework.particles.length - 1; j >= 0; j--) {
                            const particle = firework.particles[j];
                            particle.x += particle.vx;
                            particle.y += particle.vy;
                            particle.vy += 0.02;
                            particle.life--;
                            const alpha = particle.life / 150;
                            ctx.save();
                            ctx.translate(particle.x, particle.y);
                            ctx.rotate(Math.random() * Math.PI);

                            if (particle.shape === 'circle') {
                                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 2);
                                gradient.addColorStop(0, `rgba(255,255,255,${alpha})`);
                                gradient.addColorStop(1, `rgba(${particle.color},${alpha})`);
                                ctx.fillStyle = gradient;
                                ctx.beginPath();
                                ctx.arc(0, 0, 2, 0, 2 * Math.PI);
                                ctx.fill();
                            } 
                            else if (particle.shape === 'star') {
                                const outerR = particle.size * 2;
                                const innerR = particle.size;
                                const spikes = 5;
                                let rot = Math.PI / 2 * 3;
                                const step = Math.PI / spikes;
                                ctx.beginPath();
                                for (let i = 0; i < spikes; i++) {
                                    let x = Math.cos(rot) * outerR;
                                    let y = Math.sin(rot) * outerR;
                                    ctx.lineTo(x, y);
                                    rot += step;
                                    
                                    x = Math.cos(rot) * innerR;
                                    y = Math.sin(rot) * innerR;
                                    ctx.lineTo(x, y);
                                    rot += step;
                                }
                                ctx.closePath();
                                ctx.fillStyle = `rgba(${particle.color},${alpha})`;
                                ctx.fill();
                            }
                            else if (particle.shape === 'heart') {
                                const s = particle.size;
                                ctx.beginPath();
                                ctx.moveTo(0, s * 1.5);
                                ctx.bezierCurveTo(-s * 2, -s * 0.5, -s, -s * 1.5, 0, -s * 0.5);
                                ctx.bezierCurveTo(s, -s * 1.5, s * 2, -s * 0.5, 0, s * 1.5);
                                ctx.closePath();
                                ctx.fillStyle = `rgba(${particle.color},${alpha})`;
                                ctx.fill();
                            }
                            else if (particle.shape === 'square') {
                                ctx.fillStyle = `rgba(${particle.color},${alpha})`;
                                ctx.fillRect(-particle.size, -particle.size, particle.size * 2, particle.size * 2);
                            }
                            else {
                                const endX = -particle.vx * 2;
                                const endY = -particle.vy * 2;
                                const gradient = ctx.createLinearGradient(0, 0, endX, endY);
                                gradient.addColorStop(0, `rgba(${particle.color},${alpha})`);
                                gradient.addColorStop(1, `rgba(${particle.color},0)`);
                                ctx.strokeStyle = gradient;
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                ctx.moveTo(0, 0);
                                ctx.lineTo(endX, endY);
                                ctx.stroke();
                            }
                            ctx.restore();

                            if (particle.life <= 0) {
                                firework.particles.splice(j, 1);
                            }
                        }
                        if (firework.particles.length === 0) {
                            fireworks.splice(i, 1);
                        }
                    }
                }
            }

            function animate() {
                if (!canvas.style.display || canvas.style.display === 'none' || !isPageVisible) {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                    return;
                }
                ctx.clearRect(0, 0, width, height);
                updateFireworks();
                animationId = requestAnimationFrame(animate);
            }

            function start() {
                if (intervalId) return;
                config = getDeviceConfig();
                canvas.style.display = 'block';
                resizeCanvas();
                if (isPageVisible) {
                    intervalId = setInterval(initFirework, config.interval);
                    animate();
                }
            }

            function stop() {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                fireworks = [];
                canvas.style.display = 'none';
                ctx.clearRect(0, 0, width, height);
            }

            window.fireworksControl = { start, stop };

            function handleVisibilityChange() {
                isPageVisible = !document.hidden;
                if (document.hidden) {
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                    }
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                } else {
                    if (canvas.style.display !== 'none') {
                        config = getDeviceConfig();
                        if (!intervalId) {
                            intervalId = setInterval(initFirework, config.interval);
                        }
                        if (!animationId) {
                            animate();
                        }
                    }
                }
            }
            document.addEventListener('visibilitychange', handleVisibilityChange);

            canvas.style.display = 'none';
        })();
    </script>

    <!-- 倍速切换中央弹窗 -->
    <div class="modal-overlay" id="playbackRateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-retweet"></i> 播放速度
                </h3>
                <button class="modal-close" id="closePlaybackRateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="playback-rate-slider-container">
                    <div class="playback-rate-slider-label">
                        <span>播放速度</span>
                        <span class="playback-rate-slider-value" id="playbackRateSliderValue">1.0x</span>
                    </div>
                    <input type="range" min="0.1" max="5.0" step="0.1" value="1.0" class="playback-rate-slider" id="playbackRateSlider">
                    <div class="playback-rate-quick-buttons">
                        <button class="quick-rate-btn" data-rate="0.5">0.5x</button>
                        <button class="quick-rate-btn" data-rate="1.0">1.0x</button>
                        <button class="quick-rate-btn" data-rate="1.5">1.5x</button>
                        <button class="quick-rate-btn" data-rate="2.0">2.0x</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="recommendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-fire"></i> 每日推荐
                </h3>
                <button class="modal-close" id="closeRecommendModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <ul class="recommend-song-list" id="recommendSongList"></ul>
            </div>
        </div>
    </div>

    <!-- 页面切换导航栏 -->
    <nav class="navbar" id="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-item active" data-page="home">
                <i class="fas fa-home"></i>
            </a>
            <a href="#" class="navbar-item" data-page="search">
                <i class="fas fa-search"></i>
            </a>
            <a href="#" class="navbar-item" data-page="settings">
                <i class="fas fa-cog"></i>
            </a>
            <a href="#" class="navbar-item" data-page="profile">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </nav>

    <!-- 播放列表面板 -->
    <div class="playlist-panel" id="playlistPanel">
        <div class="playlist-panel-header">
            <div class="playlist-panel-title">
                <i class="fas fa-list"></i> 播放列表
            </div>
            <div class="playlist-panel-actions">
                <button class="clear-playlist-btn" id="clearPlaylistBtn" title="清空列表">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="close-playlist-panel" id="closePlaylistPanel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="playlist-content" id="playlistContent">
            <div class="playlist-empty">
                <i class="fas fa-music"></i>
                <p>暂无歌曲，请先搜索</p>
            </div>
        </div>
    </div>
</body>
</html>
